# 禽星盘式 - 项目综述

> **AI协作须知**：修改代码后请先编译验证，确保 `BUILD SUCCESSFUL` 后再进行下一步。

---

## 🔧 快速编译指南

### 编译命令（必须按此执行）

```powershell
cd d:\DevEcoStudioProjects\CelestialBeastsAuspiciousTiming; hvigorw assembleHap --no-daemon
```

**注意事项**：
1. PowerShell 中使用 `;` 分隔命令，**禁止使用 `&&`**
2. 必须先 `cd` 到项目根目录再执行 `hvigorw`
3. 编译成功标志：`BUILD SUCCESSFUL`
4. 如遇 WARN 警告可忽略，ERROR 才需处理

### 常见编译错误

| 错误类型 | 原因 | 解决方案 |
|---------|------|----------|
| `Invalid resource name` | 文件名含 `-` 或特殊字符 | 文件名只能用 `[a-zA-Z0-9_]` |
| `Object literals cannot be used as type` | 对象字面量作为类型 | 必须定义 `interface` |
| `arkts-no-untyped-obj-literals` | Builder内声明变量 | 移到类成员或用方法返回 |

---

## 一、项目定位

**禽星盘式**是一款基于HarmonyOS（鸿蒙）的演禽术文化研习App，用于展示传统二十八宿演禽术的排盘体系。

**重要边界**：
- ✅ 文化研究工具，非命理占卜
- ✅ 方位推演，非"走失/占断"等敏感功能
- ⚠️ 敏感词规避：避免使用"命理"、"占卜"、"占断"、"走失"等词汇

---

## 二、技术栈

| 类型 | 技术 |
|------|------|
| 平台 | HarmonyOS (ArkTS) |
| 构建工具 | Hvigor |
| 编程语言 | ArkTS (TypeScript变体) |
| UI框架 | ArkUI |
| 数据存储 | rawfile JSON配置文件 |

**编译命令**：
```bash
cd d:\DevEcoStudioProjects\CelestialBeastsAuspiciousTiming
hvigorw assembleHap --no-daemon
```

---

## 三、核心页面与组件化

### 1. 组件化设计 (Componentization)
项目正在逐步推进组件化，以提高代码复用性和可维护性。

| 组件/工具类 | 位置 | 功能 |
|------------|------|------|
| `MiniQinDisk` | `components/MiniQinDisk.ets` | **微缩演禽盘**。展示三传圆圈与锁泊 2x2 网格，支持跨页面复用。 |
| `CalendarManager` | `utils/CalendarManager.ets` | **全局万年历管理器**。封装 JSON 加载与内存缓存，提供公历转农历/干支的统一接口。 |
| `QiYaoUtils` | `utils/QiYaoUtils.ets` | **七曜总断工具类**。实现16.1规则，将28宿分为7类（日月水木金土火），提供事体适配决策。 |
| `BaoYiZhuanUtils` | `utils/BaoYiZhuanUtils.ets` | **宝义专日工具类**。实现15.19规则，根据日干评级时间能量（宝义专制伐5级），检查臣犯君凶象。 |

### 2. Splash.ets - 引导页
- 位置：`entry/src/main/ets/pages/Splash.ets`
- 功能：App启动引导页，6秒自动跳转或点击进入主页
- 背景图：`rawfile/splash_bg.jpg`

### 3. Index.ets - 主页（方位推演）
- 位置：`entry/src/main/ets/pages/Index.ets`
- 功能：
  - 双卡片入口（方位推演 / 演禽盘式）
  - 日期时辰选择
  - 今日吉凶总断（七曜 + 宝义专日）
  - 智能择日助手入口
  - 十二宫通用含义推导
  - 方位结果展示

### 4. YanQinPanShi.ets - 演禽盘式（专业排盘）
- 位置：`entry/src/main/ets/pages/YanQinPanShi.ets`
- 功能模块：

| 模块 | 来源依据 | 功能 |
|------|----------|------|
| 三传四课 | 《禽星赋》 | 日禽→时禽→翻禽，四课定义 |
| 锁泊十二宫 | 《张良锁泊歌》 | 天地盘双层展示，上南下北 |
| 七曜与宝义专日 | 《16.1 七曜总断》《15.19 宝义专日》 | 本日吉凶总断，双栏卡片展示 |
| 吞啖生克 | 演禽规则 | 禽星五行生克判断 |
| 飞伏动静 | 演禽规则 | 日禽/夜禽活动状态 |
| 禽机赋断语 | 《禽机赋》 | 得地失陷、特殊格局判断 |
| 星宿物象 | 《射覆玄机赋》 | 二十八宿对应物品类象 |

### 5. LostItemsSearch.ets - 方位推演（走失占测）
- 位置：`entry/src/main/ets/pages/LostItemsSearch.ets`
- 功能：
  - 传统十三类用神 + 自定义28宿用神
  - 时间能量评估标签（七曜 + 宝义专日 + 15.x趋势）
  - 用神落宫方位推演
  - 断语库查询

### 6. ConstructionBurial.ets - 演禽造葬
- 位置：`entry/src/main/ets/pages/ConstructionBurial.ets`
- 功能：
  - 值日星宿查询
  - 七曜与宝义专日建议（智能适配造葬事宜）
  - 登垣判断
  - 纳音禁忌检查

### 7. SmartDateSelector.ets - 智能择日助手
- 位置：`entry/src/main/ets/pages/SmartDateSelector.ets`
- 功能：
  - 8种事体选择（嫁娶、埋葬、求名、上官、征伐、行商、造宅、祈福）
  - 智能评分算法（七曜适配 + 宝义专日评级）
  - 自动排除凶日（伐日、臣犯君、七曜禁忌）
  - 吉日列表展示（70分以上推荐）

### 8. KnowledgeGraph.ets - 知识图谱
- 位置：`entry/src/main/ets/pages/KnowledgeGraph.ets`
- 功能：规则文档可视化导航

---

## 四、核心配置文件

### 1. yanqin_star_rules.json
- 位置：`entry/src/main/resources/rawfile/yanqin_star_rules.json`
- 内容：
  - `constellations_order`：二十八宿顺序
  - `constellations_full`：星宿详细信息（全称、五行、动物）
  - `year_star_rules`：年禽计算规则
  - `month_star_rules`：月禽计算规则
  - `day_star_rules`：日禽计算规则（七元甲子）
  - `hour_star_rules`：时禽计算规则
  - `huo_yao_rules`：活曜计算规则
  - `tun_dan`：吞啖配置
  - `ri_ye_qin`：日禽/夜禽分类

### 2. suo_bo_rules.json
- 位置：`entry/src/main/resources/rawfile/suo_bo_rules.json`
- 内容：
  - `qin_attributes`：禽星属性分类（日禽/夜禽/水禽/山禽/家禽）
  - `special_powers`：特殊能力（井木犴、心月狐克鸡等）
  - `taboos`：特殊禁忌
  - `movement_rules`：动静规则（虎狼不下水、蛟龙不上山）
  - `star_imagery`：星宿物象（出自《射覆玄机赋》）
  - `branch_environments`：十二地支环境对应
  - `suo_bo_ge`：张良锁泊歌格局断语（已完整覆盖十二宫）

### 3. lost_items_config.json
- 位置：`entry/src/main/resources/rawfile/lost_items_config.json`
- 内容：用神速查表（方位推演用）

## 4. yanqin_knowledge_15x.json
- 位置：`entry/src/main/resources/rawfile/yanqin_knowledge_15x.json`
- 内容：15.10~15.18 中适合中性呈现的**时间趋势规则 + 盘面结构规则**的 JSON 知识库，用于生成"研习提示"标签；
- 与原文映射：
  - `time_trend.ten_evil` → 《15.10 活断  十恶大败日.md》
  - `time_trend.huang_wu` → 《15.12 活断  天地荒芜-十二月天地荒芜大凶日.md》
  - `time_trend.luotian` / `time_trend.general_arrow` / `time_trend.shi_zhong_jiangxing` → 《15.18 活断   李广将军箭-罗天大退日-大罗天大进日-进神退神时-时中将星.md》
  - `time_trend.sixjia` → 《15.17 活断   六甲进退神.md》
  - `pan_risk.liu_e_da_sha` → 《15.13 活断  禽中华盖方-六恶禽日-大煞六凶日.md》
  - `pan_risk.wu_tou` → 《15.14 活断  七日凶星诀-七元无头星.md》
  - `pan_risk.xinghai_tanghuo` → 《15.15 活断  灭没煞-百祸禽-刑害刀砧汤火-暗金伏断日时-伏断时.md》
  - `pan_risk.kong_wang_group` → 《15.16 活断   空亡体系_禽中大空亡-旬中空亡-截路空亡-六甲空亡.md》

### 5. 七曜与宝义专日规则（新增）
**位置**：`utils/QiYaoUtils.ets` 和 `utils/BaoYiZhuanUtils.ets`

**七曜总断（16.1规则）**：
- 将28宿分为7类：日曜（喜宿）、月曜（善宿）、水曜（弱宿）、木曜（文宿）、金曜（威宿）、土曜（怒宿）、火曜（燥宿）
- 事体适配：8种常见事体的七曜匹配规则（嫁娶、埋葬、求名、上官、征伐、行商、造宅、祈福）

**宝义专日（15.19规则）**：
- 日干分类：宝日（戊己）、义日（丙丁）、专日（壬癸）、制日（庚辛）、伐日（甲乙）
- 臣犯君检查：日干克岁干的凶象判断（五行相克关系）
- 综合评估：结合宝义专日等级和臣犯君状态，输出吉凶建议

**二十八宿诸禽断诀（规划中）**：
- 规则来源：`规则/二十八宿诸禽断诀.md`
- 作用定位：在七曜大类判断之上，提供按具体星宿+具体事体（嫁娶、造葬、求财、出行等）的精细用事吉凶提示
- 未来形态：计划以工具类和配置的形式接入智能择日与演禽造葬页面，作为第三层“星宿级微调规则”

---

## 五、规则文档目录

位置：`规则/`

| 文件 | 内容 |
|------|------|
| 10. 禽星锁泊、与演禽盘式的分工.md | 锁泊概念与盘式区别 |
| 10.1 锁泊十二宫的排法图形.md | 上南下北布局规范 |
| 10.2 演禽盘式的布局图形.md | 天地盘隐性结构说明 |
| 10.4 张良锁泊歌.md | 锁泊核心口诀与吉凶断语 |
| 12. 禽星赋.md | 三传四课定义、进退规则 |
| 13. 禽机赋.md | 禽星性情、喜忌、万物类象 |
| 14. 射覆玄机赋.md | 星宿物象对应 |
| 二十八宿诸禽断诀.md | 二十八宿逐宿用事吉凶总览（嫁娶、造葬、求财、出行等） |

---

## 六、排盘体系说明

### 三传四课（依据《禽星赋》）

**三传**（时间轴）：
- 初传 = 日禽（背景/大环境）
- 中传 = 时禽（当前状态/我）
- 末传 = 翻禽（最终结果/他）

**四课**（空间维度）：
- 一课 = 日禽
- 二课 = 时禽（我）
- 三课 = 翻禽（他）
- 四课 = 活曜（变）

### 天地盘（隐性结构）

演禽术的天地盘是**隐性**的：
- **地盘** = 时禽（我/静）
- **天盘** = 翻禽（他/动）
- **人盘** = 活曜（变）

同一地支位可同时显示天盘、地盘、人盘信息。

### 锁泊十二宫布局

**上南下北**（术数盘标准）：
```
      巳    午    未    申    ← 顶行（南）
      辰   [中宫] [中宫]  酉
      卯   [中宫] [中宫]  戌
      寅    丑    子    亥    ← 底行（北）
```

---

## 七、注意事项

### ArkTS开发规范
1. **禁止对象字面量作为类型**：必须定义interface
2. **Builder内禁止const声明**：使用类成员或方法获取数据
3. **使用Map替代Record**：避免`arkts-no-obj-literals-as-types`错误

### 资源命名规范
- 文件名只能包含`[a-zA-Z0-9_]`，禁止使用短横线`-`

### 路由配置
- 添加新页面需同时修改：
  1. `main_pages.json`
  2. `EntryAbility.ets`（如果是启动页）

### 敏感词规避
- "走失" → "方位推演"
- "精断" → "精研"
- 避免：命理、占卜、占断

---

## 八、待扩展功能

1. **进退强弱判断**：根据《禽星赋》的进退规则
2. **节气得时判断**：星宿在不同节气的旺衰

---

## 九、版本信息

- 当前版本：开发中
- 最后更新：2026年1月（已完成 UI 与数据组件化初步重构、接入 15.x JSON 知识库、**实现七曜与宝义专日算法与智能择日助手**）
- 编译状态：BUILD SUCCESSFUL

---

## 十、核心功能清单

| 功能模块 | 状态 | 备注 |
|----------|------|------|
| 四禽计算（年月日时） | ✅ 已完成 | 基于七元甲子算法 |
| 三传四课展示 | ✅ 已完成 | 演禽盘式核心 |
| 锁泊十二宫图 | ✅ 已完成 | 天地盘双层展示 |
| 翻禽/活曜计算 | ✅ 已完成 | 含吞啖、飞伏判断 |
| 禽机赋断语 | ✅ 已完成 | 得地失陷、格局判断 |
| 星宿物象展示 | ✅ 已完成 | 出自《射覆玄机赋》 |
| 15.x知识库对接 | ✅ 已完成 | 时间趋势 + 盘面结构 |
| **七曜总断算法** | ✅ 已完成 | **16.1规则，28宿分为7类** |
| **宝义专日算法** | ✅ 已完成 | **15.19规则，5级评估+臣犯君** |
| **智能择日助手** | ✅ 已完成 | **综合评分，自动筛选吉日** |
| 知识图谱导航 | ✅ 已完成 | 规则文档可视化 |
| 进退强弱判断 | ⏳ 待扩展 | 根据《禽星赋》 |
| 节气得时判断 | ⏳ 待扩展 | 星宿旺衰判断 |
