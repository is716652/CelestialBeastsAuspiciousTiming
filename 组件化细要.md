# 演禽术项目 - 组件化细要

本方案旨在通过 UI 组件化与数据逻辑组件化，提升项目的可扩展性，确保核心排盘逻辑与 UI 表现的一致性。

## 一、 UI 组件化：微缩盘 (MiniQinDisk)

### 1. 设计初衷
演禽术的分析往往需要对比多个时空点（如案例对比、三合局关联）。“微缩盘”组件允许在不离开当前主视图的情况下，以极小的空间展示完整的分析背景（三传+锁泊）。

### 2. 技术规格
- **文件路径**：`entry/src/main/ets/components/MiniQinDisk.ets`
- **输入接口**：
  - `MiniThreePassData`：初、中、末传星宿名及其视觉颜色。
  - `Array<MiniPalaceData>`：关键地支宫位、环境（如“砧板”）及落宫星宿。
- **视觉规范**：
  - 左侧：横向排列的三个圆形星宿位。
  - 右侧：2x2 网格，蓝色底边显示宫位环境，中心显示红色加粗星宿。

### 3. 复用场景
- **案例库**：展示特定案件的初始盘式。
- **提示卡片**：在“三合/六合”提示中，展示成局的几个宫位分布。
- **弹窗**：在分析特定吉凶格局时，作为辅助参考图示。

---

## 二、 数据组件化：万年历管理器 (CalendarManager)

### 1. 设计初衷
万年历数据量大（1900-2060年），且按年代分散在多个 JSON 文件中。组件化可以将文件索引、异步加载、解析、内存缓存等复杂逻辑完全隐藏。

### 2. 技术规格
- **文件路径**：`entry/src/main/ets/utils/CalendarManager.ets`
- **核心模式**：单例模式 (Singleton)。
- **核心接口**：`getDayInfo(year, month, day)`。
- **加载逻辑**：
  - 自动根据年份映射文件名（如 2024 -> `calendar_data_0013.json`）。
  - 使用 `Map<string, Array<CalendarDayInfo>>` 实现年代数据的内存缓存。

### 3. 优势
- **性能**：避免在页面切换或日期微调时重复读取磁盘。
- **解耦**：页面组件不再需要了解 `rawfile` 的具体路径，仅通过 `CalendarManager` 获取标准的 `CalendarDayInfo` 对象。

---

## 三、 算法组件化：七曜与宝义专日工具类 ⭐新增

### 1. QiYaoUtils - 七曜总断工具类

#### 设计初衷
将28宿分为7类（日月水木金土火）的七曜系统是演禽术的高级规则，用于事体适配决策。组件化可以将复杂的映射规则和事体匹配逻辑封装，供多个页面复用。

#### 技术规格
- **文件路径**：`entry/src/main/ets/utils/QiYaoUtils.ets`
- **规则来源**：《16.1 专题占 七曜总断与事体适配法则.md》
- **核心功能**：
  - 28宿∪7类映射
  - 7类性质与宜忌配置
  - 8种事体适配规则
  - 事体建议生成

#### 核心接口
```typescript
export function getQiYaoTypeFromStar(star: string): QiYaoType | null;
export function getQiYaoInfo(type: QiYaoType): QiYaoInfo;
export function isStarSuitableForEvent(star: string, eventName: string): SuitabilityResult;
export function getEventSuggestion(eventName: string): EventSuggestion | null;
export function getAllEventTypes(): string[];
```

#### 复用场景
- **首页**：今日七曜总断卡片
- **演禽盘式页**：本日七曜信息展示
- **走失占测页**：时间能量标签
- **演禽造葬页**：七曜适配建议
- **智能择日助手**：事体适配评分

### 2. BaoYiZhuanUtils - 宝义专日工具类

#### 设计初衷
宝义专日体系根据日干评级时间能量，是择日学的重要指标。组件化可以封装日干分类、臣犯君检查、综合评估等复杂逻辑。

#### 技术规格
- **文件路径**：`entry/src/main/ets/utils/BaoYiZhuanUtils.ets`
- **规则来源**：《15.19 活断 宝义专日与制伐日断法.md》
- **核心功能**：
  - 日干∪5级映射（宝义专制伐）
  - 臣犯君检查（五行相克）
  - 综合评估输出
  - 吉凶建议生成

#### 核心接口
```typescript
export function getDayLevelByGan(dayGan: string): DayLevel;
export function getDayLevelInfo(level: DayLevel): DayLevelInfo;
export function checkChenFanJun(dayGan: string, yearGan: string): ChenFanJunResult;
export function evaluateDayQuality(dayGan: string, yearGan: string): DayQualityEvaluation;
```

#### 复用场景
- **首页**：今日宝义专日卡片
- **演禽盘式页**：本日宝义专日信息
- **走失占测页**：时间能量标签
- **演禽造葬页**：宝义专日建议
- **智能择日助手**：宝义专日评分

### 3. 优势
- **代码复用**：所有4个页面共享同一套算法逻辑
- **逻辑一致**：规则更新时仅需修改工具类，所有页面同步生效
- **类型安全**：使用TypeScript类型定义，编译时检查
- **易测试**：算法逻辑与UI分离，便于单元测试

### 3. StarEventRulesUtils - 二十八宿用事规则工具类（规划中）

#### 设计初衷
在七曜与宝义专日两层规则之上，再按“具体星宿 × 具体事体”做精细化用事判断，可以让智能择日与演禽造葬在保证安全中性的前提下，呈现更贴近原典的研习提示。

#### 技术规格（规划）
- **文件路径**：`entry/src/main/ets/utils/StarEventRulesUtils.ets`
- **规则来源**：`规则/二十八宿诸禽断诀.md`
- **核心功能**：
  - 为每一颗星宿建立常见事体（嫁娶、埋葬、求财、上官、出行等）的吉/平/忌等级
  - 输出简短的理由文案，作为UI提示使用
  - 只承载结构化研习信息，不直接做“占断式”结论

#### 复用场景（规划）
- **智能择日助手**：在七曜+宝义专日评分基础上，追加星宿级提示（如“本日昴日鸡：婚姻大吉、埋葬不宜”）
- **演禽造葬页**：针对造葬事宜给出星宿用事的补充说明
- **演禽盘式页**：点击值日星宿时，可弹出该宿的简要用事摘要

---

## 三、 组件化引用规范

1. **统一存放**：
   - UI 组件存放在 `components/`。
   - 逻辑/数据工具存放在 `utils/`。

2. **类型安全**：
   - 所有传递给组件的数据必须通过显式的 `interface` 定义。
   - 禁止使用 `any` 或匿名对象。

3. **初始化流程**：
   - 涉及 Context 的管理器（如 CalendarManager）需在 App 或 Page 的 `aboutToAppear` 中调用 `.init(context)`。

---

## 四、 移植与复用指南

### 1. 项目内复用 (Internal Reuse)
在本项目的新页面中使用组件或工具，遵循以下步骤：

- **第一步：导入 (Import)**
  ```ts
  // 页面顶部导入
  import { MiniQinDisk } from '../components/MiniQinDisk';
  import { CalendarManager } from '../utils/CalendarManager';
  ```
- **第二步：初始化 (如有必要)**
  在 Page 的 `aboutToAppear` 生命周期函数中：
  ```ts
  CalendarManager.getInstance().init(getContext(this));
  ```
- **第三步：调用 (Usage)**
  在 `build()` 中直接使用组件标签。

### 2. 项目间移植 (Cross-Project Migration)
将组件迁移到全新的 HarmonyOS 项目中，需确保“代码 + 资源”同步到位：

- **UI 组件迁移 (`MiniQinDisk`)**：
  1. 拷贝 `entry/src/main/ets/components/MiniQinDisk.ets` 到新项目对应目录。
  2. 检查新项目的 SDK 版本是否兼容 ArkUI 声明式语法。

- **数据工具迁移 (`CalendarManager`)**：
  1. 拷贝 `entry/src/main/ets/utils/CalendarManager.ets` 到新项目。
  2. **关键：拷贝资源文件**。必须将原项目的 `entry/src/main/resources/rawfile/calendar/` 目录下所有 JSON 文件完整拷贝到新项目的 `rawfile/calendar/` 中。
  3. 检查 `oh-package.json5` 是否已包含 `@kit.AbilityKit` 和 `@kit.ArkTS` 等标准库。

- **移植注意事项**：
  - **路径一致性**：`CalendarManager` 内部硬编码了 `calendar/` 路径，请确保新项目 `rawfile` 下目录名一致。
  - **单例状态**：在跨项目使用时，务必记得在入口处调用 `init()`，否则 `context` 为空会导致读取文件失败。
