import { common } from '@kit.AbilityKit';
import { buffer, JSON as ArkJSON } from '@kit.ArkTS';
import { router } from '@kit.ArkUI';
import { LengthMetrics } from '@kit.ArkUI';
import { CalendarManager, CalendarDayInfo } from '../utils/CalendarManager';
import { calcTimeTrendFromCalendar, TimeRiskTag } from '../utils/Knowledge15x';
import { getQiYaoTypeFromStar, getQiYaoInfo, QiYaoInfo } from '../utils/QiYaoUtils';
import { evaluateDayQuality, DayQualityEvaluation } from '../utils/BaoYiZhuanUtils';

// ============== æ¥å£å®šä¹‰ ==============

interface ConstellationInfo {
  full_name: string;
  element: string;
  animal: string;
}

interface YearStarRules {
  base_year: number;
  base_star: string;
}

interface MonthStarRules {
  element_to_start_star: Record<string, string>;
}

interface DayStarBaseDate {
  date: string;
  yuan: number;
  jiang: number;
  star: string;
}

interface SevenYuanHeads {
  list: Array<string>;
}

interface DayStarRules {
  cycle_days: number;
  yuan_days: number;
  jiang_days: number;
  seven_yuan_heads: SevenYuanHeads;
  four_generals: Record<string, Array<string>>;
  base_date: DayStarBaseDate;
}

interface HourStarRules {
  element_to_start_star: Record<string, string>;
}

interface HourTimeRange {
  start: string;
  end: string;
  index: number;
}

interface YanqinStarRulesConfig {
  constellations_order: Array<string>;
  constellations_full: Record<string, ConstellationInfo>;
  branches_order: Array<string>;
  year_star_rules: YearStarRules;
  month_star_rules: MonthStarRules;
  day_star_rules: DayStarRules;
  hour_star_rules: HourStarRules;
  hour_time_ranges: Record<string, HourTimeRange>;
}

interface LostItemUseGod {
  category: string;
  star: string;
  note: string;
}

interface LostItemsConfig {
  constellations_order: Array<string>;
  branches_order: Array<string>;
  use_gods: Array<LostItemUseGod>;
}

interface RuleItem {
  text: string;
  category?: string;
}

interface RulesConfig {
  rules: Record<string, RuleItem>;
  branch_meanings: Record<string, BranchMeaning>;
}

interface StarGroup {
  name: string;
  stars: string[];
}

interface BranchMeaning {
  direction: string;
  element: string;
  environment: string;
  time_hint: string;
  informant: string;
  general: string;
}

interface StarCalcResult {
  star: string;
  fullName: string;
  element: string;
}

interface DayStarCalcResult {
  star: string;
  fullName: string;
  element: string;
  yuanName: string;
  jiangIndex: number;
  jiangStar: string;
}

interface FourStarsResult {
  yearStar: string;
  yearStarFull: string;
  yearElement: string;
  monthStar: string;
  monthStarFull: string;
  dayStar: string;
  dayStarFull: string;
  dayElement: string;
  hourStar: string;
  hourStarFull: string;
  hourElement: string;
  yuanName: string;
  jiangIndex: number;
  jiangStar: string;
}

@Entry
@Component
struct LostItemsSearch {
  private context = getContext(this) as common.Context;

  // é…ç½®æ•°æ®
  @State hasLoaded: boolean = false;
  @State starRulesConfig: YanqinStarRulesConfig | null = null;
  @State lostItemsConfig: LostItemsConfig | null = null;
  @State rulesConfig: RulesConfig | null = null;

  // ç”¨æˆ·é€‰æ‹©
  @State selectedYear: number = new Date().getFullYear();
  @State selectedMonth: number = new Date().getMonth() + 1;
  @State selectedDay: number = new Date().getDate();
  @State selectedHourIndex: number = 0;
  @State useGodMode: number = 0;  // 0=ä¼ ç»Ÿåˆ†ç±», 1=è‡ªå®šä¹‰ç”¨ç¥
  @State selectedCategoryIndex: number = 0;  // ä¼ ç»Ÿåˆ†ç±»ç´¢å¼•
  @State selectedUseGodStar: string = 'å‚';  // è‡ªå®šä¹‰ç”¨ç¥æ˜Ÿå®¿
  @State isShowUseGodSheet: boolean = false;

  private starEmojiMap: Record<string, string> = {
    'è§’': 'ğŸ‰', 'äº¢': 'ğŸ²', 'æ°': 'ğŸ¦¡', 'æˆ¿': 'ğŸ°', 'å¿ƒ': 'ğŸ¦Š', 'å°¾': 'ğŸ¯', 'ç®µ': ' leopards',
    'æ–—': 'ç¬', 'ç‰›': 'ğŸ‚', 'å¥³': 'ğŸ¦‡', 'è™š': 'ğŸ€', 'å±': 'ğŸ•Šï¸', 'å®¤': 'ğŸ–', 'å£': 'ğŸ¦Œ',
    'å¥': 'ğŸº', 'å¨„': 'ğŸ•', 'èƒƒ': 'é›‰', 'æ˜‚': 'ğŸ“', 'æ¯•': 'ğŸ¦', 'è§œ': 'ğŸ’', 'å‚': 'ğŸ¦',
    'äº•': 'ğŸ•', 'é¬¼': 'ğŸ', 'æŸ³': 'ğŸ¦Œ', 'æ˜Ÿ': 'ğŸ', 'å¼ ': 'ğŸ¦Œ', 'ç¿¼': 'ğŸ', 'è½¸': 'ğŸ›'
  };

  private starGroups: StarGroup[] = [];

  // å››ç¦½è®¡ç®—ç»“æœ
  @State fourStars: FourStarsResult | null = null;
  @State dayInfo: CalendarDayInfo | null = null;
  @State timeTrendTags: TimeRiskTag[] = [];
  @State dayQiYaoInfo: QiYaoInfo | null = null;
  @State dayLevelInfo: DayQualityEvaluation | null = null;

  // æ’ç›˜ç»“æœ
  @State resultKey: string = '';
  @State resultSummary: string = '';
  @State resultDetail: string = '';
  @State resultBranch: string = '';
  @State showResult: boolean = false;

  // ç”¨ç¥è¯´æ˜æ˜ å°„ (28å®¿æ‰©å±•)
  private starExtendedMeanings: Record<string, string> = {
    'è§’': 'é•¿æ¡ç‰©ï¼ˆç»³ç”µç¼†ï¼‰ã€æ–‡ä¹¦ã€é¾™å½¢é¥°å“',
    'äº¢': 'è´µé‡é‡‘å±ã€å¤è‘£ã€å°ç« ã€é«˜å¤„ä¹‹ç‰©',
    'æ°': 'çš®æ¯›è¡£ç‰©ã€åŒ–å¦†å“ã€åœ°ä¸‹åŸ‹è—ç‰©',
    'æˆ¿': 'å°å‹ç™½è‰²ç‰©ã€ç”µå­è®¾å¤‡ï¼ˆä¼ ç»Ÿï¼šé©´éª¡ï¼‰',
    'å¿ƒ': 'éšç§˜ä¹‹ç‰©ï¼ˆUç›˜æ—¥è®°ï¼‰ã€å¥³æ€§ç”¨å“',
    'å°¾': 'å¤§å‹çŒ›å…½ï¼ˆçŒ«ç§‘ï¼‰ã€æ­¦å™¨ã€çº¢è‰²ç‰©å“',
    'ç®•': 'æ•æ·åŠ¨ç‰©ï¼ˆçŒ«çŠ¬ï¼‰ã€æµåŠ¨ä¹‹ç‰©ï¼ˆé…’æ²¹ï¼‰',
    'æ–—': 'æ³•å¾‹æ–‡ä¹¦ã€å…¬æ­£ä¹‹ç‰©ã€ç‹¬è§’é¥°å“',
    'ç‰›': 'é‡å‹æœºæ¢°ã€å†œå…·ã€å¤§å‹ç‰²å£ï¼ˆä¼ ç»Ÿï¼šç‰›ï¼‰',
    'å¥³': 'å¤œé—´ä¸¢å¤±ç‰©ã€é»‘è‰²è½»å·§ç‰©ï¼ˆä¼ ç»Ÿï¼šå¥³å­ï¼‰',
    'è™š': 'ç»†å°é›¶ä»¶ã€è—äºè§’è½ä¹‹ç‰©ï¼ˆä¼ ç»Ÿï¼šå°å„¿ï¼‰',
    'å±': 'é£è¡Œå™¨ï¼ˆæ— äººæœºé£ç­ï¼‰ã€é«˜å¤„æ‚¬æŒ‚ç‰©',
    'å®¤': 'å¨æˆ¿ç”¨å“ã€æ²¹è…»ä¹‹ç‰©ï¼ˆä¼ ç»Ÿï¼šçŒªï¼‰',
    'å£': 'å¥‡å½¢æ€ªçŠ¶ä¹‹ç‰©ã€ç ´æŸç‰©ã€å¢™è¾¹ç•Œå¤„',
    'å¥': 'é‡æ€§ä¹‹ç‰©ã€ç¾¤å±…åŠ¨ç‰©ï¼ˆä¼ ç»Ÿï¼šå¦‡äººï¼‰',
    'å¨„': 'å¿ è¯šä¹‹ç‰©ï¼ˆé’¥åŒ™é—¨ç¦å¡ï¼‰ï¼ˆä¼ ç»Ÿï¼šç‹—ï¼‰',
    'èƒƒ': 'å½©è‰²è¡£ç‰©ã€ç¾½æ¯›åˆ¶å“ã€ç²®é£Ÿä»“åº“',
    'æ˜´': 'é¸£å«ä¹‹ç‰©ï¼ˆé—¹é’Ÿé“ƒé“›ï¼‰ï¼ˆä¼ ç»Ÿï¼šé¸¡ï¼‰',
    'æ¯•': 'é»‘è‰²ç‰©å“ã€å¤œé—´æ´»åŠ¨ä¹‹ç‰©',
    'è§œ': 'çµå·§ä¹‹ç‰©ï¼ˆå·¥å…·ç©å…·ï¼‰ã€æ”€çˆ¬ç›¸å…³ï¼ˆä¼ ç»Ÿï¼šç”·å­ï¼‰',
    'å‚': 'æ°´ä¸­ä¹‹ç‰©ã€çµæ´»è´µé‡å“ï¼ˆä¼ ç»Ÿï¼šé‡‘é“¶ï¼‰',
    'äº•': 'æ·±äº•ä¸‹æ°´é“ã€æ³•å¾‹ç›¸å…³ã€åŒ—æ–¹æ°´è¾¹',
    'é¬¼': 'ç¥­ç¥€ç”¨å“ã€ç™½è‰²æŸ”è½¯ç‰©ï¼ˆä¼ ç»Ÿï¼šç¾Šï¼‰',
    'æŸ³': 'æ—é—´å°ç‰©ã€å¿«é€Ÿé€ƒé€¸ä¹‹ç‰©ï¼ˆä¼ ç»Ÿï¼šè¡£ç‰©ï¼‰',
    'æ˜Ÿ': 'äº¤é€šå·¥å…·ï¼ˆè½¦ï¼‰ã€å¿«é€Ÿç§»åŠ¨å“ï¼ˆä¼ ç»Ÿï¼šé©¬ï¼‰',
    'å¼ ': 'æ¸©é¡ºåŠ¨ç‰©ï¼ˆå…”ï¼‰ã€å±±æ—è‰ä¸›ä¸­å¤±ç‰©',
    'ç¿¼': 'é•¿æ¡è½¯ç‰©ï¼ˆå›´å·¾æ•°æ®çº¿ï¼‰ã€éšè”½ç¼ ç»•',
    'è½¸': 'ç»†é•¿æŸ”è½¯ç‰©ï¼ˆèƒ¶å¸¦ï¼‰ã€ä½æ´¼æ½®æ¹¿å¤„'
  };

  // é€‰æ‹©å™¨æ•°æ®
  @State yearOptions: SelectOption[] = [];
  @State monthOptions: SelectOption[] = [];
  @State dayOptions: SelectOption[] = [];
  @State hourOptions: SelectOption[] = [];

  aboutToAppear(): void {
    // åˆå§‹åŒ–åˆ†ç±»æ•°æ®
    this.starGroups = [
      { name: 'ä¸œæ–¹é’é¾™', stars: ['è§’', 'äº¢', 'æ°', 'æˆ¿', 'å¿ƒ', 'å°¾', 'ç®µ'] },
      { name: 'åŒ—æ–¹ç„æ­¦', stars: ['æ–—', 'ç‰›', 'å¥³', 'è™š', 'å±', 'å®¤', 'å£'] },
      { name: 'è¥¿æ–¹ç™½è™', stars: ['å¥', 'å¨„', 'èƒƒ', 'æ˜‚', 'æ¯•', 'è§œ', 'å‚'] },
      { name: 'å—æ–¹æœ±é›€', stars: ['äº•', 'é¬¼', 'æŸ³', 'æ˜Ÿ', 'å¼ ', 'ç¿¼', 'è½¸'] }
    ];

    const params = router.getParams() as Record<string, number>;
    if (params) {
      this.selectedYear = params.year || this.selectedYear;
      this.selectedMonth = params.month || this.selectedMonth;
      this.selectedDay = params.day || this.selectedDay;
      this.selectedHourIndex = params.hourIndex || 0;
    }
    this.initOptions();
    CalendarManager.getInstance().init(this.context);
    this.initData();
  }

  private initOptions(): void {
    for (let y = 1900; y <= 2061; y++) this.yearOptions.push({ value: `${y}å¹´` });
    for (let m = 1; m <= 12; m++) this.monthOptions.push({ value: `${m}æœˆ` });
    this.updateDayOptions();
    const branches = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
    const times = ['23-01', '01-03', '03-05', '05-07', '07-09', '09-11', '11-13', '13-15', '15-17', '17-19', '19-21', '21-23'];
    for (let i = 0; i < 12; i++) this.hourOptions.push({ value: `${branches[i]}æ—¶ (${times[i]}ç‚¹)` });
  }

  private updateDayOptions(): void {
    const daysInMonth = new Date(this.selectedYear, this.selectedMonth, 0).getDate();
    this.dayOptions = [];
    for (let d = 1; d <= daysInMonth; d++) this.dayOptions.push({ value: `${d}æ—¥` });
    if (this.selectedDay > daysInMonth) this.selectedDay = daysInMonth;
  }

  private async initData(): Promise<void> {
    const starRules = await this.loadJsonFromRaw<YanqinStarRulesConfig>('yanqin_star_rules.json');
    const lostItems = await this.loadJsonFromRaw<LostItemsConfig>('lost_items_config.json');
    const rules = await this.loadJsonFromRaw<RulesConfig>('lost_items_rules.json');

    if (starRules && lostItems && rules) {
      this.starRulesConfig = starRules;
      this.lostItemsConfig = lostItems;
      this.rulesConfig = rules;
      this.hasLoaded = true;
      this.calculateFourStars();
    }
  }

  private async loadJsonFromRaw<T>(fileName: string): Promise<T | null> {
    try {
      const value = await this.context.resourceManager.getRawFileContent(fileName);
      return ArkJSON.parse(buffer.from(value.buffer).toString()) as T;
    } catch (err) {
      return null;
    }
  }

  private async calculateFourStars(): Promise<void> {
    if (!this.starRulesConfig) return;
    const cfg = this.starRulesConfig;
    const yearResult = this.calculateYearStar(this.selectedYear, cfg);
    const monthResult = this.calculateMonthStar(this.selectedMonth, yearResult.element, cfg);
    const dayResult = this.calculateDayStar(this.selectedYear, this.selectedMonth, this.selectedDay, cfg);
    const hourResult = this.calculateHourStar(this.selectedHourIndex, dayResult.element, cfg);

    this.fourStars = {
      yearStar: yearResult.star, yearStarFull: yearResult.fullName, yearElement: yearResult.element,
      monthStar: monthResult.star, monthStarFull: monthResult.fullName,
      dayStar: dayResult.star, dayStarFull: dayResult.fullName, dayElement: dayResult.element,
      hourStar: hourResult.star, hourStarFull: hourResult.fullName, hourElement: hourResult.element,
      yuanName: dayResult.yuanName, jiangIndex: dayResult.jiangIndex, jiangStar: dayResult.jiangStar
    };

    const info = await CalendarManager.getInstance().getDayInfo(this.selectedYear, this.selectedMonth, this.selectedDay);
    this.dayInfo = info;
    if (info) {
      const trend = await calcTimeTrendFromCalendar(info, this.context);
      this.timeTrendTags = trend.tags;
      
      // è·å–ä¸ƒæ›œä¿¡æ¯
      const qiYaoType = getQiYaoTypeFromStar(dayResult.star);
      if (qiYaoType) {
        this.dayQiYaoInfo = getQiYaoInfo(qiYaoType);
      }
      
      // è¯„ä¼°å®ä¹‰ä¸“æ—¥
      this.dayLevelInfo = evaluateDayQuality(info.day_gan, info.year_gan);
    }
  }

  private calculateYearStar(year: number, cfg: YanqinStarRulesConfig): StarCalcResult {
    const constellations = cfg.constellations_order;
    const baseIndex = constellations.indexOf(cfg.year_star_rules.base_star);
    const starIndex = (((year - cfg.year_star_rules.base_year) % 28) + 28 + baseIndex) % 28;
    const info = cfg.constellations_full[constellations[starIndex]];
    return { star: constellations[starIndex], fullName: info.full_name, element: info.element };
  }

  private calculateMonthStar(month: number, yearElement: string, cfg: YanqinStarRulesConfig): StarCalcResult {
    const constellations = cfg.constellations_order;
    const startIndex = constellations.indexOf(cfg.month_star_rules.element_to_start_star[yearElement]);
    const star = constellations[(startIndex + (month - 1)) % 28];
    const info = cfg.constellations_full[star];
    return { star, fullName: info.full_name, element: info.element };
  }

  private calculateDayStar(year: number, month: number, day: number, cfg: YanqinStarRulesConfig): DayStarCalcResult {
    const constellations = cfg.constellations_order;
    const baseParts = cfg.day_star_rules.base_date.date.split('-');
    const baseDate = new Date(parseInt(baseParts[0]), parseInt(baseParts[1]) - 1, parseInt(baseParts[2]));
    const diffDays = Math.floor((new Date(year, month - 1, day).getTime() - baseDate.getTime()) / 86400000);
    const posInCycle = ((diffDays % 420) + 420) % 420;
    const yuanName = ['ä¸€å…ƒ', 'äºŒå…ƒ', 'ä¸‰å…ƒ', 'å››å…ƒ', 'äº”å…ƒ', 'å…­å…ƒ', 'ä¸ƒå…ƒ'][Math.floor(posInCycle / 60)];
    const jiangIndex = Math.floor((posInCycle % 60) / 15);
    const jiangStar = cfg.day_star_rules.four_generals[yuanName][jiangIndex];
    const star = constellations[(constellations.indexOf(jiangStar) + (posInCycle % 15)) % 28];
    const info = cfg.constellations_full[star];
    return { star, fullName: info.full_name, element: info.element, yuanName, jiangIndex: jiangIndex + 1, jiangStar };
  }

  private calculateHourStar(hourIndex: number, dayElement: string, cfg: YanqinStarRulesConfig): StarCalcResult {
    const constellations = cfg.constellations_order;
    const startIndex = constellations.indexOf(cfg.hour_star_rules.element_to_start_star[dayElement]);
    const star = constellations[(startIndex + hourIndex) % 28];
    const info = cfg.constellations_full[star];
    return { star, fullName: info.full_name, element: info.element };
  }

  private doCalculate(): void {
    if (!this.fourStars || !this.lostItemsConfig || !this.rulesConfig || !this.starRulesConfig) return;
    const constellations = this.starRulesConfig.constellations_order;
    const branches = this.lostItemsConfig.branches_order;
    let useGodStar = this.useGodMode === 0 ? this.lostItemsConfig.use_gods[this.selectedCategoryIndex].star : this.selectedUseGodStar;
    const deltaStars = (constellations.indexOf(useGodStar) - constellations.indexOf(this.fourStars.dayStar) + 28) % 28;
    this.resultBranch = branches[(this.selectedHourIndex + deltaStars) % 12];
    const starNameMap: Record<string, string> = { 'è§œ': 'è§œæ˜Ÿ', 'å¥': 'å¥å®¿', 'è™š': 'è™šå®¿', 'å¥³': 'å¥³å®¿', 'æ˜Ÿ': 'æ˜Ÿå®¿', 'ç‰›': 'ç‰›å®¿', 'æˆ¿': 'æˆ¿å®¿', 'é¬¼': 'é¬¼å®¿', 'å®¤': 'å®¤å®¿', 'å‚': 'å‚å®¿', 'æ˜´': 'æ˜´å®¿', 'å¨„': 'å¨„å®¿', 'æŸ³': 'æŸ³å®¿' };
    this.resultKey = `${starNameMap[useGodStar] || `${useGodStar}æ˜Ÿ`}åœ¨${this.resultBranch}`;
    const rule = this.rulesConfig.rules[this.resultKey];
    this.resultSummary = this.useGodMode === 0 ? `å¯»${this.lostItemsConfig.use_gods[this.selectedCategoryIndex].category} Â· ç”¨ç¥ã€Œ${useGodStar}ã€å®¿ Â· è½ã€Œ${this.resultBranch}ã€å®«` : `ç”¨ç¥ã€Œ${this.starRulesConfig.constellations_full[useGodStar]?.full_name || useGodStar}ã€ Â· è½ã€Œ${this.resultBranch}ã€å®«`;
    if (rule) this.resultDetail = rule.text;
    else {
      const bm = this.rulesConfig.branch_meanings[this.resultBranch];
      this.resultDetail = bm ? `ã€é€šç”¨æ¨å¯¼ã€‘
æ–¹ä½ï¼š${bm.direction}
äº”è¡Œï¼š${bm.element}
ç¯å¢ƒï¼š${bm.environment}
æŠ¥ä¿¡ï¼š${bm.informant}
æ—¶é—´ï¼š${bm.time_hint}

åˆ†æï¼š${bm.general}` : 'æš‚æ— è®°è½½ã€‚';
    }
    this.showResult = true;
  }

  build() {
    Column() {
      // å¯¼èˆªæ 
      Row() {
        Image($r('app.media.app_icon')) // å‡è®¾æœ‰å›¾æ ‡ï¼Œå¦åˆ™ç”¨æ–‡å­—
          .width(24).height(24).margin({ right: 10 })
          .onClick(() => router.back())
        Text('ğŸ“ æ–¹ä½æ¨æ¼”')
          .fontSize(20).fontWeight(FontWeight.Bold).fontColor('#1a1a1a')
        Blank()
        Text('å…³é—­').fontSize(16).fontColor('#666666').onClick(() => router.back())
      }
      .width('100%').padding({ left: 16, right: 16, top: 40, bottom: 16 })
      .backgroundColor('#ffffff')

      Scroll() {
        Column() {
          // æ—¶é—´é€‰æ‹©
          Column() {
            Text('ğŸ“… é€‰å®šæ—¶é—´').fontSize(16).fontWeight(FontWeight.Bold).width('100%').margin({ bottom: 12 }).fontColor('#333333')
            Row() {
              Select(this.yearOptions).selected(this.selectedYear - 1900).value(`${this.selectedYear}å¹´`).layoutWeight(1).onSelect(v => {
                this.selectedYear = 1900 + v;
                this.updateDayOptions();
                this.calculateFourStars();
              })
              Select(this.monthOptions).selected(this.selectedMonth - 1).value(`${this.selectedMonth}æœˆ`).layoutWeight(1).margin({ left: 8 }).onSelect(v => {
                this.selectedMonth = v + 1;
                this.updateDayOptions();
                this.calculateFourStars();
              })
              Select(this.dayOptions).selected(this.selectedDay - 1).value(`${this.selectedDay}æ—¥`).layoutWeight(1).margin({ left: 8 }).onSelect(v => {
                this.selectedDay = v + 1;
                this.calculateFourStars();
              })
            }
            Select(this.hourOptions).selected(this.selectedHourIndex).value(this.hourOptions[this.selectedHourIndex]?.value).width('100%').margin({ top: 10 }).onSelect(v => {
              this.selectedHourIndex = v;
              this.calculateFourStars();
            })
          }
          .padding(16).backgroundColor('#ffffff').borderRadius(12).margin({ left: 16, right: 16, top: 16, bottom: 8 })

          // ç”¨ç¥é€‰æ‹© (æ ¸å¿ƒè¡¥å……)
          Column() {
            Text('ğŸ” é€‰æ‹©ç”¨ç¥').fontSize(16).fontWeight(FontWeight.Bold).width('100%').margin({ bottom: 12 }).fontColor('#333333')
            
            Row() {
              Button('ä¼ ç»Ÿåä¸‰ç±»')
                .fontSize(14)
                .type(ButtonType.Normal)
                .layoutWeight(1)
                .height(36)
                .borderRadius({ topLeft: 8, bottomLeft: 8 })
                .backgroundColor(this.useGodMode === 0 ? '#3d6b4f' : '#f0f0f0')
                .fontColor(this.useGodMode === 0 ? '#ffffff' : '#666666')
                .onClick(() => this.useGodMode = 0)
              
              Button('äºŒåå…«å®¿è‡ªå®šä¹‰')
                .fontSize(14)
                .type(ButtonType.Normal)
                .layoutWeight(1)
                .height(36)
                .borderRadius({ topRight: 8, bottomRight: 8 })
                .backgroundColor(this.useGodMode === 1 ? '#3d6b4f' : '#f0f0f0')
                .fontColor(this.useGodMode === 1 ? '#ffffff' : '#666666')
                .onClick(() => this.useGodMode = 1)
            }
            .width('100%')
            .margin({ bottom: 12 })

            if (this.useGodMode === 0 && this.lostItemsConfig) {
              // ä¼ ç»Ÿåˆ†ç±»é€‰æ‹©
              Column() {
                Text('é€‰æ‹©å¤±ç‰©ç±»åˆ«ï¼š').fontSize(13).fontColor('#666666').margin({ bottom: 8 }).width('100%')
                Flex({ wrap: FlexWrap.Wrap }) {
                  ForEach(this.lostItemsConfig.use_gods, (item: LostItemUseGod, index: number) => {
                    Text(item.category)
                      .fontSize(13)
                      .padding({ left: 12, right: 12, top: 6, bottom: 6 })
                      .margin({ right: 8, bottom: 8 })
                      .backgroundColor(this.selectedCategoryIndex === index ? '#e8f4fc' : '#f5f5f5')
                      .fontColor(this.selectedCategoryIndex === index ? '#1a5276' : '#333333')
                      .borderRadius(16)
                      .border({ width: 1, color: this.selectedCategoryIndex === index ? '#1a5276' : '#e0e0e0' })
                      .onClick(() => this.selectedCategoryIndex = index)
                  })
                }
                Text(`å¯¹åº”ä¼ ç»Ÿç”¨ç¥ï¼š${this.lostItemsConfig.use_gods[this.selectedCategoryIndex].star}å®¿ (${this.lostItemsConfig.use_gods[this.selectedCategoryIndex].note})`)
                  .fontSize(12).fontColor('#1a5276').margin({ top: 10 }).width('100%').fontStyle(FontStyle.Italic)
              }
            } else if (this.starRulesConfig) {
              // äºŒåå…«å®¿è‡ªå®šä¹‰é€‰æ‹©
              Column() {
                Text('ç‚¹å‡»å›¾æ ‡é€‰æ‹©å¯¹åº”æ˜Ÿå®¿ï¼š').fontSize(13).fontColor('#666666').margin({ bottom: 8 }).width('100%')
                
                Row() {
                  Text(this.starEmojiMap[this.selectedUseGodStar] || 'âœ¨')
                    .fontSize(24)
                    .margin({ right: 10 })
                  
                  Column() {
                    Text(`${this.selectedUseGodStar}å®¿`)
                      .fontSize(16)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#d32f2f')
                    Text(this.starRulesConfig.constellations_full[this.selectedUseGodStar]?.full_name || '')
                      .fontSize(11)
                      .fontColor('#999999')
                  }
                  .alignItems(HorizontalAlign.Start)
                  .layoutWeight(1)

                  Text('åˆ‡æ¢ ã€‰')
                    .fontSize(14)
                    .fontColor('#1a5276')
                    .fontWeight(FontWeight.Medium)
                }
                .width('100%')
                .padding(12)
                .backgroundColor('#f5f5f5')
                .borderRadius(12)
                .onClick(() => {
                  this.isShowUseGodSheet = true;
                })
                .bindSheet(this.isShowUseGodSheet, this.UseGodPicker(), {
                  height: SheetSize.MEDIUM,
                  title: { title: "é€‰æ‹©è‡ªå®šä¹‰ç”¨ç¥", subtitle: "28æ˜Ÿå®¿åˆ†ç±»é€Ÿé€‰" },
                  onDisappear: () => { this.isShowUseGodSheet = false }
                })
                
                Text(`ç±»è±¡ç‰¹å¾ï¼š${this.starExtendedMeanings[this.selectedUseGodStar] || 'æš‚æ— è¯´æ˜'}`)
                  .fontSize(12).fontColor('#3d6b4f').margin({ top: 10 }).width('100%').lineHeight(16)
              }
            }
          }
          .padding(16).backgroundColor('#ffffff').borderRadius(12).margin({ left: 16, right: 16, bottom: 16 })

          // ========== ä¸ƒæ›œä¸å®ä¹‰ä¸“æ—¥æ ‡ç­¾ ==========
          if (this.dayQiYaoInfo && this.dayLevelInfo) {
            this.TimeTrendTagsCard()
          }

          // æ¼”ç®—æŒ‰é’®
          Button('æ‰§è¡Œæ–¹ä½æ¨æ¼”')
            .width('90%').height(48).backgroundColor('#3d6b4f').margin({ bottom: 16, top: 8 })
            .onClick(() => this.doCalculate())

          if (this.showResult) {
            Column() {
              Text('æ¨æ¼”ç»“æœ').fontSize(18).fontWeight(FontWeight.Bold).fontColor('#1a1a1a').margin({ bottom: 12 }).width('100%')
              Text(this.resultSummary).fontSize(15).fontWeight(FontWeight.Bold).fontColor('#3d6b4f').margin({ bottom: 10 }).width('100%')
              
              Divider().margin({ bottom: 12 })
              
              Text(this.resultDetail).fontSize(14).fontColor('#333333').lineHeight(22).width('100%')
              
              Column() {
                Text('ã€ç ”ä¹ å»ºè®®ã€‘').fontSize(13).fontWeight(FontWeight.Bold).margin({ bottom: 4 }).width('100%')
                Text('æ­¤æ–¹ä½ç»“åˆâ€œé”æ³Šâ€ç¯å¢ƒåˆ¤æ–­å¤±ç‰©çŠ¶æ€ã€‚è‹¥è½å®«ä¸ºâ€œåˆ€ç §â€ä¸»å—æŸï¼Œâ€œå±±æ—â€ä¸»é«˜å¤„ã€‚å¯ç”¨ç¥ä¸ç›˜å¼ç»“åˆæ–¹ä¸ºæ­£æ³•ã€‚')
                  .fontSize(12).fontColor('#666666').lineHeight(18)
              }.margin({ top: 16 }).padding(10).backgroundColor('#f0f0f0').borderRadius(8)
            }
            .padding(20).backgroundColor('#ffffff').borderRadius(16).margin({ left: 16, right: 16, bottom: 40 }).border({ width: 1, color: '#e0e0e0' })
          }
        }
      }
    }
    .width('100%').height('100%').backgroundColor('#f8f8f8')
  }

  @Builder
  TimeTrendTagsCard() {
    Column() {
      Text('â”€â”€ æœ¬æ—¥æ—¶é—´èƒ½é‡è¯„ä¼° â”€â”€')
        .fontSize(13)
        .fontColor('#666666')
        .margin({ bottom: 12 })

      Flex({ wrap: FlexWrap.Wrap, justifyContent: FlexAlign.Start }) {
        // ä¸ƒæ›œæ ‡ç­¾
        Row() {
          Text('ğŸŒŸ')
            .fontSize(14)
            .margin({ right: 4 })
          Text(this.dayQiYaoInfo!.name)
            .fontSize(12)
            .fontColor(this.dayQiYaoInfo!.color)
            .fontWeight(FontWeight.Bold)
        }
        .padding({ left: 10, right: 10, top: 5, bottom: 5 })
        .backgroundColor(this.dayQiYaoInfo!.color + '20')
        .borderRadius(14)
        .margin({ right: 8, bottom: 8 })
        .border({ width: 1, color: this.dayQiYaoInfo!.color })

        // å®ä¹‰ä¸“æ—¥æ ‡ç­¾
        Row() {
          Text(this.dayLevelInfo!.dayLevelInfo.emoji)
            .fontSize(14)
            .margin({ right: 4 })
          Text(this.dayLevelInfo!.dayLevelInfo.name)
            .fontSize(12)
            .fontColor(this.dayLevelInfo!.dayLevelInfo.color)
            .fontWeight(FontWeight.Bold)
        }
        .padding({ left: 10, right: 10, top: 5, bottom: 5 })
        .backgroundColor(this.dayLevelInfo!.dayLevelInfo.color + '20')
        .borderRadius(14)
        .margin({ right: 8, bottom: 8 })
        .border({ width: 1, color: this.dayLevelInfo!.dayLevelInfo.color })

        // è‡£çŠ¯å›è­¦å‘Š
        if (this.dayLevelInfo!.isChenFanJun) {
          Row() {
            Text('âš ï¸')
              .fontSize(14)
              .margin({ right: 4 })
            Text('è‡£çŠ¯å›å¤§å¿Œ')
              .fontSize(12)
              .fontColor('#f44336')
              .fontWeight(FontWeight.Bold)
          }
          .padding({ left: 10, right: 10, top: 5, bottom: 5 })
          .backgroundColor('#ffebee')
          .borderRadius(14)
          .margin({ right: 8, bottom: 8 })
          .border({ width: 1, color: '#f44336' })
        }

        // 15.xæ—¶é—´è¶‹åŠ¿æ ‡ç­¾
        ForEach(this.timeTrendTags, (tag: TimeRiskTag) => {
          Row() {
            Text('âš ï¸')
              .fontSize(14)
              .margin({ right: 4 })
            Text(tag.label)
              .fontSize(12)
              .fontColor('#666666')
          }
          .padding({ left: 10, right: 10, top: 5, bottom: 5 })
          .backgroundColor('#f5f5f5')
          .borderRadius(14)
          .margin({ right: 8, bottom: 8 })
          .border({ width: 1, color: '#e0e0e0' })
        }, (tag: TimeRiskTag) => tag.id)
      }
      .width('100%')

      // ç®€è¦è¯´æ˜
      if (this.dayLevelInfo!.recommendation) {
        Text('ğŸ’¡ ' + this.dayLevelInfo!.recommendation)
          .fontSize(11)
          .fontColor('#2196f3')
          .width('100%')
          .margin({ top: 10 })
          .lineHeight(16)
      }
    }
    .width('100%')
    .padding(16)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .margin({ left: 16, right: 16, bottom: 16 })
  }

  @Builder
  UseGodPicker() {
    Column() {
      Scroll() {
        Column() {
          ForEach(this.starGroups, (group: StarGroup) => {
            Column() {
              Text(group.name)
                .fontSize(13)
                .fontWeight(FontWeight.Bold)
                .fontColor('#666666')
                .width('100%')
                .margin({ top: 16, bottom: 8, left: 16 })

              Grid() {
                ForEach(group.stars, (star: string) => {
                  GridItem() {
                    Column() {
                      Text(this.starEmojiMap[star] || 'âœ¨')
                        .fontSize(24)
                      Text(star)
                        .fontSize(12)
                        .fontColor(this.selectedUseGodStar === star ? '#ffffff' : '#333333')
                        .margin({ top: 4 })
                    }
                    .width('100%')
                    .padding({ top: 10, bottom: 10 })
                    .backgroundColor(this.selectedUseGodStar === star ? '#d32f2f' : '#ffffff')
                    .borderRadius(12)
                    .border({ width: 1, color: this.selectedUseGodStar === star ? '#d32f2f' : '#eeeeee' })
                    .onClick(() => {
                      this.selectedUseGodStar = star;
                      this.isShowUseGodSheet = false;
                    })
                  }
                })
              }
              .columnsTemplate('1fr 1fr 1fr 1fr')
              .columnsGap(8)
              .rowsGap(8)
              .padding({ left: 16, right: 16 })
              .height(160)
            }
          })
          
          Row().height(40).width('100%')
        }
        .width('100%')
      }
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Auto)
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f7f7f7')
  }
}
