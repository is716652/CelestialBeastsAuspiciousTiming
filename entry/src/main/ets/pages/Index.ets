import { common } from '@kit.AbilityKit';
import { buffer, JSON as ArkJSON } from '@kit.ArkTS';
import { router } from '@kit.ArkUI';
import { CalendarManager } from '../utils/CalendarManager';

// ============== Êé•Âè£ÂÆö‰πâ ==============

interface ConstellationInfo {
  full_name: string;
  element: string;
}

interface YearStarRules {
  base_year: number;
  base_star: string;
}

interface MonthStarRules {
  element_to_start_star: Record<string, string>;
}

interface DayStarBaseDate {
  date: string;
}

interface DayStarRules {
  base_date: DayStarBaseDate;
  four_generals: Record<string, Array<string>>;
}

interface HourStarRules {
  element_to_start_star: Record<string, string>;
}

interface YanqinStarRulesConfig {
  constellations_order: Array<string>;
  constellations_full: Record<string, ConstellationInfo>;
  year_star_rules: YearStarRules;
  month_star_rules: MonthStarRules;
  day_star_rules: DayStarRules;
  hour_star_rules: HourStarRules;
}

interface StarCalcResult {
  star: string;
  fullName: string;
  element: string;
}

interface DayStarCalcResult {
  star: string;
  fullName: string;
  element: string;
  yuanName: string;
  jiangIndex: number;
  jiangStar: string;
}

@Entry
@Component
struct Index {
  private context = getContext(this) as common.Context;

  @State hasLoaded: boolean = false;
  @State starRulesConfig: YanqinStarRulesConfig | null = null;

  @State selectedYear: number = new Date().getFullYear();
  @State selectedMonth: number = new Date().getMonth() + 1;
  @State selectedDay: number = new Date().getDate();
  @State selectedHourIndex: number = this.getCurrentHourIndex();

  @State yearOptions: SelectOption[] = [];
  @State monthOptions: SelectOption[] = [];
  @State dayOptions: SelectOption[] = [];
  @State hourOptions: SelectOption[] = [];

  private getCurrentHourIndex(): number {
    const hour = new Date().getHours();
    if (hour >= 23 || hour < 1) return 0;
    if (hour >= 1 && hour < 3) return 1;
    if (hour >= 3 && hour < 5) return 2;
    if (hour >= 5 && hour < 7) return 3;
    if (hour >= 7 && hour < 9) return 4;
    if (hour >= 9 && hour < 11) return 5;
    if (hour >= 11 && hour < 13) return 6;
    if (hour >= 13 && hour < 15) return 7;
    if (hour >= 15 && hour < 17) return 8;
    if (hour >= 17 && hour < 19) return 9;
    if (hour >= 19 && hour < 21) return 10;
    return 11;
  }

  aboutToAppear(): void {
    this.initOptions();
    CalendarManager.getInstance().init(this.context);
    this.initData();
  }

  private initOptions(): void {
    // Âπ¥‰ªΩÈÄâÈ°π
    const years: SelectOption[] = [];
    for (let y = 1900; y <= 2061; y++) {
      const opt: SelectOption = { value: `${y}Âπ¥` };
      years.push(opt);
    }
    this.yearOptions = years;

    // Êúà‰ªΩÈÄâÈ°π
    const months: SelectOption[] = [];
    for (let m = 1; m <= 12; m++) {
      const opt: SelectOption = { value: `${m}Êúà` };
      months.push(opt);
    }
    this.monthOptions = months;

    // Êó•ÊúüÈÄâÈ°π
    this.updateDayOptions();

    // Êó∂Ëæ∞ÈÄâÈ°π
    const branches = ['Â≠ê', '‰∏ë', 'ÂØÖ', 'ÂçØ', 'Ëæ∞', 'Â∑≥', 'Âçà', 'Êú™', 'Áî≥', 'ÈÖâ', 'Êàå', '‰∫•'];
    const times = ['23-01', '01-03', '03-05', '05-07', '07-09', '09-11', '11-13', '13-15', '15-17', '17-19', '19-21', '21-23'];
    const hours: SelectOption[] = [];
    for (let i = 0; i < 12; i++) {
      const opt: SelectOption = { value: `${branches[i]}Êó∂ (${times[i]}ÁÇπ)` };
      hours.push(opt);
    }
    this.hourOptions = hours;
  }

  private updateDayOptions(): void {
    const daysInMonth = new Date(this.selectedYear, this.selectedMonth, 0).getDate();
    const days: SelectOption[] = [];
    for (let d = 1; d <= daysInMonth; d++) {
      const opt: SelectOption = { value: `${d}Êó•` };
      days.push(opt);
    }
    this.dayOptions = days;
    if (this.selectedDay > daysInMonth) {
      this.selectedDay = daysInMonth;
    }
  }

  private async initData(): Promise<void> {
    const starRules = await this.loadJsonFromRaw<YanqinStarRulesConfig>('yanqin_star_rules.json');
    if (starRules) {
      this.starRulesConfig = starRules;
      this.hasLoaded = true;
    }
  }

  private async loadJsonFromRaw<T>(fileName: string): Promise<T | null> {
    try {
      const value = await this.context.resourceManager.getRawFileContent(fileName);
      const str = buffer.from(value.buffer).toString();
      return ArkJSON.parse(str) as T;
    } catch (err) {
      console.error('Failed to load: ' + fileName + ', error: ' + JSON.stringify(err));
      return null;
    }
  }

  // ============== ÂõõÁ¶ΩËÆ°ÁÆóÁÆóÊ≥ï ==============

  private calculateYearStar(year: number, cfg: YanqinStarRulesConfig): StarCalcResult {
    const constellations = cfg.constellations_order;
    const baseYear = cfg.year_star_rules.base_year;
    const baseStar = cfg.year_star_rules.base_star;
    const baseIndex = constellations.indexOf(baseStar);

    const yearDiff = year - baseYear;
    const starIndex = ((yearDiff % 28) + 28 + baseIndex) % 28;
    const star = constellations[starIndex];
    const info = cfg.constellations_full[star];

    const result: StarCalcResult = {
      star: star,
      fullName: info.full_name,
      element: info.element
    };
    return result;
  }

  private calculateDayStar(year: number, month: number, day: number, cfg: YanqinStarRulesConfig): DayStarCalcResult {
    const constellations = cfg.constellations_order;
    const dayRules = cfg.day_star_rules;

    // Ëß£ÊûêÂü∫ÂáÜÊó•ÊúüÂ≠óÁ¨¶‰∏≤ "1984-02-02"
    const baseDateStr = dayRules.base_date.date;
    const baseParts = baseDateStr.split('-');
    const baseYear = parseInt(baseParts[0]);
    const baseMonth = parseInt(baseParts[1]);
    const baseDay = parseInt(baseParts[2]);
    
    // Áªü‰∏Ä‰ΩøÁî®Êú¨Âú∞Êó∂Èó¥ÂàõÂª∫ Date ÂØπË±°ÔºåÈÅøÂÖçÊó∂Âå∫ÈóÆÈ¢ò
    const baseDate = new Date(baseYear, baseMonth - 1, baseDay);
    const targetDate = new Date(year, month - 1, day);

    const diffTime = targetDate.getTime() - baseDate.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    const posInCycle = ((diffDays % 420) + 420) % 420;
    const yuanIndex = Math.floor(posInCycle / 60);
    const posInYuan = posInCycle % 60;
    const jiangIndex = Math.floor(posInYuan / 15);
    const dayInJiang = posInYuan % 15;

    const yuanNames = ['‰∏ÄÂÖÉ', '‰∫åÂÖÉ', '‰∏âÂÖÉ', 'ÂõõÂÖÉ', '‰∫îÂÖÉ', 'ÂÖ≠ÂÖÉ', '‰∏ÉÂÖÉ'];
    const yuanName = yuanNames[yuanIndex];
    const jiangStars = dayRules.four_generals[yuanName];
    const jiangStar = jiangStars[jiangIndex];

    const jiangStarIndex = constellations.indexOf(jiangStar);
    const dayStarIndex = (jiangStarIndex + dayInJiang) % 28;
    const star = constellations[dayStarIndex];
    const info = cfg.constellations_full[star];

    const result: DayStarCalcResult = {
      star: star,
      fullName: info.full_name,
      element: info.element,
      yuanName: yuanName,
      jiangIndex: jiangIndex + 1,
      jiangStar: jiangStar  // ËøîÂõûÂõõÂ∞ÜÁ¨¶Â§¥
    };
    return result;
  }

  private getDateString(): string {
    return `${this.selectedYear}Âπ¥${this.selectedMonth}Êúà${this.selectedDay}Êó•`;
  }

  // ============== UI ÊûÑÂª∫ ==============

  build() {
    Scroll() {
      Column() {
        // È°∂ÈÉ®Ê†áÈ¢ò
        Column() {
          Text('Á¶ΩÊòüÊºîÂØª')
            .fontSize(32)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1a1a1a')
          Text('‰º†ÁªüÊºîÁ¶ΩÊúØ ¬∑ Êï∞Â≠óÂåñÁ†î‰π†Âπ≥Âè∞')
            .fontSize(14)
            .fontColor('#666666')
            .margin({ top: 8 })
        }
        .width('100%')
        .padding({ top: 60, bottom: 30 })
        .alignItems(HorizontalAlign.Center)

        if (this.hasLoaded) {
          // ========== Êó•ÊúüÂø´ÈÄüÈ¢ÑËßà/ÈÄâÊã© ==========
          Column() {
            Row() {
              Text('üìÖ ÂΩìÂâçÈÄâÂÆö')
                .fontSize(15)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
              Blank()
              Text(this.getDateString())
                .fontSize(14)
                .fontColor('#3d6b4f')
                .fontWeight(FontWeight.Bold)
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 12, bottom: 12 })
            .backgroundColor('#ffffff')
            .borderRadius(14)
            .margin({ bottom: 20 })
            .border({ width: 1, color: '#e0e0e0' })
          }
          .padding({ left: 16, right: 16 })

          // ========== Ê†∏ÂøÉÂäüËÉΩÂÖ•Âè£ (2ÂàóÁΩëÊ†º) ==========
          Grid() {
            GridItem() {
              this.MenuCard('üìç', 'Êñπ‰ΩçÊé®Êºî', 'Ëµ∞Â§±ÂØªÁâ©¬∑ÂèñË±°', '#3d6b4f', '#f5f9f6', 'pages/LostItemsSearch')
            }
            GridItem() {
              this.MenuCard('üìÖ', 'ÊºîÁ¶ΩÁõòÂºè', '‰∏â‰º†ÂõõËØæ¬∑ÊéíÁõò', '#1a5276', '#e8f4fc', 'pages/YanQinPanShi')
            }
            GridItem() {
              this.MenuCard('üåå', 'ÊºîÁ¶ΩÊ∞îË±°', 'Â§©Êó∂È¢ÑÊµã¬∑Êô¥Èõ®', '#0369a1', '#f0f9ff', 'pages/WeatherMeteorology')
            }
            GridItem() {
              this.MenuCard('üèóÔ∏è', 'ÊºîÁ¶ΩÈÄ†Ëë¨', 'ÊñΩÂ∑•Âä®Âúü¬∑ÈÅøÂøå', '#7c2d12', '#fff7ed', 'pages/ConstructionBurial')
            }
            GridItem() {
              this.MenuCard('üìö', 'Áü•ËØÜÁÇπ‰∏éÊ°à‰æãÂ∫ì', 'È´òÈò∂ËßÑÂàô¬∑Ê°à‰æã', '#4c1d95', '#f5f3ff', 'pages/AdvancedStudyCases')
            }
            GridItem() {
              this.MenuCard('üìù', 'Â≠¶‰π†ÊñáÊ°£', 'ÂàÜÁ∫ßÂ≠¶‰π†Ë∑ØÂæÑ', '#1f2937', '#f3f4f6', 'pages/AdvancedStudyCases')
            }
          }
          .columnsTemplate('1fr 1fr')
          .columnsGap(12)
          .rowsGap(12)
          .padding({ left: 16, right: 16, bottom: 30 })
          .width('100%')
          .height(420)
        } else {
          // Âä†ËΩΩ‰∏≠
          Column() {
            LoadingProgress()
              .width(40)
              .height(40)
              .color('#888888')
            Text('Ê≠£Âú®Âä†ËΩΩÈÖçÁΩÆ...')
              .fontSize(14)
              .fontColor('#888888')
              .margin({ top: 12 })
          }
          .width('100%')
          .padding({ top: 60 })
          .alignItems(HorizontalAlign.Center)
        }

        // Â∫ïÈÉ®ÁâàÊú¨‰ø°ÊÅØ
        Text('Version 1.2.0 ¬∑ ‰º†ÁªüÊñáÂåñÊï∞Â≠óÂåñ')
          .fontSize(10)
          .fontColor('#cccccc')
          .margin({ bottom: 20 })
      }
      .width('100%')
      .constraintSize({ minHeight: '100%' })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f2f1ed')
    .scrollBar(BarState.Off)
  }

  @Builder
  MenuCard(icon: string, title: string, desc: string, color: string, bgColor: string, url: string) {
    Column() {
      Text(icon)
        .fontSize(32)
        .margin({ bottom: 8 })
      Text(title)
        .fontSize(16)
        .fontWeight(FontWeight.Bold)
        .fontColor(color)
      Text(desc)
        .fontSize(10)
        .fontColor('#666666')
        .margin({ top: 4 })
    }
    .width('100%')
    .height(130)
    .justifyContent(FlexAlign.Center)
    .backgroundColor(bgColor)
    .borderRadius(16)
    .border({ width: 1, color: color, style: BorderStyle.Solid })
    .onClick(() => {
      router.pushUrl({
        url: url,
        params: {
          year: this.selectedYear,
          month: this.selectedMonth,
          day: this.selectedDay,
          hourIndex: this.selectedHourIndex
        }
      });
    })
  }
}
