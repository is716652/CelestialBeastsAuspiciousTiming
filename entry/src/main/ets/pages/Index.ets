import { common } from '@kit.AbilityKit';
import { buffer, JSON as ArkJSON } from '@kit.ArkTS';
import { router } from '@kit.ArkUI';
import { CalendarManager } from '../utils/CalendarManager';

// ============== æ¥å£å®šä¹‰ ==============

interface ConstellationInfo {
  full_name: string;
  element: string;
}

interface YearStarRules {
  base_year: number;
  base_star: string;
}

interface MonthStarRules {
  element_to_start_star: Record<string, string>;
}

interface DayStarBaseDate {
  date: string;
}

interface DayStarRules {
  base_date: DayStarBaseDate;
  four_generals: Record<string, Array<string>>;
}

interface HourStarRules {
  element_to_start_star: Record<string, string>;
}

interface YanqinStarRulesConfig {
  constellations_order: Array<string>;
  constellations_full: Record<string, ConstellationInfo>;
  year_star_rules: YearStarRules;
  month_star_rules: MonthStarRules;
  day_star_rules: DayStarRules;
  hour_star_rules: HourStarRules;
}

interface StarCalcResult {
  star: string;
  fullName: string;
  element: string;
}

interface DayStarCalcResult {
  star: string;
  fullName: string;
  element: string;
  yuanName: string;
  jiangIndex: number;
  jiangStar: string;
}

@Entry
@Component
struct Index {
  private context = getContext(this) as common.Context;

  @State hasLoaded: boolean = false;
  @State starRulesConfig: YanqinStarRulesConfig | null = null;
  @State dayStarResult: DayStarCalcResult | null = null;

  private starEmojiMap: Record<string, string> = {
    'è§’': 'ğŸ‰', 'äº¢': 'ğŸ²', 'æ°': 'ğŸ¦¡', 'æˆ¿': 'ğŸ°', 'å¿ƒ': 'ğŸ¦Š', 'å°¾': 'ğŸ¯', 'ç®µ': 'ğŸ†',
    'æ–—': 'ç¬', 'ç‰›': 'ğŸ‚', 'å¥³': 'è™', 'è™š': 'ğŸ€', 'å±': 'ğŸ•Šï¸', 'å®¤': 'ğŸ–', 'å£': 'ğŸ¦Œ',
    'å¥': 'ğŸº', 'å¨„': 'ğŸ•', 'èƒƒ': 'é›‰', 'æ˜‚': 'ğŸ“', 'æ¯•': 'ğŸ¦', 'è§œ': 'ğŸ’', 'å‚': 'ğŸ¦',
    'äº•': 'ğŸ•', 'é¬¼': 'ğŸ', 'æŸ³': 'ğŸ¦Œ', 'æ˜Ÿ': 'ğŸ', 'å¼ ': 'ğŸ¦Œ', 'ç¿¼': 'ğŸ', 'è½¸': 'ğŸ›'
  };

  private starToSymbolMap: Record<string, string> = {
    'è§’': 'ä¸œæ–¹é’é¾™', 'äº¢': 'ä¸œæ–¹é’é¾™', 'æ°': 'ä¸œæ–¹é’é¾™', 'æˆ¿': 'ä¸œæ–¹é’é¾™', 'å¿ƒ': 'ä¸œæ–¹é’é¾™', 'å°¾': 'ä¸œæ–¹é’é¾™', 'ç®•': 'ä¸œæ–¹é’é¾™',
    'æ–—': 'åŒ—æ–¹ç„æ­¦', 'ç‰›': 'åŒ—æ–¹ç„æ­¦', 'å¥³': 'åŒ—æ–¹ç„æ­¦', 'è™š': 'åŒ—æ–¹ç„æ­¦', 'å±': 'åŒ—æ–¹ç„æ­¦', 'å®¤': 'åŒ—æ–¹ç„æ­¦', 'å£': 'åŒ—æ–¹ç„æ­¦',
    'å¥': 'è¥¿æ–¹ç™½è™', 'å¨„': 'è¥¿æ–¹ç™½è™', 'èƒƒ': 'è¥¿æ–¹ç™½è™', 'æ˜´': 'è¥¿æ–¹ç™½è™', 'æ¯•': 'è¥¿æ–¹ç™½è™', 'è§œ': 'è¥¿æ–¹ç™½è™', 'å‚': 'è¥¿æ–¹ç™½è™',
    'äº•': 'å—æ–¹æœ±é›€', 'é¬¼': 'å—æ–¹æœ±é›€', 'æŸ³': 'å—æ–¹æœ±é›€', 'æ˜Ÿ': 'å—æ–¹æœ±é›€', 'å¼ ': 'å—æ–¹æœ±é›€', 'ç¿¼': 'å—æ–¹æœ±é›€', 'è½¸': 'å—æ–¹æœ±é›€'
  };

  @State selectedYear: number = new Date().getFullYear();
  @State selectedMonth: number = new Date().getMonth() + 1;
  @State selectedDay: number = new Date().getDate();
  @State selectedHourIndex: number = this.getCurrentHourIndex();

  @State yearOptions: SelectOption[] = [];
  @State monthOptions: SelectOption[] = [];
  @State dayOptions: SelectOption[] = [];
  @State hourOptions: SelectOption[] = [];

  private getCurrentHourIndex(): number {
    const hour = new Date().getHours();
    if (hour >= 23 || hour < 1) return 0;
    if (hour >= 1 && hour < 3) return 1;
    if (hour >= 3 && hour < 5) return 2;
    if (hour >= 5 && hour < 7) return 3;
    if (hour >= 7 && hour < 9) return 4;
    if (hour >= 9 && hour < 11) return 5;
    if (hour >= 11 && hour < 13) return 6;
    if (hour >= 13 && hour < 15) return 7;
    if (hour >= 15 && hour < 17) return 8;
    if (hour >= 17 && hour < 19) return 9;
    if (hour >= 19 && hour < 21) return 10;
    return 11;
  }

  aboutToAppear(): void {
    this.initOptions();
    CalendarManager.getInstance().init(this.context);
    this.initData();
  }

  private initOptions(): void {
    // å¹´ä»½é€‰é¡¹
    const years: SelectOption[] = [];
    for (let y = 1900; y <= 2061; y++) {
      const opt: SelectOption = { value: `${y}å¹´` };
      years.push(opt);
    }
    this.yearOptions = years;

    // æœˆä»½é€‰é¡¹
    const months: SelectOption[] = [];
    for (let m = 1; m <= 12; m++) {
      const opt: SelectOption = { value: `${m}æœˆ` };
      months.push(opt);
    }
    this.monthOptions = months;

    // æ—¥æœŸé€‰é¡¹
    this.updateDayOptions();

    // æ—¶è¾°é€‰é¡¹
    const branches = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
    const times = ['23-01', '01-03', '03-05', '05-07', '07-09', '09-11', '11-13', '13-15', '15-17', '17-19', '19-21', '21-23'];
    const hours: SelectOption[] = [];
    for (let i = 0; i < 12; i++) {
      const opt: SelectOption = { value: `${branches[i]}æ—¶ (${times[i]}ç‚¹)` };
      hours.push(opt);
    }
    this.hourOptions = hours;
  }

  private updateDayOptions(): void {
    const daysInMonth = new Date(this.selectedYear, this.selectedMonth, 0).getDate();
    const days: SelectOption[] = [];
    for (let d = 1; d <= daysInMonth; d++) {
      const opt: SelectOption = { value: `${d}æ—¥` };
      days.push(opt);
    }
    this.dayOptions = days;
    if (this.selectedDay > daysInMonth) {
      this.selectedDay = daysInMonth;
    }
  }

  private async initData(): Promise<void> {
    const starRules = await this.loadJsonFromRaw<YanqinStarRulesConfig>('yanqin_star_rules.json');
    if (starRules) {
      this.starRulesConfig = starRules;
      this.dayStarResult = this.calculateDayStar(this.selectedYear, this.selectedMonth, this.selectedDay, starRules);
      this.hasLoaded = true;
    }
  }

  private async loadJsonFromRaw<T>(fileName: string): Promise<T | null> {
    try {
      const value = await this.context.resourceManager.getRawFileContent(fileName);
      const str = buffer.from(value.buffer).toString();
      return ArkJSON.parse(str) as T;
    } catch (err) {
      console.error('Failed to load: ' + fileName + ', error: ' + JSON.stringify(err));
      return null;
    }
  }

  // ============== å››ç¦½è®¡ç®—ç®—æ³• ==============

  private calculateYearStar(year: number, cfg: YanqinStarRulesConfig): StarCalcResult {
    const constellations = cfg.constellations_order;
    const baseYear = cfg.year_star_rules.base_year;
    const baseStar = cfg.year_star_rules.base_star;
    const baseIndex = constellations.indexOf(baseStar);

    const yearDiff = year - baseYear;
    const starIndex = ((yearDiff % 28) + 28 + baseIndex) % 28;
    const star = constellations[starIndex];
    const info = cfg.constellations_full[star];

    const result: StarCalcResult = {
      star: star,
      fullName: info.full_name,
      element: info.element
    };
    return result;
  }

  private calculateDayStar(year: number, month: number, day: number, cfg: YanqinStarRulesConfig): DayStarCalcResult {
    const constellations = cfg.constellations_order;
    const dayRules = cfg.day_star_rules;

    // è§£æåŸºå‡†æ—¥æœŸå­—ç¬¦ä¸² "1984-02-02"
    const baseDateStr = dayRules.base_date.date;
    const baseParts = baseDateStr.split('-');
    const baseYear = parseInt(baseParts[0]);
    const baseMonth = parseInt(baseParts[1]);
    const baseDay = parseInt(baseParts[2]);
    
    // ç»Ÿä¸€ä½¿ç”¨æœ¬åœ°æ—¶é—´åˆ›å»º Date å¯¹è±¡ï¼Œé¿å…æ—¶åŒºé—®é¢˜
    const baseDate = new Date(baseYear, baseMonth - 1, baseDay);
    const targetDate = new Date(year, month - 1, day);

    const diffTime = targetDate.getTime() - baseDate.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    const posInCycle = ((diffDays % 420) + 420) % 420;
    const yuanIndex = Math.floor(posInCycle / 60);
    const posInYuan = posInCycle % 60;
    const jiangIndex = Math.floor(posInYuan / 15);
    const dayInJiang = posInYuan % 15;

    const yuanNames = ['ä¸€å…ƒ', 'äºŒå…ƒ', 'ä¸‰å…ƒ', 'å››å…ƒ', 'äº”å…ƒ', 'å…­å…ƒ', 'ä¸ƒå…ƒ'];
    const yuanName = yuanNames[yuanIndex];
    const jiangStars = dayRules.four_generals[yuanName];
    const jiangStar = jiangStars[jiangIndex];

    const jiangStarIndex = constellations.indexOf(jiangStar);
    const dayStarIndex = (jiangStarIndex + dayInJiang) % 28;
    const star = constellations[dayStarIndex];
    const info = cfg.constellations_full[star];

    const result: DayStarCalcResult = {
      star: star,
      fullName: info.full_name,
      element: info.element,
      yuanName: yuanName,
      jiangIndex: jiangIndex + 1,
      jiangStar: jiangStar  // è¿”å›å››å°†ç¬¦å¤´
    };
    return result;
  }

  private getDateString(): string {
    return `${this.selectedYear}å¹´${this.selectedMonth}æœˆ${this.selectedDay}æ—¥`;
  }

  // ============== UI æ„å»º ==============

  build() {
    Scroll() {
      Column() {
        if (this.hasLoaded && this.dayStarResult) {
          // ========== é¡¶éƒ¨ï¼šç¥ç§˜æ¼”ç¦½å¤©ç›˜ (Celestial Disk) ==========
          Stack() {
            // 1. æ²‰æµ¸å¼æ˜Ÿç©ºèƒŒæ™¯å›¾
            Image($r('app.media.qinxing_celestial_bg'))
              .width('100%')
              .height('100%')
              .objectFit(ImageFit.Cover)
            
            // 2. æ ¸å¿ƒä¿¡æ¯å±•ç¤ºå±‚
            Column() {
              // æ—¥ç¦½ï¼š[å…¨ç§°]
              Text('æ—¥ç¦½ Â· ' + this.dayStarResult.fullName)
                .fontSize(36)
                .fontWeight(FontWeight.Bolder)
                .fontColor('#ffffff')
                .shadow({ radius: 20, color: '#000000', offsetX: 4, offsetY: 4 })
              
              // æœ¯è¯­å½’å± (ä¸œæ–¹é’é¾™/åŒ—æ–¹ç„æ­¦ ç­‰)
              Text(this.starToSymbolMap[this.dayStarResult.star] || '')
                .fontSize(20)
                .fontWeight(FontWeight.Medium)
                .fontColor('#d4af37') // å¤å…¸é‡‘ï¼Œä¸æ˜Ÿå›¾è´¨æ„ŸåŒ¹é…
                .margin({ top: 15 })
                .shadow({ radius: 10, color: '#000000', offsetX: 2, offsetY: 2 })

              // é€‰å®šæ—¥æœŸ
              Text(this.getDateString())
                .fontSize(14)
                .fontColor('#ffffff') // çº¯ç™½è‰²æ–‡å­—
                .margin({ top: 40 })
                .padding({ left: 18, right: 18, top: 8, bottom: 8 })
                .backgroundColor('#00000088') // æ·±é»‘è‰²åŠé€æ˜èƒŒæ™¯ï¼Œç¡®ä¿å¯¹æ¯”åº¦
                .borderRadius(20)
                .border({ width: 0.5, color: '#ffffff44' })
            }
            .width('100%')
          }
          .width('100%')
          .height(420)
          .clip(true)

          // ========== åŠŸèƒ½å¯¼èˆªåŒºåŸŸ ==========
          Column() {
            Text('â€”â€” æ¼”ç¦½ç§˜è¦ Â· åŠŸæ³•æ¨¡å— â€”â€”')
              .fontSize(13)
              .fontColor('#666666')
              .margin({ top: 20, bottom: 20 })

            Grid() {
              GridItem() {
                this.MenuCard('ğŸ“', 'æ–¹ä½æ¨æ¼”', 'å¯»ç‰©å æµ‹', '#3d6b4f', 'pages/LostItemsSearch')
              }
              GridItem() {
                this.MenuCard('ğŸ§­', 'æ¼”ç¦½ç›˜å¼', 'ä¸‰ä¼ å››è¯¾', '#1a5276', 'pages/YanQinPanShi')
              }
              GridItem() {
                this.MenuCard('â˜ï¸', 'æ¼”ç¦½æ°”è±¡', 'å¤©æ—¶å é›¨', '#0284c7', 'pages/WeatherMeteorology')
              }
              GridItem() {
                this.MenuCard('ğŸ—ï¸', 'æ¼”ç¦½é€ è‘¬', 'åŠ¨åœŸæ‹©å‰', '#b45309', 'pages/ConstructionBurial')
              }
            }
            .columnsTemplate('1fr 1fr')
            .columnsGap(15)
            .rowsGap(15)
            .padding({ left: 20, right: 20 })
            .width('100%')
            .height(240)

            // åº•éƒ¨æ¬¡çº§æ¨¡å—
            Row() {
              this.SmallActionCard('æ¡ˆä¾‹åº“', 'pages/AdvancedStudyCases')
              this.SmallActionCard('çŸ¥è¯†å›¾è°±', 'pages/KnowledgeGraph')
            }
            .width('100%')
            .padding({ left: 20, right: 20, top: 20 })
            .margin({ bottom: 40 })
          }
          .width('100%')
          .backgroundColor('#f8f8f8') // ä¸‹æ–¹åŠŸèƒ½åŒºå›å½’æµ…è‰²ï¼Œå¯¹æ¯”å‡ºå¤©ç›˜çš„æ·±é‚ƒ
          .borderRadius({ topLeft: 30, topRight: 30 }) // åœ†æ ¼è¿‡æ¸¡
          .margin({ top: -30 }) // ä¸å¤©ç›˜è¡”æ¥

        } else {
          // åŠ è½½ä¸­
          Column() {
            LoadingProgress().width(40).height(40).color('#3d6b4f')
            Text('å¼€å¯æ¼”ç¦½ç§˜å¢ƒ...').fontSize(14).fontColor('#666666').margin({ top: 12 })
          }
          .width('100%')
          .height('100%')
          .justifyContent(FlexAlign.Center)
        }

        // åº•éƒ¨ç‰ˆæœ¬ä¿¡æ¯
        Text('Version 1.2.0 Â· ä¼ ç»Ÿæ–‡åŒ–æ•°å­—åŒ–')
          .fontSize(10)
          .fontColor('#cccccc')
          .margin({ bottom: 20 })
      }
      .width('100%')
      .constraintSize({ minHeight: '100%' })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f2f1ed')
    .scrollBar(BarState.Off)
  }

  @Builder
  SmallActionCard(title: string, url: string) {
    Column() {
      // æ ¹æ®æ ‡é¢˜æ¡ä»¶æ¸²æŸ“å›¾æ ‡
      if (title === 'çŸ¥è¯†å›¾è°±') {
        Image($r('app.media.knowledge_graph_icon'))
          .width(40)
          .height(40)
          .borderRadius(8)
          .margin({ bottom: 6 })
      } else if (title === 'æ¡ˆä¾‹åº“') {
        Image($r('app.media.case_library_icon'))
          .width(40)
          .height(40)
          .borderRadius(8)
          .margin({ bottom: 6 })
      }

      Text(title)
        .fontSize(13)
        .fontWeight(FontWeight.Medium)
        .fontColor('#555555')
    }
    .layoutWeight(1)
    .height(80)
    .margin({ left: 4, right: 4 })
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#ffffff')
    .borderRadius(12)
    .border({ width: 1, color: '#e0e0e0' })
    .onClick(() => {
      router.pushUrl({ url: url })
    })
  }

  @Builder
  MenuCard(icon: string, title: string, desc: string, color: string, url: string) {
    Column() {
      // æ‰€æœ‰åŠŸèƒ½å¡ç‰‡å‡ä½¿ç”¨å›¾ç‰‡å›¾æ ‡
      if (title === 'æ¼”ç¦½ç›˜å¼') {
        Image($r('app.media.yanqin_pan_icon'))
          .width(50)
          .height(50)
          .borderRadius(25)
          .margin({ bottom: 6 })
      } else if (title === 'æ¼”ç¦½æ°”è±¡') {
        Image($r('app.media.weather_icon'))
          .width(50)
          .height(50)
          .borderRadius(25)
          .margin({ bottom: 6 })
      } else if (title === 'æ¼”ç¦½é€ è‘¬') {
        Image($r('app.media.fengshui_icon'))
          .width(50)
          .height(50)
          .borderRadius(25)
          .margin({ bottom: 6 })
      } else if (title === 'æ–¹ä½æ¨æ¼”') {
        Image($r('app.media.lost_items_icon'))
          .width(50)
          .height(50)
          .borderRadius(25)
          .margin({ bottom: 6 })
      } else {
        Text(icon)
          .fontSize(28)
          .margin({ bottom: 6 })
      }
      
      Text(title)
        .fontSize(15)
        .fontWeight(FontWeight.Bold)
        .fontColor('#333333')
      Text(desc)
        .fontSize(10)
        .fontColor('#999999')
        .margin({ top: 4 })
    }
    .width('100%')
    .height(110) // è°ƒé«˜ä»¥é€‚åº”å›¾ç‰‡
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#ffffff')
    .borderRadius(18)
    .shadow({ radius: 8, color: '#00000005', offsetX: 0, offsetY: 2 })
    .border({ width: 1, color: '#f0f0f0' })
    .onClick(() => {
      router.pushUrl({
        url: url,
        params: {
          year: this.selectedYear,
          month: this.selectedMonth,
          day: this.selectedDay,
          hourIndex: this.selectedHourIndex
        }
      });
    })
  }
}
