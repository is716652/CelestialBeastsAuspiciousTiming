import { common } from '@kit.AbilityKit';
import { buffer, JSON as ArkJSON } from '@kit.ArkTS';
import { router } from '@kit.ArkUI';
import { CalendarManager, CalendarDayInfo } from '../utils/CalendarManager';
import { calcTimeTrendFromCalendar, TimeRiskTag } from '../utils/Knowledge15x';

// ============== Êé•Âè£ÂÆö‰πâ ==============

interface ConstellationInfo {
  full_name: string;
  element: string;
  animal: string;
}

interface YearStarRules {
  base_year: number;
  base_star: string;
}

interface MonthStarRules {
  element_to_start_star: Record<string, string>;
}

interface DayStarBaseDate {
  date: string;
  yuan: number;
  jiang: number;
  star: string;
}

interface SevenYuanHeads {
  list: Array<string>;
}

interface DayStarRules {
  cycle_days: number;
  yuan_days: number;
  jiang_days: number;
  seven_yuan_heads: SevenYuanHeads;
  four_generals: Record<string, Array<string>>;
  base_date: DayStarBaseDate;
}

interface HourStarRules {
  element_to_start_star: Record<string, string>;
}

interface HourTimeRange {
  start: string;
  end: string;
  index: number;
}

interface YanqinStarRulesConfig {
  constellations_order: Array<string>;
  constellations_full: Record<string, ConstellationInfo>;
  branches_order: Array<string>;
  year_star_rules: YearStarRules;
  month_star_rules: MonthStarRules;
  day_star_rules: DayStarRules;
  hour_star_rules: HourStarRules;
  hour_time_ranges: Record<string, HourTimeRange>;
  four_symbols: FourSymbols;
  use_god_hints: UseGodHints;
  huo_yao_rules: HuoYaoRules;
  qin_classification: QinClassification;
  tun_dan: TunDanConfig;
  ri_ye_qin: RiYeQinConfig;
}

interface LostItemUseGod {
  category: string;
  star: string;
  note: string;
}

interface LostItemsConfig {
  constellations_order: Array<string>;
  branches_order: Array<string>;
  use_gods: Array<LostItemUseGod>;
}

interface FourSymbolGroup {
  name: string;
  color: string;
  stars: Array<string>;
}

interface FourSymbols {
  description: string;
  groups: Array<FourSymbolGroup>;
}

interface UseGodHints {
  description: string;
  hints: Record<string, string>;
}

// ============== ÊºîÁ¶ΩÁõòÂºèÁõ∏ÂÖ≥Êé•Âè£ ==============

interface HuoYaoRules {
  description: string;
  element_to_flip_star: Record<string, string>;
  start_branch: string;
}

interface QinClassification {
  description: string;
  Â§©Á¶Ω: Array<string>;
  Âú∞Á¶Ω: Array<string>;
  Ê∞¥Á¶Ω: Array<string>;
  ÂÆ∂Á¶Ω: Array<string>;
  rules: Record<string, string>;
}

interface WuShiConfig {
  list: Array<string>;
}

interface TunDanConfig {
  description: string;
  food_map: Record<string, Array<string>>;
  wu_shi: WuShiConfig;
  animal_to_star: Record<string, string>;
}

interface RiYeQinConfig {
  description: string;
  Êó•Á¶Ω: Array<string>;
  Â§úÁ¶Ω: Array<string>;
  Êó•Â§úÈÄöÁî®: Array<string>;
  rules: Record<string, string>;
}

// ============== ÈîÅÊ≥äËßÑÂàôÈÖçÁΩÆÊé•Âè£ ==============

interface BranchEnvironment {
  inner: string;
  outer: string;
  element: string;
  direction: string;
}

interface SuoBoGe {
  name: string;
  text: string;
  result: string;
}

interface DefaultJudgmentRule {
  branches: Array<string>;
  result: string;
  text: string;
}

interface DefaultJudgment {
  rules: Record<string, DefaultJudgmentRule>;
}

interface SuoBoRulesConfig {
  branch_environments: Record<string, BranchEnvironment>;
  suo_bo_ge: Record<string, SuoBoGe>;
  default_judgment: DefaultJudgment;
}

interface RuleItem {
  text: string;
  category?: string;
}

interface RulesConfig {
  rules: Record<string, RuleItem>;
  branch_meanings: Record<string, BranchMeaning>;
}

interface BranchMeaning {
  direction: string;
  element: string;
  environment: string;
  time_hint: string;
  informant: string;
  general: string;
}

// ============== ÂõõÁ¶ΩËÆ°ÁÆóÁªìÊûúÊé•Âè£ ==============

interface StarCalcResult {
  star: string;
  fullName: string;
  element: string;
}

interface DayStarCalcResult {
  star: string;
  fullName: string;
  element: string;
  yuanName: string;
  jiangIndex: number;
  jiangStar: string;  // ÂõõÂ∞ÜÁ¨¶Â§¥
}

interface FourStarsResult {
  yearStar: string;
  yearStarFull: string;
  yearElement: string;
  monthStar: string;
  monthStarFull: string;
  dayStar: string;
  dayStarFull: string;
  dayElement: string;
  hourStar: string;
  hourStarFull: string;
  hourElement: string;
  yuanName: string;
  jiangIndex: number;
  jiangStar: string;  // ÂõõÂ∞ÜÁ¨¶Â§¥
}

// ÁøªÁ¶Ω/Ê¥ªÊõúËÆ°ÁÆóÁªìÊûú
interface FanQinResult {
  fanQin: string;         // ÁøªÁ¶ΩÔºàÂ§©Á¶Ω/‰ªñÁ¶ΩÔºâ
  fanQinFull: string;
  fanQinElement: string;
}

interface HuoYaoResult {
  huoYao: string;         // Ê¥ªÊõúÔºàÂÄíÂ∞Ü/ÂèòÁ¶ΩÔºâ
  huoYaoFull: string;
  huoYaoElement: string;
}

// ÈîÅÊ≥äÊ†ºÂ±ÄÁªìÊûú
interface SuoBoResult {
  star: string;           // ÊòüÂÆø
  branch: string;         // ËêΩÂÆ´Âú∞ÊîØ
  environment: string;    // ÁéØÂ¢ÉÔºàÂ±±„ÄÅÊûó„ÄÅÁÅ´Á≠âÔºâ
  geName: string;         // Ê†ºÂ±ÄÂêçÔºàÂ¶Ç"ÊûÅ‰πêÂÆ´"Ôºâ
  geText: string;         // Ê†ºÂ±ÄÊñ≠ËØ≠
  geResult: string;       // ÂêâÂá∂ÁªìÊûú
}

// ÂêûÂï§ÂÖ≥Á≥ªÁªìÊûú
interface TunDanResult {
  star1: string;
  star1Animal: string;
  star2: string;
  star2Animal: string;
  canEat: boolean;        // star1ËÉΩÂê¶ÂêÉstar2
  description: string;    // ÂÖ≥Á≥ªÊèèËø∞
}

// È£û‰ºèÁä∂ÊÄÅÁªìÊûú
interface FeifuResult {
  star: string;
  isDayQin: boolean;      // ÊòØÂê¶Êó•Á¶Ω
  isNightQin: boolean;    // ÊòØÂê¶Â§úÁ¶Ω
  isDaytime: boolean;     // ÂΩìÂâçÊòØÂê¶ÁôΩÂ§©
  status: string;         // È£û/‰ºè
  description: string;    // Áä∂ÊÄÅÊèèËø∞
}

// ‰∏âÁ¶ΩÂàÜÁ±ªÁªìÊûú
interface QinTypeResult {
  star: string;
  qinType: string;        // Â§©Á¶Ω/Âú∞Á¶Ω/Ê∞¥Á¶Ω
}

@Entry
@Component
struct Index {
  private context = getContext(this) as common.Context;

  // ÈÖçÁΩÆÊï∞ÊçÆ
  @State hasLoaded: boolean = false;
  @State starRulesConfig: YanqinStarRulesConfig | null = null;
  @State lostItemsConfig: LostItemsConfig | null = null;
  @State rulesConfig: RulesConfig | null = null;
  @State suoBoConfig: SuoBoRulesConfig | null = null;  // ÈîÅÊ≥äËßÑÂàôÈÖçÁΩÆ

  // Áî®Êà∑ÈÄâÊã©
  @State selectedYear: number = new Date().getFullYear();
  @State selectedMonth: number = new Date().getMonth() + 1;
  @State selectedDay: number = new Date().getDate();
  @State selectedHourIndex: number = this.getCurrentHourIndex();
  @State useGodMode: number = 0;  // 0=‰º†ÁªüÂàÜÁ±ª, 1=Ëá™ÂÆö‰πâÁî®Á•û
  @State selectedCategoryIndex: number = 0;  // ‰º†ÁªüÂàÜÁ±ªÁ¥¢Âºï
  @State selectedTabIndex: number = 0;  // ÂõõË±°TabÁ¥¢Âºï
  @State selectedUseGodStar: string = 'ÂèÇ';  // Ëá™ÂÆö‰πâÁî®Á•ûÊòüÂÆø

  // ÂõõÁ¶ΩËÆ°ÁÆóÁªìÊûú
  @State fourStars: FourStarsResult | null = null;
  @State dayInfo: CalendarDayInfo | null = null;
  @State timeTrendTags: TimeRiskTag[] = [];

  // ÊéíÁõòÁªìÊûú
  @State resultKey: string = '';
  @State resultSummary: string = '';
  @State resultDetail: string = '';
  @State resultBranch: string = '';
  @State showResult: boolean = false;

  // ÈÄâÊã©Âô®Êï∞ÊçÆ
  @State yearOptions: SelectOption[] = [];
  @State monthOptions: SelectOption[] = [];
  @State dayOptions: SelectOption[] = [];
  @State hourOptions: SelectOption[] = [];

  private getCurrentHourIndex(): number {
    const hour = new Date().getHours();
    if (hour >= 23 || hour < 1) return 0;
    if (hour >= 1 && hour < 3) return 1;
    if (hour >= 3 && hour < 5) return 2;
    if (hour >= 5 && hour < 7) return 3;
    if (hour >= 7 && hour < 9) return 4;
    if (hour >= 9 && hour < 11) return 5;
    if (hour >= 11 && hour < 13) return 6;
    if (hour >= 13 && hour < 15) return 7;
    if (hour >= 15 && hour < 17) return 8;
    if (hour >= 17 && hour < 19) return 9;
    if (hour >= 19 && hour < 21) return 10;
    return 11;
  }

  aboutToAppear(): void {
    this.initOptions();
    CalendarManager.getInstance().init(this.context);
    this.initData();
  }

  private initOptions(): void {
    // Âπ¥‰ªΩÈÄâÈ°π
    const years: SelectOption[] = [];
    for (let y = 1900; y <= 2061; y++) {
      const opt: SelectOption = { value: `${y}Âπ¥` };
      years.push(opt);
    }
    this.yearOptions = years;

    // Êúà‰ªΩÈÄâÈ°π
    const months: SelectOption[] = [];
    for (let m = 1; m <= 12; m++) {
      const opt: SelectOption = { value: `${m}Êúà` };
      months.push(opt);
    }
    this.monthOptions = months;

    // Êó•ÊúüÈÄâÈ°π
    this.updateDayOptions();

    // Êó∂Ëæ∞ÈÄâÈ°π
    const branches = ['Â≠ê', '‰∏ë', 'ÂØÖ', 'ÂçØ', 'Ëæ∞', 'Â∑≥', 'Âçà', 'Êú™', 'Áî≥', 'ÈÖâ', 'Êàå', '‰∫•'];
    const times = ['23-01', '01-03', '03-05', '05-07', '07-09', '09-11', '11-13', '13-15', '15-17', '17-19', '19-21', '21-23'];
    const hours: SelectOption[] = [];
    for (let i = 0; i < 12; i++) {
      const opt: SelectOption = { value: `${branches[i]}Êó∂ (${times[i]}ÁÇπ)` };
      hours.push(opt);
    }
    this.hourOptions = hours;
  }

  private updateDayOptions(): void {
    const daysInMonth = new Date(this.selectedYear, this.selectedMonth, 0).getDate();
    const days: SelectOption[] = [];
    for (let d = 1; d <= daysInMonth; d++) {
      const opt: SelectOption = { value: `${d}Êó•` };
      days.push(opt);
    }
    this.dayOptions = days;
    if (this.selectedDay > daysInMonth) {
      this.selectedDay = daysInMonth;
    }
  }

  private async initData(): Promise<void> {
    const starRules = await this.loadJsonFromRaw<YanqinStarRulesConfig>('yanqin_star_rules.json');
    const lostItems = await this.loadJsonFromRaw<LostItemsConfig>('lost_items_config.json');
    const rules = await this.loadJsonFromRaw<RulesConfig>('lost_items_rules.json');
    const suoBo = await this.loadJsonFromRaw<SuoBoRulesConfig>('suo_bo_rules.json');

    if (starRules && lostItems && rules) {
      this.starRulesConfig = starRules;
      this.lostItemsConfig = lostItems;
      this.rulesConfig = rules;
      this.suoBoConfig = suoBo;
      this.hasLoaded = true;
      this.calculateFourStars();
    }
  }

  private async loadJsonFromRaw<T>(fileName: string): Promise<T | null> {
    try {
      const value = await this.context.resourceManager.getRawFileContent(fileName);
      const str = buffer.from(value.buffer).toString();
      return ArkJSON.parse(str) as T;
    } catch (err) {
      console.error('Failed to load: ' + fileName + ', error: ' + JSON.stringify(err));
      return null;
    }
  }

  // ============== ÂõõÁ¶ΩËÆ°ÁÆóÁÆóÊ≥ï ==============

  private async calculateFourStars(): Promise<void> {
    if (!this.starRulesConfig) return;

    const cfg = this.starRulesConfig;

    const yearResult = this.calculateYearStar(this.selectedYear, cfg);
    const monthResult = this.calculateMonthStar(this.selectedMonth, yearResult.element, cfg);
    const dayResult = this.calculateDayStar(this.selectedYear, this.selectedMonth, this.selectedDay, cfg);
    const hourResult = this.calculateHourStar(this.selectedHourIndex, dayResult.element, cfg);

    const result: FourStarsResult = {
      yearStar: yearResult.star,
      yearStarFull: yearResult.fullName,
      yearElement: yearResult.element,
      monthStar: monthResult.star,
      monthStarFull: monthResult.fullName,
      dayStar: dayResult.star,
      dayStarFull: dayResult.fullName,
      dayElement: dayResult.element,
      hourStar: hourResult.star,
      hourStarFull: hourResult.fullName,
      hourElement: hourResult.element,
      yuanName: dayResult.yuanName,
      jiangIndex: dayResult.jiangIndex,
      jiangStar: dayResult.jiangStar
    };
    this.fourStars = result;

    // ÂºÇÊ≠•Ëé∑Âèñ‰∏áÂπ¥ÂéÜ‰ø°ÊÅØ‰∏éÊó∂Èó¥Ë∂ãÂäøÊ†áÁ≠æÔºàÁ†î‰π†ÂêëÊèêÁ§∫Ôºâ
    const info = await CalendarManager.getInstance().getDayInfo(this.selectedYear, this.selectedMonth, this.selectedDay);
    this.dayInfo = info;
    if (info) {
      const trend = await calcTimeTrendFromCalendar(info, this.context);
      this.timeTrendTags = trend.tags;
    } else {
      this.timeTrendTags = [];
    }
  }

  private calculateYearStar(year: number, cfg: YanqinStarRulesConfig): StarCalcResult {
    const constellations = cfg.constellations_order;
    const baseYear = cfg.year_star_rules.base_year;
    const baseStar = cfg.year_star_rules.base_star;
    const baseIndex = constellations.indexOf(baseStar);

    const yearDiff = year - baseYear;
    const starIndex = ((yearDiff % 28) + 28 + baseIndex) % 28;
    const star = constellations[starIndex];
    const info = cfg.constellations_full[star];

    const result: StarCalcResult = {
      star: star,
      fullName: info.full_name,
      element: info.element
    };
    return result;
  }

  private calculateMonthStar(month: number, yearElement: string, cfg: YanqinStarRulesConfig): StarCalcResult {
    const constellations = cfg.constellations_order;
    const startStar = cfg.month_star_rules.element_to_start_star[yearElement];
    const startIndex = constellations.indexOf(startStar);

    const monthIndex = (startIndex + (month - 1)) % 28;
    const star = constellations[monthIndex];
    const info = cfg.constellations_full[star];

    const result: StarCalcResult = {
      star: star,
      fullName: info.full_name,
      element: info.element
    };
    return result;
  }

  private calculateDayStar(year: number, month: number, day: number, cfg: YanqinStarRulesConfig): DayStarCalcResult {
    const constellations = cfg.constellations_order;
    const dayRules = cfg.day_star_rules;

    // Ëß£ÊûêÂü∫ÂáÜÊó•ÊúüÂ≠óÁ¨¶‰∏≤ "1984-02-02"
    const baseDateStr = dayRules.base_date.date;
    const baseParts = baseDateStr.split('-');
    const baseYear = parseInt(baseParts[0]);
    const baseMonth = parseInt(baseParts[1]);
    const baseDay = parseInt(baseParts[2]);
    
    // Áªü‰∏Ä‰ΩøÁî®Êú¨Âú∞Êó∂Èó¥ÂàõÂª∫ Date ÂØπË±°ÔºåÈÅøÂÖçÊó∂Âå∫ÈóÆÈ¢ò
    const baseDate = new Date(baseYear, baseMonth - 1, baseDay);
    const targetDate = new Date(year, month - 1, day);

    const diffTime = targetDate.getTime() - baseDate.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));

    const posInCycle = ((diffDays % 420) + 420) % 420;
    const yuanIndex = Math.floor(posInCycle / 60);
    const posInYuan = posInCycle % 60;
    const jiangIndex = Math.floor(posInYuan / 15);
    const dayInJiang = posInYuan % 15;

    const yuanNames = ['‰∏ÄÂÖÉ', '‰∫åÂÖÉ', '‰∏âÂÖÉ', 'ÂõõÂÖÉ', '‰∫îÂÖÉ', 'ÂÖ≠ÂÖÉ', '‰∏ÉÂÖÉ'];
    const yuanName = yuanNames[yuanIndex];
    const jiangStars = dayRules.four_generals[yuanName];
    const jiangStar = jiangStars[jiangIndex];

    const jiangStarIndex = constellations.indexOf(jiangStar);
    const dayStarIndex = (jiangStarIndex + dayInJiang) % 28;
    const star = constellations[dayStarIndex];
    const info = cfg.constellations_full[star];

    const result: DayStarCalcResult = {
      star: star,
      fullName: info.full_name,
      element: info.element,
      yuanName: yuanName,
      jiangIndex: jiangIndex + 1,
      jiangStar: jiangStar  // ËøîÂõûÂõõÂ∞ÜÁ¨¶Â§¥
    };
    return result;
  }

  private calculateHourStar(hourIndex: number, dayElement: string, cfg: YanqinStarRulesConfig): StarCalcResult {
    const constellations = cfg.constellations_order;
    const startStar = cfg.hour_star_rules.element_to_start_star[dayElement];
    const startIndex = constellations.indexOf(startStar);

    const hourStarIndex = (startIndex + hourIndex) % 28;
    const star = constellations[hourStarIndex];
    const info = cfg.constellations_full[star];

    const result: StarCalcResult = {
      star: star,
      fullName: info.full_name,
      element: info.element
    };
    return result;
  }

  // ============== ÁøªÁ¶ΩËÆ°ÁÆóÔºàÂ§©Á¶Ω/‰ªñÁ¶ΩÔºâ ==============
  // Âè£ËØÄÔºöÂÄºÊó∂ÊîØ‰∏äËµ∑Â∞ÜÊòüÔºåÈ°∫Ë°åÈÄê‰ΩçÂêëÊó∂Á¶Ω„ÄÇÂØªÂæóÊó∂Á¶ΩÊùÉ‰∏îÊ≠¢ÔºåÈÄÜÂõûÊó∂‰ΩçÂêë‰ªñÁ¶Ω„ÄÇ
  // ÁÆóÊ≥ïÔºöÂ∞ÜÊòüÂä†Êó∂‰Ωç ‚Üí È°∫ÂØªÊó∂Á¶ΩËêΩÁÇπ ‚Üí ÈÄÜÊï∞ÂõûÊó∂‰Ωç
  private calculateFanQin(jiangStar: string, hourStar: string, hourIndex: number, cfg: YanqinStarRulesConfig): FanQinResult {
    const constellations = cfg.constellations_order;
    const jiangStarIndex = constellations.indexOf(jiangStar);
    const hourStarIndex = constellations.indexOf(hourStar);

    // 1. ËÆ°ÁÆó‰ªéÂ∞ÜÊòüÂà∞Êó∂Á¶ΩÁöÑÈ°∫Êï∞Ê≠•Êï∞
    const forwardSteps = ((hourStarIndex - jiangStarIndex) + 28) % 28;

    // 2. ÁøªÁ¶ΩÂÖ¨ÂºèÔºöÊó∂Á¶Ω‰ΩçÁΩÆ + È°∫Êï∞Ê≠•Êï∞
    // ÂéüÁêÜÔºöÈÄÜÊï∞ÂõûÊó∂‰ΩçÊó∂ÔºåÂú∞ÊîØÈÄÜËΩ¨‰ΩÜÊòüÂÆøÈ°∫ËΩ¨
    const fanQinIndex = (hourStarIndex + forwardSteps) % 28;
    const fanQin = constellations[fanQinIndex];
    const info = cfg.constellations_full[fanQin];

    return {
      fanQin: fanQin,
      fanQinFull: info.full_name,
      fanQinElement: info.element
    };
  }

  // ============== Ê¥ªÊõúËÆ°ÁÆóÔºàÂÄíÂ∞Ü/ÂèòÁ¶ΩÔºâ ==============
  // Âè£ËØÄÔºöÊó•ÊØïÊúàÂ∞æÁÅ´ÁøªÂ•éÔºåÊ∞¥Ê∞êÊú®ËôöÈáëÈ™ëÁâõÔºåÂúüÂÆøËøò‰ªéÁÆï‰ΩçËµ∑ÔºåÊØè‰ªéÂØÖ‰ΩçÈÄÜÂõûËΩ¨„ÄÇ
  // ÁÆóÊ≥ïÔºöÂØÖ‰ΩçËµ∑ÁøªËΩ¨ÊòüÂÆø ‚Üí ÈÄÜÂØªÊó∂Á¶ΩËêΩÁÇπ ‚Üí È°∫Êï∞ÂõûÁî®Êó∂
  private calculateHuoYao(hourStar: string, hourElement: string, hourIndex: number, cfg: YanqinStarRulesConfig): HuoYaoResult {
    const constellations = cfg.constellations_order;
    const branches = cfg.branches_order;

    // 1. Ê†πÊçÆÊó∂Á¶ΩÁöÑ‰∏ÉÊîøÂ±ûÊÄßÁ°ÆÂÆöÁøªËΩ¨Ëµ∑ÁÇπÊòüÂÆø
    const flipStar = cfg.huo_yao_rules.element_to_flip_star[hourElement];
    const flipStarIndex = constellations.indexOf(flipStar);
    const hourStarIndex = constellations.indexOf(hourStar);

    // 2. ÂØÖ‰ΩçÁ¥¢ÂºïÔºàÂõ∫ÂÆö‰∏∫2Ôºâ
    const yinIndex = branches.indexOf('ÂØÖ'); // = 2

    // 3. ‰ªéÁøªËΩ¨ÊòüÂÆøÈÄÜÊï∞ÊâæÊó∂Á¶ΩËêΩÁÇπ
    // ÈÄÜÊï∞Ê≠•Êï∞ = Êó∂Á¶Ω‰ΩçÁΩÆ - ÁøªËΩ¨ÊòüÂÆø‰ΩçÁΩÆÔºàÊòüÂÆøÈ°∫Ë°åÔºåÂú∞ÊîØÈÄÜË°åÔºâ
    const backwardSteps = ((hourStarIndex - flipStarIndex) + 28) % 28;

    // 4. Êó∂Á¶ΩËêΩÂú®ÁöÑÂú∞ÊîØÔºà‰ªéÂØÖÈÄÜÊï∞Ôºâ
    const hourStarBranch = ((yinIndex - backwardSteps % 12) + 12) % 12;

    // 5. ‰ªéÊó∂Á¶ΩËêΩÁÇπÈ°∫Êï∞ÂõûÁî®Êó∂
    const forwardSteps = ((hourIndex - hourStarBranch) + 12) % 12;

    // 6. Ê¥ªÊõú = Êó∂Á¶Ω + È°∫Êï∞Ê≠•Êï∞
    const huoYaoIndex = (hourStarIndex + forwardSteps) % 28;
    const huoYao = constellations[huoYaoIndex];
    const info = cfg.constellations_full[huoYao];

    return {
      huoYao: huoYao,
      huoYaoFull: info.full_name,
      huoYaoElement: info.element
    };
  }

  // ============== ÈîÅÊ≥äÊ†ºÂ±ÄÂà§Êñ≠ ==============
  // Ê†πÊçÆÊòüÂÆøËêΩÂú®ÁöÑÂú∞ÊîØÔºåÂà§Êñ≠Ê†ºÂ±ÄÂêâÂá∂
  private judgeSuoBo(star: string, branch: string, cfg: YanqinStarRulesConfig): SuoBoResult {
    if (!this.suoBoConfig) {
      return {
        star: star,
        branch: branch,
        environment: '',
        geName: 'Êó†ÈÖçÁΩÆ',
        geText: 'ÈîÅÊ≥äËßÑÂàôÊú™Âä†ËΩΩ',
        geResult: 'Âπ≥'
      };
    }

    const suoBoCfg = this.suoBoConfig;
    
    // Ëé∑ÂèñÂú∞ÊîØÁéØÂ¢É
    const branchEnv = suoBoCfg.branch_environments[branch] as BranchEnvironment;
    const environment = branchEnv ? branchEnv.inner : 'Êú™Áü•';

    // Êü•ÊâæÁâπÂÆöÊ†ºÂ±Ä
    const geKey = `${star}_${branch}`;
    const ge = suoBoCfg.suo_bo_ge[geKey] as SuoBoGe;

    if (ge) {
      return {
        star: star,
        branch: branch,
        environment: environment,
        geName: ge.name,
        geText: ge.text,
        geResult: ge.result
      };
    }

    // Êó†ÁâπÂÆöÊ†ºÂ±ÄÊó∂Ôºå‰ΩøÁî®ÈÄöÁî®ËßÑÂàôÂà§Êñ≠
    const starInfo = cfg.constellations_full[star];
    const starElement = starInfo?.element || 'Êú™Áü•';
    const branchElement = branchEnv?.element || 'Êú™Áü•';

    // Ê£ÄÊü•ÈÄöÁî®ËßÑÂàô
    const defaultRules = suoBoCfg.default_judgment.rules;
    for (const ruleKey of Object.keys(defaultRules)) {
      const rule = defaultRules[ruleKey];
      if (rule.branches.includes(branch)) {
        // Ê£ÄÊü•‰∫îË°åÂåπÈÖç
        if (ruleKey.startsWith('Ê∞¥Á¶Ω') && starElement === 'Ê∞¥') {
          return { star, branch, environment, geName: ruleKey, geText: rule.text, geResult: rule.result };
        }
        if (ruleKey.startsWith('ÁÅ´Á¶Ω') && starElement === 'ÁÅ´') {
          return { star, branch, environment, geName: ruleKey, geText: rule.text, geResult: rule.result };
        }
        if (ruleKey.startsWith('Êú®Á¶Ω') && starElement === 'Êú®') {
          return { star, branch, environment, geName: ruleKey, geText: rule.text, geResult: rule.result };
        }
        if (ruleKey.startsWith('ÈáëÁ¶Ω') && starElement === 'Èáë') {
          return { star, branch, environment, geName: ruleKey, geText: rule.text, geResult: rule.result };
        }
        if (ruleKey.startsWith('ÂúüÁ¶Ω') && starElement === 'Âúü') {
          return { star, branch, environment, geName: ruleKey, geText: rule.text, geResult: rule.result };
        }
      }
    }

    // ÈªòËÆ§ÁªìÊûú
    return {
      star: star,
      branch: branch,
      environment: environment,
      geName: `${starInfo?.animal || star}Ê≥ä${environment}`,
      geText: `${starInfo?.full_name || star}ËêΩ${branch}ÂÆ´Ôºà${environment}Ôºâ`,
      geResult: 'Âπ≥'
    };
  }

  // ============== ‰∏âÁ¶ΩÂàÜÁ±ªÂà§Êñ≠ ==============
  // Â§©Á¶Ω/Âú∞Á¶Ω/Ê∞¥Á¶ΩÂàÜÁ±ª
  private judgeQinType(star: string, cfg: YanqinStarRulesConfig): QinTypeResult {
    const classification = cfg.qin_classification;
    
    if (classification.Â§©Á¶Ω.includes(star)) {
      return { star, qinType: 'Â§©Á¶Ω' };
    }
    if (classification.Ê∞¥Á¶Ω.includes(star)) {
      return { star, qinType: 'Ê∞¥Á¶Ω' };
    }
    return { star, qinType: 'Âú∞Á¶Ω' };
  }

  // ============== ÂêûÂïñÂÖ≥Á≥ªÂà§Êñ≠ ==============
  // Âà§Êñ≠ star1 ËÉΩÂê¶ÂêÉ star2
  private judgeTunDan(star1: string, star2: string, cfg: YanqinStarRulesConfig): TunDanResult {
    const tunDan = cfg.tun_dan;
    const info1 = cfg.constellations_full[star1];
    const info2 = cfg.constellations_full[star2];
    const animal1 = info1?.animal || '';
    const animal2 = info2?.animal || '';
  
    // Ëé∑Âèñ star1 ÁöÑÈ£üÁâ©ÂàóË°®
    const foodList = tunDan.food_map[star1] || [];
    let canEat = false;
    let description = '';
  
    if (foodList.length > 0) {
      // Ê£ÄÊü•ÊòØÂê¶ÂåÖÂê´ "ÁôæÂÖΩ"(ÂêÉ‰∏ÄÂàá)
      if (foodList.includes('ÁôæÂÖΩ')) {
        canEat = true;
        description = `${info1?.full_name || star1}È£üÁôæÂÖΩÔºåËÉΩÂÖã${info2?.full_name || star2}`;
      } else if (foodList.includes(animal2)) {
        canEat = true;
        description = `${animal1}È£ü${animal2}Ôºå${info1?.full_name || star1}ÂÖã${info2?.full_name || star2}`;
      }
    }
  
    if (!canEat) {
      // Ê£ÄÊü•ÊòØÂê¶Êó†È£ü
      const wuShiList = tunDan.wu_shi?.list || [];
      if (wuShiList.includes(animal1)) {
        description = `${animal1}‰∏∫Êó†È£ü‰πãÁ¶ΩÔºå‰∏çËÉΩÂÖã‰ªñÁ¶Ω`;
      } else {
        description = `${animal1}‰∏çÈ£ü${animal2}ÔºåÊó†ÂÖã`;
      }
    }
  
    return {
      star1,
      star1Animal: animal1,
      star2,
      star2Animal: animal2,
      canEat,
      description
    };
  }

  // ============== È£û‰ºèÁä∂ÊÄÅÂà§Êñ≠ ==============
  // Ê†πÊçÆÊó•Á¶Ω/Â§úÁ¶ΩÂíåÊó∂Ëæ∞Âà§Êñ≠È£û‰ºè
  private judgeFeifu(star: string, hourIndex: number, cfg: YanqinStarRulesConfig): FeifuResult {
    const riYeQin = cfg.ri_ye_qin;
    const isDayQin = riYeQin.Êó•Á¶Ω.includes(star);
    const isNightQin = riYeQin.Â§úÁ¶Ω.includes(star);
    const isDayNightCommon = riYeQin.Êó•Â§úÈÄöÁî®.includes(star);

    // Âà§Êñ≠ÂΩìÂâçÊòØÂê¶ÁôΩÂ§©ÔºàÂØÖÊó∂ÂàªÂçØÊó∂Ôºå5:00-19:00Ôºâ
    // Êó∂Ëæ∞Á¥¢Âºï: Â≠ê(0), ‰∏ë(1), ÂØÖ(2), ÂçØ(3), Ëæ∞(4), Â∑≥(5), Âçà(6), Êú™(7), Áî≥(8), ÈÖâ(9), Êàå(10), ‰∫•(11)
    // ÁôΩÂ§©Á∫¶‰∏∫ ÂØÖ(2) ~ ÈÖâ(9)
    const isDaytime = hourIndex >= 2 && hourIndex <= 9;

    let status = '';
    let description = '';

    if (isDayNightCommon) {
      status = 'ÈÄö';
      description = `${star}‰∏∫Êó•Â§úÈÄöÁî®‰πãÁ¶ΩÔºåÊó†ËÆ∫ÊòºÂ§úÁöÜÂèØÊ¥ªÂä®`;
    } else if (isDaytime) {
      // ÁôΩÂ§©
      if (isDayQin) {
        status = 'È£û';
        description = `ÊòºÈó¥‰∏¥Êó•Á¶Ω${star}ÔºåÈ£ûÔºàÊòæÂΩ¢„ÄÅÂú®Âä®Ôºâ`;
      } else {
        status = '‰ºè';
        description = `ÊòºÈó¥‰∏¥Â§úÁ¶Ω${star}Ôºå‰ºèÔºàÈöêÂΩ¢„ÄÅ‰ºëÊÅØÔºâ`;
      }
    } else {
      // Â§úÊôö
      if (isNightQin) {
        status = 'È£û';
        description = `Â§úÈó¥‰∏¥Â§úÁ¶Ω${star}ÔºåÈ£ûÔºàÊ¥ªË∑ÉÔºâ`;
      } else {
        status = '‰ºè';
        description = `Â§úÈó¥‰∏¥Êó•Á¶Ω${star}Ôºå‰ºèÔºà‰ºëÊÅØÔºâ`;
      }
    }

    return {
      star,
      isDayQin,
      isNightQin,
      isDaytime,
      status,
      description
    };
  }

  // ============== ÊéíÁõòÊºîÁÆó ==============

  private doCalculate(): void {
    if (!this.fourStars || !this.lostItemsConfig || !this.rulesConfig || !this.starRulesConfig) {
      return;
    }

    const constellations = this.starRulesConfig.constellations_order;
    const branches = this.lostItemsConfig.branches_order;

    // Ê†πÊçÆÊ®°ÂºèÁ°ÆÂÆöÁî®Á•ûÊòüÂÆø
    let useGodStar: string;
    let categoryName: string;
    if (this.useGodMode === 0) {
      // ‰º†ÁªüÂàÜÁ±ªÊ®°Âºè
      const useGod = this.lostItemsConfig.use_gods[this.selectedCategoryIndex];
      useGodStar = useGod.star;
      categoryName = useGod.category;
    } else {
      // Ëá™ÂÆö‰πâÁî®Á•ûÊ®°Âºè
      useGodStar = this.selectedUseGodStar;
      categoryName = 'Ëá™ÂÆö‰πâËØªË±°';
    }

    const dayStarIndex = constellations.indexOf(this.fourStars.dayStar);
    const hourIndex = this.selectedHourIndex;
    const useStarIndex = constellations.indexOf(useGodStar);

    if (dayStarIndex < 0 || useStarIndex < 0) {
      this.resultSummary = 'Êï∞ÊçÆÈÖçÁΩÆ‰∏çÂÆåÊï¥ÔºåÊó†Ê≥ïÊºîÁÆó„ÄÇ';
      this.resultDetail = '';
      this.showResult = true;
      return;
    }

    const deltaStars = (useStarIndex - dayStarIndex + 28) % 28;
    const resultBranchIndex = (hourIndex + deltaStars) % 12;
    this.resultBranch = branches[resultBranchIndex];

    const key = this.buildRuleKey(useGodStar, this.resultBranch);
    this.resultKey = key;

    const rule = this.rulesConfig.rules[key];
    const starInfo = this.starRulesConfig.constellations_full[useGodStar];

    if (this.useGodMode === 0) {
      // ‰º†ÁªüÂàÜÁ±ªÊ®°ÂºèÔºöÊòæÁ§∫ÂàÜÁ±ªÂêçÁß∞
      this.resultSummary = `ÂØª${categoryName} ¬∑ Áî®Á•û„Äå${useGodStar}„ÄçÂÆø ¬∑ ËêΩ„Äå${this.resultBranch}„ÄçÂÆ´`;
    } else {
      // Ëá™ÂÆö‰πâÁî®Á•ûÊ®°Âºè
      this.resultSummary = `Áî®Á•û„Äå${starInfo?.full_name || useGodStar}„Äç ¬∑ ËêΩ„Äå${this.resultBranch}„ÄçÂÆ´`;
    }

    if (rule) {
      this.resultDetail = rule.text;
    } else {
      // Êó†ÂÖ∑‰ΩìÊñ≠ËØ≠Êó∂Ôºå‰ΩøÁî®ÂÆ´‰ΩçÈÄöÁî®Âê´‰πâÊé®ÂØº
      const branchMeaning = this.rulesConfig.branch_meanings[this.resultBranch];
      if (branchMeaning) {
        this.resultDetail = `„ÄêÈÄöÁî®Êé®ÂØº„ÄëÊ≠§ÁªÑÂêàÊó†Âè§Á±çËÆ∞ËΩΩÔºå‰ª•‰∏ã‰∏∫ÂÆ´‰ΩçÂü∫Êú¨Âê´‰πâÊé®ÂØºÔºö\n\n` +
          `‚óé Êñπ‰ΩçÔºö${branchMeaning.direction}\n` +
          `‚óé ‰∫îË°åÔºö${branchMeaning.element}\n` +
          `‚óé ÁéØÂ¢ÉÔºö${branchMeaning.environment}\n` +
          `‚óé Êä•‰ø°‰∫∫Ôºö${branchMeaning.informant}\n` +
          `‚óé Êó∂Èó¥Ôºö${branchMeaning.time_hint}\n\n` +
          `„ÄêÁªºÂêàÂàÜÊûê„Äë${branchMeaning.general}\n\n` +
          `Áî®Á•û„Äå${starInfo?.full_name || useGodStar}„ÄçÂ±û${starInfo?.element || 'Êú™Áü•'}ÔºåËêΩ${this.resultBranch}ÂÆ´Â±û${branchMeaning.element}ÔºåÂèØÁªìÂêà‰∫îË°åÁîüÂÖãÂèÇËÄÉÂà§Êñ≠„ÄÇ`;
      } else {
        this.resultDetail = `ÂΩìÂâçÁªÑÂêàÔºà${key}ÔºâÂú®Ê°à‰æãÂ∫ì‰∏≠ÊöÇÊó†ËØ¶ÁªÜËÆ∞ËΩΩ„ÄÇ`;
      }
    }
    this.showResult = true;
  }

  private buildRuleKey(star: string, branch: string): string {
    const starNameMap: Record<string, string> = {
      'Ëßú': 'ËßúÊòü', 'Â•é': 'Â•éÂÆø', 'Ëôö': 'ËôöÂÆø', 'Â•≥': 'Â•≥ÂÆø',
      'Êòü': 'ÊòüÂÆø', 'Áâõ': 'ÁâõÂÆø', 'Êàø': 'ÊàøÂÆø', 'È¨º': 'È¨ºÂÆø',
      'ÂÆ§': 'ÂÆ§ÂÆø', 'ÂèÇ': 'ÂèÇÂÆø', 'Êò¥': 'Êò¥ÂÆø', 'Â®Ñ': 'Â®ÑÂÆø', 'Êü≥': 'Êü≥ÂÆø'
    };
    const prefix = starNameMap[star] || `${star}Êòü`;
    return `${prefix}Âú®${branch}`;
  }

  private getDateString(): string {
    return `${this.selectedYear}Âπ¥${this.selectedMonth}Êúà${this.selectedDay}Êó•`;
  }

  private getHourString(index: number): string {
    const branches = ['Â≠ê', '‰∏ë', 'ÂØÖ', 'ÂçØ', 'Ëæ∞', 'Â∑≥', 'Âçà', 'Êú™', 'Áî≥', 'ÈÖâ', 'Êàå', '‰∫•'];
    const times = ['23-01', '01-03', '03-05', '05-07', '07-09', '09-11', '11-13', '13-15', '15-17', '17-19', '19-21', '21-23'];
    return `${branches[index]}Êó∂ (${times[index]}ÁÇπ)`;
  }

  private getUseGodDisplayText(): string {
    if (!this.lostItemsConfig || !this.starRulesConfig) return '';
    if (this.useGodMode === 0) {
      const useGod = this.lostItemsConfig.use_gods[this.selectedCategoryIndex];
      return `${useGod.star}ÂÆøÔºàÂØª${useGod.category}Ôºâ‚Üí ËêΩ${this.resultBranch}ÂÆ´`;
    } else {
      const starInfo = this.starRulesConfig.constellations_full[this.selectedUseGodStar];
      return `${this.selectedUseGodStar}ÂÆøÔºà${starInfo?.full_name || ''}Ôºâ‚Üí ËêΩ${this.resultBranch}ÂÆ´`;
    }
  }

  // ============== UI ÊûÑÂª∫ ==============

  build() {
    Scroll() {
      Column() {
        // È°∂ÈÉ®Ê†áÈ¢ò
        Column() {
          Text('Á¶ΩÊòüÊºîÂØª')
            .fontSize(28)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1a1a1a')
          Text('Âü∫‰∫é‰∏ÉÂÖÉÁî≤Â≠êÁöÑ‰º†ÁªüÊºîÁ¶ΩÊúØÁ†î‰π†Â∑•ÂÖ∑')
            .fontSize(13)
            .fontColor('#666666')
            .margin({ top: 6 })
        }
        .width('100%')
        .padding({ top: 40, bottom: 16 })
        .alignItems(HorizontalAlign.Center)

        // ========== ÂäüËÉΩÂÖ•Âè£ÂèåÂç°Áâá ==========
        Row() {
          // Êñπ‰ΩçÊé®ÊºîÂç°Áâá
          Column() {
            Text('Êñπ‰ΩçÊé®Êºî')
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor('#2d5a3d')
            Text('ÁÆÄÊòìÊ≠åËØÄ ¬∑ ÈÄüÊü•')
              .fontSize(11)
              .fontColor('#666666')
              .margin({ top: 4 })
            Text('Áî®Á•ûËêΩÂÆ´¬∑Êñπ‰ΩçÂèÇËÄÉ')
              .fontSize(10)
              .fontColor('#888888')
              .margin({ top: 2 })
          }
          .layoutWeight(1)
          .height(90)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#f5f9f6')
          .borderRadius(14)
          .border({ width: 2, color: '#3d6b4f' })

          // ÊºîÁ¶ΩÁõòÂºèÂç°Áâá
          Column() {
            Text('ÊºîÁ¶ΩÁõòÂºè')
              .fontSize(17)
              .fontWeight(FontWeight.Bold)
              .fontColor('#1a5276')
            Text('ÂÆåÊï¥ÊéíÁõò ¬∑ Á≤æÁ†î')
              .fontSize(11)
              .fontColor('#666666')
              .margin({ top: 4 })
            Text('‰∏â‰º†ÂõõËØæ¬∑ÈîÅÊ≥äÂçÅ‰∫åÂÆ´')
              .fontSize(10)
              .fontColor('#888888')
              .margin({ top: 2 })
          }
          .layoutWeight(1)
          .height(90)
          .justifyContent(FlexAlign.Center)
          .backgroundColor('#e8f4fc')
          .borderRadius(14)
          .border({ width: 1, color: '#d4e6f1' })
          .margin({ left: 12 })
          .onClick(() => {
            router.pushUrl({
              url: 'pages/YanQinPanShi',
              params: {
                year: this.selectedYear,
                month: this.selectedMonth,
                day: this.selectedDay,
                hourIndex: this.selectedHourIndex
              }
            });
          })
        }
        .width('100%')
        .padding({ left: 16, right: 16, bottom: 16 })

        // ========== È´òÁ∫ßÁ†î‰π†ÂÖ•Âè£ÔºàÊ°à‰æãÂ∫ìÁ§∫‰æãÔºâ ==========
        Row() {
          Column() {
            Text('üìö È´òÁ∫ßÁ†î‰π† ¬∑ Ê°à‰æãÂ∫ì Á§∫‰æã')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor('#312e81')
              .width('100%')
              .margin({ bottom: 4 })

            Text('Êî∂ÂΩïÂÆòÂè∏Á≠âÂú∫ÊôØÁöÑÊºîÁ¶ΩÁ†î‰π†Ê°à‰æãÔºå‰ΩøÁî®Ê®°ÊãüÊï∞ÊçÆÔºå‰ªÖ‰æõÂ≠¶‰π†ÂèÇËÄÉ„ÄÇ')
              .fontSize(11)
              .fontColor('#4b5563')
              .width('100%')
          }
          .layoutWeight(1)

          Text('ËøõÂÖ•')
            .fontSize(12)
            .fontColor('#4c1d95')
            .margin({ left: 8 })
        }
        .width('100%')
        .height(72)
        .padding({ left: 16, right: 16 })
        .backgroundColor('#f5f3ff')
        .borderRadius(14)
        .margin({ left: 16, right: 16, bottom: 12 })
        .border({ width: 1, color: '#ddd6fe' })
        .onClick(() => {
          router.pushUrl({
            url: 'pages/AdvancedStudyCases'
          });
        })

        if (this.hasLoaded && this.starRulesConfig && this.lostItemsConfig) {
          // ========== Êó•ÊúüÊó∂Ëæ∞ÈÄâÊã©Âå∫ ==========
          Column() {
            Text('ÈÄâÊã©Êó•ÊúüÊó∂Ëæ∞')
              .fontSize(15)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .width('100%')
              .margin({ bottom: 12 })

            // Âπ¥ÊúàÊó•ÈÄâÊã©Ë°å
            Row() {
              Select(this.yearOptions)
                .selected(this.selectedYear - 1900)
                .value(`${this.selectedYear}Âπ¥`)
                .font({ size: 14 })
                .fontColor('#333333')
                .height(44)
                .layoutWeight(1)
                .backgroundColor('#f8f8f6')
                .borderRadius(8)
                .onSelect((index: number) => {
                  this.selectedYear = 1900 + index;
                  this.updateDayOptions();
                  this.calculateFourStars();
                  this.showResult = false;
                })

              Select(this.monthOptions)
                .selected(this.selectedMonth - 1)
                .value(`${this.selectedMonth}Êúà`)
                .font({ size: 14 })
                .fontColor('#333333')
                .height(44)
                .layoutWeight(1)
                .backgroundColor('#f8f8f6')
                .borderRadius(8)
                .margin({ left: 8 })
                .onSelect((index: number) => {
                  this.selectedMonth = index + 1;
                  this.updateDayOptions();
                  this.calculateFourStars();
                  this.showResult = false;
                })

              Select(this.dayOptions)
                .selected(this.selectedDay - 1)
                .value(`${this.selectedDay}Êó•`)
                .font({ size: 14 })
                .fontColor('#333333')
                .height(44)
                .layoutWeight(1)
                .backgroundColor('#f8f8f6')
                .borderRadius(8)
                .margin({ left: 8 })
                .onSelect((index: number) => {
                  this.selectedDay = index + 1;
                  this.calculateFourStars();
                  this.showResult = false;
                })
            }
            .width('100%')

            // Êó∂Ëæ∞ÈÄâÊã©
            Select(this.hourOptions)
              .selected(this.selectedHourIndex)
              .value(this.getHourString(this.selectedHourIndex))
              .font({ size: 14 })
              .fontColor('#333333')
              .width('100%')
              .height(44)
              .backgroundColor('#f8f8f6')
              .borderRadius(8)
              .margin({ top: 10 })
              .onSelect((index: number) => {
                this.selectedHourIndex = index;
                this.calculateFourStars();
                this.showResult = false;
              })

            // ÊòæÁ§∫‰∏áÂπ¥ÂéÜËØ¶ÁªÜ‰ø°ÊÅØ
            if (this.dayInfo) {
              Row() {
                Text(`ÂÜúÂéÜÔºö${this.dayInfo.lunar_month}Êúà${this.dayInfo.lunar_day} ¬∑ ${this.dayInfo.year_gan}${this.dayInfo.year_zhi}Âπ¥ ¬∑ ${this.dayInfo.zodiac} ¬∑ ${this.dayInfo.week_name}`)
                  .fontSize(12)
                  .fontColor('#4caf50')
                  .fontWeight(FontWeight.Medium)
                if (this.dayInfo.solar_term) {
                  Text(` ¬∑ ${this.dayInfo.solar_term}`)
                    .fontSize(12)
                    .fontColor('#ff9800')
                    .fontWeight(FontWeight.Bold)
                    .margin({ left: 4 })
                }
                if (this.dayInfo.festivals) {
                  Text(` ¬∑ ${this.dayInfo.festivals}`)
                    .fontSize(12)
                    .fontColor('#e91e63')
                    .margin({ left: 4 })
                }
              }
              .width('100%')
              .margin({ top: 10 })
              .padding({ left: 4 })
            }

            // Êó∂Èó¥Ë∂ãÂäø ¬∑ Á†î‰π†ÊèêÁ§∫
            if (this.dayInfo && this.timeTrendTags.length > 0) {
              Column() {
                Row() {
                  Text('Êó∂Èó¥Ë∂ãÂäø ¬∑ Á†î‰π†ÊèêÁ§∫')
                    .fontSize(12)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#374151')
                  Blank()
                  Text('Âü∫‰∫é‰º†ÁªüÂçÅ‰∫îÂç∑Á≠âËßÑÂàôÔºå‰ªÖ‰æõÂ≠¶‰π†ÂèÇËÄÉ')
                    .fontSize(10)
                    .fontColor('#9ca3af')
                }
                .width('100%')
                .margin({ bottom: 4 })

                ForEach(this.timeTrendTags, (tag: TimeRiskTag) => {
                  Column() {
                    Text(tag.label)
                      .fontSize(11)
                      .fontWeight(FontWeight.Medium)
                      .fontColor(tag.level === 'high' ? '#b91c1c' : (tag.level === 'medium' ? '#b45309' : '#1f2933'))
                    Text(tag.safeSummary)
                      .fontSize(10)
                      .fontColor('#4b5563')
                      .lineHeight(14)
                      .margin({ top: 2 })
                  }
                  .width('100%')
                  .padding({ top: 6, bottom: 6, left: 8, right: 8 })
                  .margin({ top: 4 })
                  .backgroundColor(tag.level === 'high' ? '#fef2f2' : (tag.level === 'medium' ? '#fffbeb' : '#f3f4f6'))
                  .borderRadius(8)
                })
              }
              .width('100%')
              .margin({ top: 8 })
            }
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#ffffff')
          .borderRadius(14)
          .margin({ left: 16, right: 16, bottom: 12 })

          // ========== ÂõõÁ¶ΩÂ±ïÁ§∫Âå∫ ==========
          if (this.fourStars) {
            Column() {
              Row() {
                Text('ÂõõÁ¶ΩÊé®ÁÆó')
                  .fontSize(15)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                Blank()
                Text(`${this.fourStars.yuanName}¬∑Á¨¨${this.fourStars.jiangIndex}Â∞Ü`)
                  .fontSize(12)
                  .fontColor('#888888')
              }
              .width('100%')
              .margin({ bottom: 12 })

              // ÂõõÁ¶ΩÁΩëÊ†º
              Grid() {
                GridItem() {
                  Column() {
                    Text('Âπ¥Á¶Ω')
                      .fontSize(11)
                      .fontColor('#888888')
                    Text(this.fourStars.yearStarFull)
                      .fontSize(15)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#2d5a3d')
                      .margin({ top: 4 })
                  }
                  .width('100%')
                  .height('100%')
                  .justifyContent(FlexAlign.Center)
                  .backgroundColor('#f5f9f6')
                  .borderRadius(10)
                }

                GridItem() {
                  Column() {
                    Text('ÊúàÁ¶Ω')
                      .fontSize(11)
                      .fontColor('#888888')
                    Text(this.fourStars.monthStarFull)
                      .fontSize(15)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#2d5a3d')
                      .margin({ top: 4 })
                  }
                  .width('100%')
                  .height('100%')
                  .justifyContent(FlexAlign.Center)
                  .backgroundColor('#f5f9f6')
                  .borderRadius(10)
                }

                GridItem() {
                  Column() {
                    Text('Êó•Á¶Ω')
                      .fontSize(11)
                      .fontColor('#ffffff')
                    Text(this.fourStars.dayStarFull)
                      .fontSize(16)
                      .fontWeight(FontWeight.Bold)
                      .fontColor('#ffffff')
                      .margin({ top: 4 })
                    Text(`Â±û${this.fourStars.dayElement}`)
                      .fontSize(10)
                      .fontColor('#ffffffcc')
                      .margin({ top: 2 })
                  }
                  .width('100%')
                  .height('100%')
                  .justifyContent(FlexAlign.Center)
                  .backgroundColor('#3d6b4f')
                  .borderRadius(10)
                }

                GridItem() {
                  Column() {
                    Text('Êó∂Á¶Ω')
                      .fontSize(11)
                      .fontColor('#888888')
                    Text(this.fourStars.hourStarFull)
                      .fontSize(15)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#2d5a3d')
                      .margin({ top: 4 })
                  }
                  .width('100%')
                  .height('100%')
                  .justifyContent(FlexAlign.Center)
                  .backgroundColor('#f5f9f6')
                  .borderRadius(10)
                }
              }
              .columnsTemplate('1fr 1fr 1fr 1fr')
              .rowsTemplate('1fr')
              .columnsGap(8)
              .width('100%')
              .height(80)
            }
            .width('100%')
            .padding(16)
            .backgroundColor('#ffffff')
            .borderRadius(14)
            .margin({ left: 16, right: 16, bottom: 12 })
          }

          // ========== Áî®Á•ûÈÄâÊã©Âå∫ ==========
          Column() {
            // Ê®°ÂºèÂàáÊç¢Tab
            Row() {
              Text('‰º†ÁªüÂàÜÁ±ª')
                .fontSize(14)
                .fontWeight(this.useGodMode === 0 ? FontWeight.Medium : FontWeight.Normal)
                .fontColor(this.useGodMode === 0 ? '#ffffff' : '#666666')
                .backgroundColor(this.useGodMode === 0 ? '#3d6b4f' : '#f0f0f0')
                .borderRadius(20)
                .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                .onClick(() => {
                  this.useGodMode = 0;
                  this.showResult = false;
                })
              Text('Ëá™ÂÆö‰πâÁî®Á•û')
                .fontSize(14)
                .fontWeight(this.useGodMode === 1 ? FontWeight.Medium : FontWeight.Normal)
                .fontColor(this.useGodMode === 1 ? '#ffffff' : '#666666')
                .backgroundColor(this.useGodMode === 1 ? '#3d6b4f' : '#f0f0f0')
                .borderRadius(20)
                .padding({ left: 16, right: 16, top: 8, bottom: 8 })
                .margin({ left: 12 })
                .onClick(() => {
                  this.useGodMode = 1;
                  this.showResult = false;
                })
            }
            .width('100%')
            .justifyContent(FlexAlign.Center)
            .margin({ bottom: 16 })

            if (this.useGodMode === 0) {
              // ========== ‰º†ÁªüÂàÜÁ±ªÊ®°Âºè ==========
              Column() {
                Text('ÈÄâÊã©Ë¶ÅÂØªÊâæÁöÑÂØπË±°')
                  .fontSize(15)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                  .width('100%')
                  .margin({ bottom: 12 })

                // ÂàÜÁ±ªÁΩëÊ†º
                Grid() {
                  ForEach(this.lostItemsConfig!.use_gods, (item: LostItemUseGod, index: number) => {
                    GridItem() {
                      Column() {
                        Text(item.category)
                          .fontSize(14)
                          .fontWeight(FontWeight.Medium)
                          .fontColor(this.selectedCategoryIndex === index ? '#ffffff' : '#333333')
                        Text(item.note)
                          .fontSize(10)
                          .fontColor(this.selectedCategoryIndex === index ? '#ffffffcc' : '#888888')
                          .margin({ top: 4 })
                      }
                      .width('100%')
                      .height('100%')
                      .justifyContent(FlexAlign.Center)
                      .backgroundColor(this.selectedCategoryIndex === index ? '#3d6b4f' : '#f8f8f6')
                      .borderRadius(10)
                      .onClick(() => {
                        this.selectedCategoryIndex = index;
                        this.showResult = false;
                      })
                    }
                  })
                }
                .columnsTemplate('1fr 1fr 1fr')
                .rowsTemplate('1fr 1fr 1fr 1fr 1fr')
                .columnsGap(8)
                .rowsGap(8)
                .width('100%')
                .height(280)
              }
              .width('100%')
            } else {
              // ========== Ëá™ÂÆö‰πâÁî®Á•ûÊ®°Âºè ==========
              Column() {
                Row() {
                  Text('Ê†πÊçÆËØªË±°ÈÄâÊã©Áî®Á•ûÊòüÂÆø')
                    .fontSize(15)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#333333')
                  Blank()
                  Text(this.starRulesConfig!.constellations_full[this.selectedUseGodStar]?.full_name || '')
                    .fontSize(14)
                    .fontWeight(FontWeight.Medium)
                    .fontColor('#3d6b4f')
                }
                .width('100%')
                .margin({ bottom: 10 })

                // ÂõõË±°Tab
                Row() {
                  ForEach(this.starRulesConfig!.four_symbols.groups, (group: FourSymbolGroup, index: number) => {
                    Text(group.name)
                      .fontSize(12)
                      .fontColor(this.selectedTabIndex === index ? '#ffffff' : '#666666')
                      .backgroundColor(this.selectedTabIndex === index ? group.color : '#f0f0f0')
                      .borderRadius(14)
                      .padding({ left: 10, right: 10, top: 5, bottom: 5 })
                      .margin({ right: index < 3 ? 6 : 0 })
                      .onClick(() => {
                        this.selectedTabIndex = index;
                      })
                  })
                }
                .width('100%')
                .justifyContent(FlexAlign.Start)
                .margin({ bottom: 10 })

                // ÊòüÂÆøÁΩëÊ†º
                Grid() {
                  ForEach(this.starRulesConfig!.four_symbols.groups[this.selectedTabIndex].stars,
                    (star: string) => {
                      GridItem() {
                        Column() {
                          Text(this.starRulesConfig!.constellations_full[star]?.animal || '')
                            .fontSize(18)
                          Text(star)
                            .fontSize(13)
                            .fontWeight(FontWeight.Medium)
                            .fontColor(this.selectedUseGodStar === star ? '#ffffff' : '#333333')
                            .margin({ top: 2 })
                        }
                        .width('100%')
                        .height('100%')
                        .justifyContent(FlexAlign.Center)
                        .backgroundColor(this.selectedUseGodStar === star ?
                          this.starRulesConfig!.four_symbols.groups[this.selectedTabIndex].color : '#f8f8f6')
                        .borderRadius(8)
                        .onClick(() => {
                          this.selectedUseGodStar = star;
                          this.showResult = false;
                        })
                      }
                    })
                }
                .columnsTemplate('1fr 1fr 1fr 1fr')
                .rowsTemplate('1fr 1fr')
                .columnsGap(6)
                .rowsGap(6)
                .width('100%')
                .height(110)

                // Áî®Á•ûÂèÇËÄÉÊèêÁ§∫
                Row() {
                  Text('ÂèÇËÄÉÔºö')
                    .fontSize(11)
                    .fontColor('#888888')
                  Text(this.starRulesConfig!.use_god_hints.hints[this.selectedUseGodStar] || '')
                    .fontSize(11)
                    .fontColor('#666666')
                    .layoutWeight(1)
                }
                .width('100%')
                .margin({ top: 8 })
                .padding({ left: 6, right: 6, top: 6, bottom: 6 })
                .backgroundColor('#fafaf8')
                .borderRadius(6)
              }
              .width('100%')
            }
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#ffffff')
          .borderRadius(14)
          .margin({ left: 16, right: 16 })

          // ========== ÊºîÁÆóÊåâÈíÆ ==========
          Button('ÂºÄÂßãÊºîÁÆó', { type: ButtonType.Capsule })
            .width('90%')
            .height(50)
            .fontSize(17)
            .fontWeight(FontWeight.Medium)
            .backgroundColor('#3d6b4f')
            .margin({ top: 24, bottom: 16 })
            .onClick(() => {
              this.doCalculate();
            })

          // ========== ÁªìÊûúÂ±ïÁ§∫Âå∫ ==========
          if (this.showResult && this.fourStars && this.lostItemsConfig) {
            Column() {
              Row() {
                Text('ÊºîÁÆóÁªìÊûú')
                  .fontSize(16)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#333333')
                Blank()
                Text(this.resultKey)
                  .fontSize(12)
                  .fontColor('#888888')
              }
              .width('100%')
              .margin({ bottom: 12 })

              // ÊéíÁõò‰ø°ÊÅØ
              Column() {
                Row() {
                  Text('Êó•Êúü')
                    .fontSize(13)
                    .fontColor('#666666')
                    .width(60)
                  Text(this.getDateString())
                    .fontSize(13)
                    .fontColor('#333333')
                }
                .width('100%')
                .margin({ bottom: 6 })

                Row() {
                  Text('Êó•Á¶Ω')
                    .fontSize(13)
                    .fontColor('#666666')
                    .width(60)
                  Text(`${this.fourStars.dayStarFull}ÔºàÂ±û${this.fourStars.dayElement}Ôºâ`)
                    .fontSize(13)
                    .fontColor('#333333')
                }
                .width('100%')
                .margin({ bottom: 6 })

                Row() {
                  Text('Êó∂Á¶Ω')
                    .fontSize(13)
                    .fontColor('#666666')
                    .width(60)
                  Text(this.fourStars.hourStarFull)
                    .fontSize(13)
                    .fontColor('#333333')
                }
                .width('100%')
                .margin({ bottom: 6 })

                Row() {
                  Text('Áî®Á•û')
                    .fontSize(13)
                    .fontColor('#666666')
                    .width(60)
                  Text(this.getUseGodDisplayText())
                    .fontSize(13)
                    .fontColor('#2d5a3d')
                    .fontWeight(FontWeight.Medium)
                }
                .width('100%')
              }
              .width('100%')
              .padding(14)
              .backgroundColor('#fafaf8')
              .borderRadius(10)
              .margin({ bottom: 12 })

              // Ê†∏ÂøÉÊñ≠ËØ≠
              Column() {
                Text(this.resultSummary)
                  .fontSize(15)
                  .fontWeight(FontWeight.Medium)
                  .fontColor('#2d5a3d')
                  .width('100%')

                Divider()
                  .color('#e8e8e8')
                  .margin({ top: 12, bottom: 12 })

                Text(this.resultDetail)
                  .fontSize(14)
                  .fontColor('#444444')
                  .lineHeight(22)
                  .width('100%')
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#f5f9f6')
              .borderRadius(12)

              // ÂÖçË¥£Â£∞Êòé
              Text('‚àó ‰ª•‰∏äÂÜÖÂÆπ‰ªÖ‰æõ‰º†ÁªüÊñáÂåñÁ†î‰π†ÂèÇËÄÉÔºå‰∏çÊûÑÊàê‰ªª‰ΩïÁé∞ÂÆûÊåáÂØº„ÄÇ')
                .fontSize(11)
                .fontColor('#aaaaaa')
                .margin({ top: 16 })
                .textAlign(TextAlign.Center)
                .width('100%')
            }
            .width('100%')
            .padding({ left: 16, right: 16, top: 8, bottom: 32 })
          }
        } else {
          // Âä†ËΩΩ‰∏≠
          Column() {
            LoadingProgress()
              .width(40)
              .height(40)
              .color('#888888')
            Text('Ê≠£Âú®Âä†ËΩΩÈÖçÁΩÆ...')
              .fontSize(14)
              .fontColor('#888888')
              .margin({ top: 12 })
          }
          .width('100%')
          .padding({ top: 60 })
          .alignItems(HorizontalAlign.Center)
        }
      }
      .width('100%')
      .constraintSize({ minHeight: '100%' })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f2f1ed')
    .scrollBar(BarState.Off)
  }
}
