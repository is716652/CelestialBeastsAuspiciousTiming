import { common } from '@kit.AbilityKit';
import { router } from '@kit.ArkUI';
import { CalendarManager, CalendarDayInfo } from '../utils/CalendarManager';
import { getQiYaoTypeFromStar, getQiYaoInfo, QiYaoInfo, getAllEventTypes, getEventSuggestion, EventSuggestion } from '../utils/QiYaoUtils';
import { evaluateDayQuality, getDayLevelByGan, DayQualityEvaluation } from '../utils/BaoYiZhuanUtils';
import { buffer, JSON as ArkJSON } from '@kit.ArkTS';

// ============== æ¥å£å®šä¹‰ ==============

interface ConstellationInfo {
  full_name: string;
  element: string;
}

interface YearStarRules {
  base_year: number;
  base_star: string;
}

interface MonthStarRules {
  element_to_start_star: Record<string, string>;
}

interface DayStarBaseDate {
  date: string;
}

interface DayStarRules {
  base_date: DayStarBaseDate;
  four_generals: Record<string, Array<string>>;
}

interface YanqinStarRulesConfig {
  constellations_order: Array<string>;
  constellations_full: Record<string, ConstellationInfo>;
  year_star_rules: YearStarRules;
  month_star_rules: MonthStarRules;
  day_star_rules: DayStarRules;
}

interface AuspiciousDay {
  date: string;
  year: number;
  month: number;
  day: number;
  dayStar: string;
  dayStarFull: string;
  qiYaoInfo: QiYaoInfo;
  dayLevelInfo: DayQualityEvaluation;
  dayGan: string;
  dayZhi: string;
  score: number;
  reason: string;
}

@Entry
@Component
struct SmartDateSelector {
  private context = getContext(this) as common.Context;

  @State hasLoaded: boolean = false;
  @State isSearching: boolean = false;
  @State starRulesConfig: YanqinStarRulesConfig | null = null;

  // ç”¨æˆ·é€‰æ‹©
  @State selectedEventType: string = 'å«å¨¶çº³å¦¾';
  @State searchDays: number = 30;

  // æœç´¢ç»“æœ
  @State auspiciousDays: AuspiciousDay[] = [];
  @State hasSearched: boolean = false;

  private eventTypes: string[] = [];

  aboutToAppear(): void {
    this.eventTypes = getAllEventTypes();
    this.initData();
  }

  private async initData(): Promise<void> {
    const starRules = await this.loadJsonFromRaw<YanqinStarRulesConfig>('yanqin_star_rules.json');
    if (starRules) {
      this.starRulesConfig = starRules;
      this.hasLoaded = true;
    }
  }

  private async loadJsonFromRaw<T>(fileName: string): Promise<T | null> {
    try {
      const value = await this.context.resourceManager.getRawFileContent(fileName);
      const str = buffer.from(value.buffer).toString();
      return ArkJSON.parse(str) as T;
    } catch (err) {
      console.error('Failed to load: ' + fileName);
      return null;
    }
  }

  // è®¡ç®—æ—¥ç¦½
  private calculateDayStar(year: number, month: number, day: number): string {
    if (!this.starRulesConfig) return '';
    
    const cfg = this.starRulesConfig;
    const constellations = cfg.constellations_order;
    const dayRules = cfg.day_star_rules;
    
    const baseDateStr = dayRules.base_date.date;
    const baseParts = baseDateStr.split('-');
    const baseYear = parseInt(baseParts[0]);
    const baseMonth = parseInt(baseParts[1]);
    const baseDay = parseInt(baseParts[2]);
    
    const baseDate = new Date(baseYear, baseMonth - 1, baseDay);
    const targetDate = new Date(year, month - 1, day);
    const diffTime = targetDate.getTime() - baseDate.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    
    const posInCycle = ((diffDays % 420) + 420) % 420;
    const yuanIndex = Math.floor(posInCycle / 60);
    const posInYuan = posInCycle % 60;
    const jiangIndex = Math.floor(posInYuan / 15);
    const dayInJiang = posInYuan % 15;
    
    const yuanNames = ['ä¸€å…ƒ', 'äºŒå…ƒ', 'ä¸‰å…ƒ', 'å››å…ƒ', 'äº”å…ƒ', 'å…­å…ƒ', 'ä¸ƒå…ƒ'];
    const yuanName = yuanNames[yuanIndex];
    const jiangStars = dayRules.four_generals[yuanName];
    const jiangStar = jiangStars[jiangIndex];
    const jiangStarIndex = constellations.indexOf(jiangStar);
    const dayStarIndex = (jiangStarIndex + dayInJiang) % 28;
    
    return constellations[dayStarIndex];
  }

  // æ™ºèƒ½æœç´¢å‰æ—¥
  private async searchAuspiciousDays(): Promise<void> {
    if (!this.starRulesConfig || !this.selectedEventType) {
      return;
    }

    this.isSearching = true;
    this.auspiciousDays = [];

    const suggestion = getEventSuggestion(this.selectedEventType);
    if (!suggestion) {
      this.isSearching = false;
      return;
    }

    const today = new Date();
    const results: AuspiciousDay[] = [];

    // æœç´¢æœªæ¥Nå¤©
    for (let i = 0; i < this.searchDays; i++) {
      const checkDate = new Date(today);
      checkDate.setDate(today.getDate() + i);

      const year = checkDate.getFullYear();
      const month = checkDate.getMonth() + 1;
      const day = checkDate.getDate();

      // è®¡ç®—æ—¥ç¦½
      const dayStar = this.calculateDayStar(year, month, day);
      const qiYaoType = getQiYaoTypeFromStar(dayStar);
      if (!qiYaoType) continue;

      const qiYaoInfo = getQiYaoInfo(qiYaoType);

      // è·å–ä¸‡å¹´å†ä¿¡æ¯
      const dayInfo = await CalendarManager.getInstance().getDayInfo(year, month, day);
      if (!dayInfo) continue;

      // è¯„ä¼°å®ä¹‰ä¸“æ—¥
      const dayLevelInfo = evaluateDayQuality(dayInfo.day_gan, dayInfo.year_gan);

      // è¯„åˆ†é€»è¾‘
      let score = 50; // åŸºç¡€åˆ†
      let reason = '';

      // ä¸ƒæ›œé€‚é…ï¼ˆæœ€é«˜ä¼˜å…ˆçº§ï¼‰
      if (suggestion.preferredQiYao.includes(qiYaoType)) {
        score += 30;
        reason += `${qiYaoInfo.name}å¤§å‰ï¼›`;
      } else if (suggestion.forbiddenQiYao.includes(qiYaoType)) {
        score -= 40;
        reason += `${qiYaoInfo.name}å¤§å‡¶ï¼›`;
        continue; // è·³è¿‡å‡¶æ—¥
      } else if (suggestion.alternativeQiYao.includes(qiYaoType)) {
        score += 15;
        reason += `${qiYaoInfo.name}æ¬¡å‰ï¼›`;
      }

      // å®ä¹‰ä¸“æ—¥åŠ åˆ†
      if (dayLevelInfo.dayLevel === 'bao') {
        score += 25;
        reason += 'å®æ—¥ï¼›';
      } else if (dayLevelInfo.dayLevel === 'yi') {
        score += 15;
        reason += 'ä¹‰æ—¥ï¼›';
      } else if (dayLevelInfo.dayLevel === 'zhuan') {
        score += 15;
        reason += 'ä¸“æ—¥ï¼›';
      } else if (dayLevelInfo.dayLevel === 'fa') {
        score -= 30;
        reason += 'ä¼æ—¥å¤§å‡¶ï¼›';
        continue; // è·³è¿‡ä¼æ—¥
      }

      // è‡£çŠ¯å›æ‰£åˆ†
      if (dayLevelInfo.isChenFanJun) {
        score -= 35;
        reason += 'è‡£çŠ¯å›ï¼›';
        continue; // è·³è¿‡è‡£çŠ¯å›
      }

      // åªä¿ç•™70åˆ†ä»¥ä¸Šçš„å‰æ—¥
      if (score >= 70) {
        const dayStarInfo = this.starRulesConfig.constellations_full[dayStar];
        const auspDay: AuspiciousDay = {
          date: `${year}-${month.toString().padStart(2, '0')}-${day.toString().padStart(2, '0')}`,
          year,
          month,
          day,
          dayStar,
          dayStarFull: dayStarInfo.full_name,
          qiYaoInfo,
          dayLevelInfo,
          dayGan: dayInfo.day_gan,
          dayZhi: dayInfo.day_zhi,
          score,
          reason: reason.slice(0, -1) // å»æ‰æœ€åçš„åˆ†å·
        };
        results.push(auspDay);
      }
    }

    // æŒ‰åˆ†æ•°é™åºæ’åº
    results.sort((a, b) => b.score - a.score);

    this.auspiciousDays = results;
    this.hasSearched = true;
    this.isSearching = false;
  }

  build() {
    Scroll() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆª
        Row() {
          Text('â†')
            .fontSize(24)
            .fontColor('#333333')
            .onClick(() => router.back())
          Text('æ™ºèƒ½æ‹©æ—¥åŠ©æ‰‹')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1a1a1a')
            .margin({ left: 12 })
          Blank()
          Text('ğŸ“…')
            .fontSize(20)
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 8 })

        if (this.hasLoaded) {
          // äº‹ä½“é€‰æ‹©åŒº
          Column() {
            Text('è¯·é€‰æ‹©äº‹ä½“ç±»å‹')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
              .width('100%')
              .margin({ bottom: 10 })

            Grid() {
              ForEach(this.eventTypes, (eventType: string) => {
                GridItem() {
                  Column() {
                    Text(eventType)
                      .fontSize(14)
                      .fontColor(this.selectedEventType === eventType ? '#ffffff' : '#333333')
                      .fontWeight(this.selectedEventType === eventType ? FontWeight.Bold : FontWeight.Normal)
                  }
                  .width('100%')
                  .height(44)
                  .justifyContent(FlexAlign.Center)
                  .backgroundColor(this.selectedEventType === eventType ? '#3d6b4f' : '#f5f5f5')
                  .borderRadius(8)
                  .onClick(() => {
                    this.selectedEventType = eventType;
                    this.hasSearched = false;
                  })
                }
              }, (eventType: string) => eventType)
            }
            .columnsTemplate('1fr 1fr')
            .rowsGap(8)
            .columnsGap(8)
            .width('100%')
            .margin({ bottom: 16 })

            // æœç´¢å¤©æ•°é€‰æ‹©
            Row() {
              Text('æœç´¢èŒƒå›´ï¼š')
                .fontSize(13)
                .fontColor('#666666')
              
              Radio({ value: '30', group: 'searchDays' })
                .checked(this.searchDays === 30)
                .onChange(() => { this.searchDays = 30 })
                .width(18)
                .height(18)
              Text('æœªæ¥30å¤©')
                .fontSize(12)
                .fontColor('#666666')
                .margin({ left: 4, right: 12 })

              Radio({ value: '60', group: 'searchDays' })
                .checked(this.searchDays === 60)
                .onChange(() => { this.searchDays = 60 })
                .width(18)
                .height(18)
              Text('æœªæ¥60å¤©')
                .fontSize(12)
                .fontColor('#666666')
                .margin({ left: 4 })
            }
            .width('100%')
            .margin({ bottom: 16 })

            // æœç´¢æŒ‰é’®
            Button(this.isSearching ? 'æ­£åœ¨æœç´¢...' : 'ğŸ” å¼€å§‹æ™ºèƒ½æ‹©æ—¥')
              .fontSize(15)
              .fontColor('#ffffff')
              .backgroundColor('#3d6b4f')
              .width('100%')
              .height(48)
              .enabled(!this.isSearching)
              .onClick(() => {
                this.searchAuspiciousDays();
              })
          }
          .width('100%')
          .padding(16)
          .backgroundColor('#ffffff')
          .borderRadius(14)
          .margin({ left: 16, right: 16, top: 16, bottom: 16 })

          // æœç´¢ç»“æœ
          if (this.hasSearched) {
            if (this.auspiciousDays.length > 0) {
              Column() {
                Row() {
                  Text('ğŸ¯ æ¨èå‰æ—¥')
                    .fontSize(15)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#333333')
                  Blank()
                  Text(`å…±${this.auspiciousDays.length}å¤©`)
                    .fontSize(12)
                    .fontColor('#888888')
                }
                .width('100%')
                .margin({ bottom: 12 })

                ForEach(this.auspiciousDays, (day: AuspiciousDay, index: number) => {
                  this.AuspiciousDayCard(day, index + 1)
                }, (day: AuspiciousDay) => day.date)
              }
              .width('100%')
              .padding(16)
              .backgroundColor('#ffffff')
              .borderRadius(14)
              .margin({ left: 16, right: 16, bottom: 16 })
            } else {
              Column() {
                Text('ğŸ˜”')
                  .fontSize(48)
                  .margin({ bottom: 8 })
                Text('æœªæ‰¾åˆ°åˆé€‚çš„å‰æ—¥')
                  .fontSize(14)
                  .fontColor('#666666')
                  .margin({ bottom: 4 })
                Text('å»ºè®®æ‰©å¤§æœç´¢èŒƒå›´æˆ–æ›´æ¢äº‹ä½“')
                  .fontSize(12)
                  .fontColor('#999999')
              }
              .width('100%')
              .height(200)
              .justifyContent(FlexAlign.Center)
              .backgroundColor('#ffffff')
              .borderRadius(14)
              .margin({ left: 16, right: 16, bottom: 16 })
            }
          }

        } else {
          Column() {
            LoadingProgress().width(40).height(40).color('#3d6b4f')
            Text('åŠ è½½ä¸­...')
              .fontSize(14)
              .fontColor('#666666')
              .margin({ top: 12 })
          }
          .width('100%')
          .height(300)
          .justifyContent(FlexAlign.Center)
        }

        // åº•éƒ¨è¯´æ˜
        Column() {
          Text('ğŸ’¡ æ‹©æ—¥è¯´æ˜')
            .fontSize(13)
            .fontWeight(FontWeight.Bold)
            .fontColor('#666666')
            .width('100%')
            .margin({ bottom: 8 })
          
          Text('â€¢ ä¸ƒæ›œæ€»æ–­ï¼šæ ¹æ®äº‹ä½“åŒ¹é…é€‚é…ç¦½æ˜Ÿ')
            .fontSize(11)
            .fontColor('#888888')
            .width('100%')
            .margin({ bottom: 4 })
          
          Text('â€¢ å®ä¹‰ä¸“æ—¥ï¼šä¼˜é€‰å®æ—¥ã€ä¹‰æ—¥ã€ä¸“æ—¥')
            .fontSize(11)
            .fontColor('#888888')
            .width('100%')
            .margin({ bottom: 4 })
          
          Text('â€¢ è‡ªåŠ¨æ’é™¤ï¼šä¼æ—¥ã€è‡£çŠ¯å›ç­‰å‡¶æ—¥')
            .fontSize(11)
            .fontColor('#888888')
            .width('100%')
            .margin({ bottom: 4 })
          
          Text('â€¢ ç»¼åˆè¯„åˆ†ï¼š70åˆ†ä»¥ä¸Šä¸ºæ¨èå‰æ—¥')
            .fontSize(11)
            .fontColor('#888888')
            .width('100%')
        }
        .width('100%')
        .padding(16)
        .backgroundColor('#f5f5f5')
        .borderRadius(14)
        .margin({ left: 16, right: 16, bottom: 20 })
      }
      .width('100%')
      .constraintSize({ minHeight: '100%' })
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f8f8f8')
    .scrollBar(BarState.Off)
  }

  @Builder
  AuspiciousDayCard(day: AuspiciousDay, rank: number) {
    Column() {
      Row() {
        // æ’åå¾½ç« 
        Text(rank.toString())
          .fontSize(16)
          .fontWeight(FontWeight.Bold)
          .fontColor('#ffffff')
          .width(28)
          .height(28)
          .textAlign(TextAlign.Center)
          .backgroundColor(rank === 1 ? '#ffd700' : rank === 2 ? '#c0c0c0' : rank === 3 ? '#cd7f32' : '#999999')
          .borderRadius(14)
          .margin({ right: 10 })

        Column() {
          Text(`${day.month}æœˆ${day.day}æ—¥`)
            .fontSize(16)
            .fontWeight(FontWeight.Bold)
            .fontColor('#333333')
          
          Text(`${day.dayGan}${day.dayZhi}æ—¥ Â· ${day.dayStarFull}`)
            .fontSize(11)
            .fontColor('#888888')
            .margin({ top: 2 })
        }
        .alignItems(HorizontalAlign.Start)

        Blank()

        // è¯„åˆ†
        Column() {
          Text(day.score.toString())
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor(day.score >= 90 ? '#4caf50' : day.score >= 80 ? '#ff9800' : '#2196f3')
          Text('åˆ†')
            .fontSize(10)
            .fontColor('#888888')
        }
      }
      .width('100%')
      .margin({ bottom: 10 })

      // ä¸ƒæ›œä¸å®ä¹‰ä¸“æ—¥
      Row() {
        Column() {
          Text(day.qiYaoInfo.name)
            .fontSize(12)
            .fontColor(day.qiYaoInfo.color)
            .fontWeight(FontWeight.Bold)
        }
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .backgroundColor(day.qiYaoInfo.color + '20')
        .borderRadius(4)

        Column() {
          Text(day.dayLevelInfo.dayLevelInfo.emoji + ' ' + day.dayLevelInfo.dayLevelInfo.name)
            .fontSize(12)
            .fontColor(day.dayLevelInfo.dayLevelInfo.color)
            .fontWeight(FontWeight.Bold)
        }
        .padding({ left: 8, right: 8, top: 4, bottom: 4 })
        .backgroundColor(day.dayLevelInfo.dayLevelInfo.color + '20')
        .borderRadius(4)
        .margin({ left: 6 })

        Blank()

        Text(day.reason)
          .fontSize(10)
          .fontColor('#666666')
      }
      .width('100%')
    }
    .width('100%')
    .padding(14)
    .backgroundColor('#fafafa')
    .borderRadius(10)
    .margin({ bottom: 10 })
    .border({ width: 1, color: rank <= 3 ? '#3d6b4f' : '#e0e0e0' })
  }
}
