import { common } from '@kit.AbilityKit';
import { buffer, JSON as ArkJSON } from '@kit.ArkTS';
import { router } from '@kit.ArkUI';
import { loadKnowledge15xConfig, Knowledge15xConfig } from '../utils/Knowledge15x';
import { CalendarManager, CalendarDayInfo } from '../utils/CalendarManager';
import { getQiYaoTypeFromStar, getQiYaoInfo, QiYaoInfo } from '../utils/QiYaoUtils';
import { evaluateDayQuality, DayQualityEvaluation } from '../utils/BaoYiZhuanUtils';
import { getStarEventEvaluation, StarEventEvaluation, StarEventType, StarEventLevel } from '../utils/StarEventRulesUtils';

// ============== æ¥å£å®šä¹‰ ==============

interface ConstellationInfo {
  full_name: string;
  element: string;
  animal: string;
}

interface YearStarRules {
  base_year: number;
  base_star: string;
}

interface MonthStarRules {
  element_to_start_star: Record<string, string>;
}

interface DayStarBaseDate {
  date: string;
  yuan: number;
  jiang: number;
  star: string;
}

interface SevenYuanHeads {
  list: Array<string>;
}

interface DayStarRules {
  cycle_days: number;
  yuan_days: number;
  jiang_days: number;
  seven_yuan_heads: SevenYuanHeads;
  four_generals: Record<string, Array<string>>;
  base_date: DayStarBaseDate;
}

interface HourStarRules {
  element_to_start_star: Record<string, string>;
}

interface HuoYaoRules {
  element_to_flip_star: Record<string, string>;
  start_branch: string;
}

interface QinClassification {
  å¤©ç¦½: Array<string>;
  åœ°ç¦½: Array<string>;
  æ°´ç¦½: Array<string>;
  å®¶ç¦½: Array<string>;
}

interface WuShiConfig {
  list: Array<string>;
}

interface TunDanConfig {
  food_map: Record<string, Array<string>>;
  wu_shi: WuShiConfig;
  animal_to_star: Record<string, string>;
}

interface RiYeQinConfig {
  æ—¥ç¦½: Array<string>;
  å¤œç¦½: Array<string>;
  æ—¥å¤œé€šç”¨: Array<string>;
}

interface StrengthTagsConfig {
  base_branches: Record<string, Array<string>>;
  strong_stars: Array<string>;
}

interface SanheGroupConfig {
  id: string;
  name: string;
  stars: Array<string>;
  tag: string;
  safeSummary: string;
}

interface LiuhePairConfig {
  id: string;
  name: string;
  stars: Array<string>;
  safeSummary: string;
}

interface ComboRulesConfig {
  sanhe_groups: Array<SanheGroupConfig>;
  liuhe_pairs: Array<LiuhePairConfig>;
}

interface SeasonalSeasonInfo {
  label: string;
  branches: Array<string>;
  stars: Array<string>;
  safeSummary: string;
}

interface SeasonalHintsConfig {
  seasons: Record<string, SeasonalSeasonInfo>;
}

interface NobleStarHintItem {
  type: string;
  label: string;
  safeSummary: string;
}

interface NobleStarHintsConfig {
  items: Record<string, NobleStarHintItem>;
}

interface YanqinStarRulesConfig {
  constellations_order: Array<string>;
  constellations_full: Record<string, ConstellationInfo>;
  branches_order: Array<string>;
  year_star_rules: YearStarRules;
  month_star_rules: MonthStarRules;
  day_star_rules: DayStarRules;
  hour_star_rules: HourStarRules;
  huo_yao_rules: HuoYaoRules;
  qin_classification: QinClassification;
  tun_dan: TunDanConfig;
  ri_ye_qin: RiYeQinConfig;
  strength_tags?: StrengthTagsConfig;
  combo_rules?: ComboRulesConfig;
  seasonal_hints?: SeasonalHintsConfig;
  noble_star_hints?: NobleStarHintsConfig;
}

interface BranchEnvironment {
  inner: string;
  outer: string;
  element: string;
  direction: string;
}

interface SuoBoGe {
  name: string;
  text: string;
  result: string;
}

interface SuoBoRulesConfig {
  branch_environments: Record<string, BranchEnvironment>;
  suo_bo_ge: Record<string, SuoBoGe>;
}

interface StarCalcResult {
  star: string;
  fullName: string;
  element: string;
}

interface DayStarCalcResult extends StarCalcResult {
  yuanName: string;
  jiangIndex: number;
  jiangStar: string;
}

// äº”ç¦½æ’ç›˜ç»“æœ
interface WuQinResult {
  diQin: StarCalcResult;      // åœ°ç¦½/æ—¶ç¦½(æˆ‘)
  tianQin: StarCalcResult;    // å¤©ç¦½/ç¿»ç¦½(ä»–)
  huoYao: StarCalcResult;     // æ´»æ›œ/å˜ç¦½
  yearStar: StarCalcResult;   // å¹´ç¦½
  monthStar: StarCalcResult;  // æœˆç¦½
  dayStar: StarCalcResult;    // æ—¥ç¦½
}

// é”æ³Šæ ¼å±€ç»“æœ
interface SuoBoResult {
  star: string;
  branch: string;
  environment: string;
  geName: string;
  geText: string;
  geResult: string;
}

// é¡µé¢å‚æ•°
interface PageParams {
  year: number;
  month: number;
  day: number;
  hourIndex: number;
}

// é£ä¼ç»“æœ
interface FeifuResultSimple {
  status: string;
  desc: string;
}

// æ˜Ÿå®¿ç‰©è±¡ä¿¡æ¯
interface StarImageryInfo {
  imagery: string;
  material: string;
  examples: string;
}

interface StarGroup {
  name: string;
  stars: string[];
}

@Entry
@Component
struct YanQinPanShi {
  private context = getContext(this) as common.Context;

  @State hasLoaded: boolean = false;
  @State starRulesConfig: YanqinStarRulesConfig | null = null;
  @State suoBoConfig: SuoBoRulesConfig | null = null;

  // é¡µé¢å‚æ•°
  @State selectedYear: number = new Date().getFullYear();
  @State selectedMonth: number = new Date().getMonth() + 1;
  @State selectedDay: number = new Date().getDate();
  @State selectedHourIndex: number = 6;

  // è®¡ç®—ç»“æœ
  @State wuQinResult: WuQinResult | null = null;
  @State yuanName: string = '';
  @State jiangIndex: number = 0;
  @State jiangStar: string = '';

  // é”æ³Šç»“æœ
  @State diQinSuoBo: SuoBoResult | null = null;
  @State tianQinSuoBo: SuoBoResult | null = null;
  @State huoYaoSuoBo: SuoBoResult | null = null;
  @State useGodSuoBo: SuoBoResult | null = null;

  // é€‰é¡¹æ•°æ®
  private years: string[] = [];
  private months: string[] = [];
  private days: string[] = [];
  private hourBranches: string[] = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
  private stars28: string[] = ['è§’', 'äº¢', 'æ°', 'æˆ¿', 'å¿ƒ', 'å°¾', 'ç®µ', 'æ–—', 'ç‰›', 'å¥³', 'è™š', 'å±', 'å®¤', 'å£', 'å¥', 'å¨„', 'èƒƒ', 'æ˜‚', 'æ¯•', 'è§œ', 'å‚', 'äº•', 'é¬¼', 'æŸ³', 'æ˜Ÿ', 'å¼ ', 'ç¿¼', 'è½¸'];
  
  // ç”¨ç¥é€‰æ‹©
  @State selectedUseGodStar: string = '';
  @State isShowUseGodSheet: boolean = false;

  private starEmojis: Record<string, string> = {
    'è§’': 'ğŸ‰', 'äº¢': 'ğŸ²', 'æ°': 'ğŸ¦¡', 'æˆ¿': 'ğŸ°', 'å¿ƒ': 'ğŸ¦Š', 'å°¾': 'ğŸ¯', 'ç®µ': 'ğŸ†',
    'æ–—': 'ğŸ¦„', 'ç‰›': 'ğŸ‚', 'å¥³': 'ğŸ¦‡', 'è™š': 'ğŸ€', 'å±': 'ç‡•', 'å®¤': 'ğŸ–', 'å£': 'ğŸ¦Œ',
    'å¥': 'ğŸº', 'å¨„': 'ğŸ•', 'èƒƒ': 'é›‰', 'æ˜‚': 'ğŸ“', 'æ¯•': ' crows', 'è§œ': 'ğŸ’', 'å‚': 'ğŸ¦',
    'äº•': 'ğŸ¶', 'é¬¼': 'ğŸ', 'æŸ³': 'ğŸ¦Œ', 'æ˜Ÿ': 'ğŸ', 'å¼ ': 'ğŸ¦Œ', 'ç¿¼': 'ğŸ', 'è½¸': 'ğŸ›'
  };
  // ä¿®æ­£éƒ¨åˆ†emoji: æ¯•(ä¹Œ)ã€å±(ç‡•)ã€è½¸(èš“)ã€å¼ (é¹¿)ç­‰
  private starEmojiMap: Record<string, string> = {
    'è§’': 'ğŸ‰', 'äº¢': 'ğŸ²', 'æ°': 'ğŸ¦¡', 'æˆ¿': 'ğŸ°', 'å¿ƒ': 'ğŸ¦Š', 'å°¾': 'ğŸ¯', 'ç®µ': 'ğŸ†',
    'æ–—': 'ç¬', 'ç‰›': 'ğŸ‚', 'å¥³': 'ğŸ¦‡', 'è™š': 'ğŸ€', 'å±': 'ğŸ•Šï¸', 'å®¤': 'ğŸ–', 'å£': 'ğŸ¦Œ',
    'å¥': 'ğŸº', 'å¨„': 'ğŸ•', 'èƒƒ': 'é›‰', 'æ˜‚': 'ğŸ“', 'æ¯•': 'ğŸ¦', 'è§œ': 'ğŸ’', 'å‚': 'ğŸ¦',
    'äº•': 'ğŸ•', 'é¬¼': 'ğŸ', 'æŸ³': 'ğŸ¦Œ', 'æ˜Ÿ': 'ğŸ', 'å¼ ': 'ğŸ¦Œ', 'ç¿¼': 'ğŸ', 'è½¸': 'ğŸ›'
  };

  private starGroups: StarGroup[] = [];

  // åå•–ç»“æœ
  @State tunDanDesc1: string = '';  // åœ°ç¦½vså¤©ç¦½
  @State tunDanDesc2: string = '';  // å¤©ç¦½vsåœ°ç¦½

  // é£ä¼çŠ¶æ€
  @State feifuStatus: string = '';
  @State feifuDesc: string = '';

  // ä¸‰ç¦½åˆ†ç±»
  @State diQinType: string = '';
  @State tianQinType: string = '';
  @State strengthTags: Array<string> = [];
  @State comboHints: Array<string> = [];
  @State seasonalHints: Array<string> = [];
  @State nobleHints: Array<string> = [];
  @State panRiskHints: Array<string> = [];

  // ä¸ƒæ›œä¸å®ä¹‰ä¸“æ—¥
  @State dayQiYaoInfo: QiYaoInfo | null = null;
  @State dayInfo: CalendarDayInfo | null = null;
  @State dayLevelInfo: DayQualityEvaluation | null = null;

  aboutToAppear(): void {
    // åˆå§‹åŒ–é€‰é¡¹æ•°æ®
    for (let i = 0; i < 120; i++) {
      this.years.push((1924 + i).toString());
    }
    for (let i = 1; i <= 12; i++) {
      this.months.push(i.toString());
    }
    for (let i = 1; i <= 31; i++) {
      this.days.push(i.toString());
    }

    this.starGroups = [
      { name: 'ä¸œæ–¹é’é¾™', stars: ['è§’', 'äº¢', 'æ°', 'æˆ¿', 'å¿ƒ', 'å°¾', 'ç®µ'] },
      { name: 'åŒ—æ–¹ç„æ­¦', stars: ['æ–—', 'ç‰›', 'å¥³', 'è™š', 'å±', 'å®¤', 'å£'] },
      { name: 'è¥¿æ–¹ç™½è™', stars: ['å¥', 'å¨„', 'èƒƒ', 'æ˜‚', 'æ¯•', 'è§œ', 'å‚'] },
      { name: 'å—æ–¹æœ±é›€', stars: ['äº•', 'é¬¼', 'æŸ³', 'æ˜Ÿ', 'å¼ ', 'ç¿¼', 'è½¸'] }
    ];

    // è·å–è·¯ç”±å‚æ•°
    const params = router.getParams() as PageParams;
    if (params) {
      this.selectedYear = params.year || this.selectedYear;
      this.selectedMonth = params.month || this.selectedMonth;
      this.selectedDay = params.day || this.selectedDay;
      this.selectedHourIndex = params.hourIndex ?? this.selectedHourIndex;
    }
    this.initData();
  }

  private async initData(): Promise<void> {
    const starRules = await this.loadJsonFromRaw<YanqinStarRulesConfig>('yanqin_star_rules.json');
    const suoBo = await this.loadJsonFromRaw<SuoBoRulesConfig>('suo_bo_rules.json');

    if (starRules) {
      this.starRulesConfig = starRules;
      this.suoBoConfig = suoBo;
      this.hasLoaded = true;
      await this.calculateAll();
    }
  }

  private async loadJsonFromRaw<T>(fileName: string): Promise<T | null> {
    try {
      const value = await this.context.resourceManager.getRawFileContent(fileName);
      const str = buffer.from(value.buffer).toString();
      return ArkJSON.parse(str) as T;
    } catch (err) {
      console.error('Failed to load: ' + fileName);
      return null;
    }
  }

  private async calculateAll(): Promise<void> {
    if (!this.starRulesConfig) return;
    const cfg = this.starRulesConfig;

    // 1. è®¡ç®—å››ç¦½
    const yearResult = this.calculateYearStar(this.selectedYear, cfg);
    const monthResult = this.calculateMonthStar(this.selectedMonth, yearResult.element, cfg);
    const dayResult = this.calculateDayStar(this.selectedYear, this.selectedMonth, this.selectedDay, cfg);
    const hourResult = this.calculateHourStar(this.selectedHourIndex, dayResult.element, cfg);

    this.yuanName = dayResult.yuanName;
    this.jiangIndex = dayResult.jiangIndex;
    this.jiangStar = dayResult.jiangStar;

    // è·å–ä¸ƒæ›œä¿¡æ¯
    const qiYaoType = getQiYaoTypeFromStar(dayResult.star);
    if (qiYaoType) {
      this.dayQiYaoInfo = getQiYaoInfo(qiYaoType);
    }

    // è·å–ä¸‡å¹´å†ä¿¡æ¯å’Œå®ä¹‰ä¸“æ—¥è¯„ä¼°
    this.dayInfo = await CalendarManager.getInstance().getDayInfo(this.selectedYear, this.selectedMonth, this.selectedDay);
    if (this.dayInfo) {
      this.dayLevelInfo = evaluateDayQuality(this.dayInfo.day_gan, this.dayInfo.year_gan);
    }

    // 2. è®¡ç®—ç¿»ç¦½å’Œæ´»æ›œ
    const fanQinResult = this.calculateFanQin(dayResult.jiangStar, hourResult.star, this.selectedHourIndex, cfg);
    const huoYaoResult = this.calculateHuoYao(hourResult.star, hourResult.element, this.selectedHourIndex, cfg);

    this.wuQinResult = {
      diQin: hourResult,       // æ—¶ç¦½ = åœ°ç¦½/æˆ‘
      tianQin: fanQinResult,   // ç¿»ç¦½ = å¤©ç¦½/ä»–
      huoYao: huoYaoResult,    // æ´»æ›œ = å˜
      yearStar: yearResult,
      monthStar: monthResult,
      dayStar: { star: dayResult.star, fullName: dayResult.fullName, element: dayResult.element }
    };

    // 3. é”æ³Šæ ¼å±€åˆ¤æ–­
    const branches = cfg.branches_order;
    const diQinBranch = branches[this.selectedHourIndex];
    this.diQinSuoBo = this.judgeSuoBo(hourResult.star, diQinBranch, cfg);

    // ç¿»ç¦½è½å®«è®¡ç®—
    const jiangStarIndex = cfg.constellations_order.indexOf(dayResult.jiangStar);
    const hourStarIndex = cfg.constellations_order.indexOf(hourResult.star);
    const forwardSteps = ((hourStarIndex - jiangStarIndex) + 28) % 28;
    const tianQinBranchIndex = (this.selectedHourIndex + forwardSteps) % 12;
    const tianQinBranch = branches[tianQinBranchIndex];
    this.tianQinSuoBo = this.judgeSuoBo(fanQinResult.star, tianQinBranch, cfg);

    // æ´»æ›œè½å®«è®¡ç®—
    const flipStar = cfg.huo_yao_rules.element_to_flip_star[hourResult.element];
    const flipStarIndex = cfg.constellations_order.indexOf(flipStar);
    const backwardSteps = ((hourStarIndex - flipStarIndex) + 28) % 28;
    const hourStarBranch = ((2 - backwardSteps % 12) + 12) % 12;
    const huoYaoForwardSteps = ((this.selectedHourIndex - hourStarBranch) + 12) % 12;
    const huoYaoIndex = cfg.constellations_order.indexOf(huoYaoResult.star);
    const huoYaoBranchIndex = (hourStarBranch + huoYaoForwardSteps) % 12;
    const huoYaoBranch = branches[this.selectedHourIndex]; // æ´»æ›œè½ç”¨æ—¶
    this.huoYaoSuoBo = this.judgeSuoBo(huoYaoResult.star, huoYaoBranch, cfg);

    // 4. ç”¨ç¥é”æ³Šè®¡ç®—
    if (this.selectedUseGodStar) {
      // ç”¨ç¥è½å®«é€»è¾‘ï¼šç”¨ç¥æ³Šäºè½ç”¨æ—¶ (selectedHourIndex)
      this.useGodSuoBo = this.judgeSuoBo(this.selectedUseGodStar, branches[this.selectedHourIndex], cfg);
    } else {
      this.useGodSuoBo = null;
    }

    // 5. ä¸‰ç¦½åˆ†ç±»
    this.diQinType = this.getQinType(hourResult.star, cfg);
    this.tianQinType = this.getQinType(fanQinResult.star, cfg);

    // 5. åå•–åˆ¤æ–­
    this.tunDanDesc1 = this.judgeTunDan(hourResult.star, fanQinResult.star, cfg);
    this.tunDanDesc2 = this.judgeTunDan(fanQinResult.star, hourResult.star, cfg);

    // 6. é£ä¼åˆ¤æ–­
    const feifuResult = this.judgeFeifu(hourResult.star, this.selectedHourIndex, cfg);
    this.feifuStatus = feifuResult.status;
    this.feifuDesc = feifuResult.desc;

    // 7. åŠ›é‡æ ‡ç­¾ï¼ˆå…¥åº™ä¸å¼ºåŠ¿æ˜Ÿå®¿ï¼‰
    this.calculateStrengthTags(cfg);

    // 8. ç»„åˆæç¤ºï¼ˆä¸‰åˆ/å…­åˆï¼‰
    this.calculateComboHints();

    // 9. å››å­£æ–¹ä½æç¤ºï¼ˆé­æ˜Ÿæ–¹ç®€åŒ–ï¼‰
    this.calculateSeasonalHints(cfg);

    // 10. è´µäººå®¿æç¤º
    this.calculateNobleHints(cfg);

    // 11. ç›˜é¢å‡¶ç…ç ”ä¹ æç¤ºï¼ˆåŸºäº 15.13 ~ 15.16 æ‘˜è¦ï¼‰
    await this.calculatePanRiskHints();
  }

  // ============== å››ç¦½è®¡ç®— ==============

  private calculateYearStar(year: number, cfg: YanqinStarRulesConfig): StarCalcResult {
    const constellations = cfg.constellations_order;
    const baseYear = cfg.year_star_rules.base_year;
    const baseStar = cfg.year_star_rules.base_star;
    const baseIndex = constellations.indexOf(baseStar);
    const yearDiff = year - baseYear;
    const starIndex = ((yearDiff % 28) + 28 + baseIndex) % 28;
    const star = constellations[starIndex];
    const info = cfg.constellations_full[star];
    return { star, fullName: info.full_name, element: info.element };
  }

  private calculateMonthStar(month: number, yearElement: string, cfg: YanqinStarRulesConfig): StarCalcResult {
    const constellations = cfg.constellations_order;
    const startStar = cfg.month_star_rules.element_to_start_star[yearElement];
    const startIndex = constellations.indexOf(startStar);
    const monthIndex = (startIndex + (month - 1)) % 28;
    const star = constellations[monthIndex];
    const info = cfg.constellations_full[star];
    return { star, fullName: info.full_name, element: info.element };
  }

  private calculateDayStar(year: number, month: number, day: number, cfg: YanqinStarRulesConfig): DayStarCalcResult {
    const constellations = cfg.constellations_order;
    const dayRules = cfg.day_star_rules;
    // è§£æåŸºå‡†æ—¥æœŸå­—ç¬¦ä¸² "1984-02-02"
    const baseDateStr = dayRules.base_date.date;
    const baseParts = baseDateStr.split('-');
    const baseYear = parseInt(baseParts[0]);
    const baseMonth = parseInt(baseParts[1]);
    const baseDay = parseInt(baseParts[2]);
    // ç»Ÿä¸€ä½¿ç”¨æœ¬åœ°æ—¶é—´åˆ›å»º Date å¯¹è±¡ï¼Œé¿å…æ—¶åŒºé—®é¢˜
    const baseDate = new Date(baseYear, baseMonth - 1, baseDay);
    const targetDate = new Date(year, month - 1, day);
    const diffTime = targetDate.getTime() - baseDate.getTime();
    const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
    const posInCycle = ((diffDays % 420) + 420) % 420;
    const yuanIndex = Math.floor(posInCycle / 60);
    const posInYuan = posInCycle % 60;
    const jiangIndex = Math.floor(posInYuan / 15);
    const dayInJiang = posInYuan % 15;
    const yuanNames = ['ä¸€å…ƒ', 'äºŒå…ƒ', 'ä¸‰å…ƒ', 'å››å…ƒ', 'äº”å…ƒ', 'å…­å…ƒ', 'ä¸ƒå…ƒ'];
    const yuanName = yuanNames[yuanIndex];
    const jiangStars = dayRules.four_generals[yuanName];
    const jiangStar = jiangStars[jiangIndex];
    const jiangStarIndex = constellations.indexOf(jiangStar);
    const dayStarIndex = (jiangStarIndex + dayInJiang) % 28;
    const star = constellations[dayStarIndex];
    const info = cfg.constellations_full[star];
    return { star, fullName: info.full_name, element: info.element, yuanName, jiangIndex: jiangIndex + 1, jiangStar };
  }

  private calculateHourStar(hourIndex: number, dayElement: string, cfg: YanqinStarRulesConfig): StarCalcResult {
    const constellations = cfg.constellations_order;
    const startStar = cfg.hour_star_rules.element_to_start_star[dayElement];
    const startIndex = constellations.indexOf(startStar);
    const hourStarIndex = (startIndex + hourIndex) % 28;
    const star = constellations[hourStarIndex];
    const info = cfg.constellations_full[star];
    return { star, fullName: info.full_name, element: info.element };
  }

  // ============== ç¿»ç¦½/æ´»æ›œè®¡ç®— ==============

  private calculateFanQin(jiangStar: string, hourStar: string, hourIndex: number, cfg: YanqinStarRulesConfig): StarCalcResult {
    const constellations = cfg.constellations_order;
    const jiangStarIndex = constellations.indexOf(jiangStar);
    const hourStarIndex = constellations.indexOf(hourStar);
    const forwardSteps = ((hourStarIndex - jiangStarIndex) + 28) % 28;
    const fanQinIndex = (hourStarIndex + forwardSteps) % 28;
    const star = constellations[fanQinIndex];
    const info = cfg.constellations_full[star];
    return { star, fullName: info.full_name, element: info.element };
  }

  private calculateHuoYao(hourStar: string, hourElement: string, hourIndex: number, cfg: YanqinStarRulesConfig): StarCalcResult {
    const constellations = cfg.constellations_order;
    const flipStar = cfg.huo_yao_rules.element_to_flip_star[hourElement];
    const flipStarIndex = constellations.indexOf(flipStar);
    const hourStarIndex = constellations.indexOf(hourStar);
    const backwardSteps = ((hourStarIndex - flipStarIndex) + 28) % 28;
    const hourStarBranch = ((2 - backwardSteps % 12) + 12) % 12;
    const forwardSteps = ((hourIndex - hourStarBranch) + 12) % 12;
    const huoYaoIndex = (hourStarIndex + forwardSteps) % 28;
    const star = constellations[huoYaoIndex];
    const info = cfg.constellations_full[star];
    return { star, fullName: info.full_name, element: info.element };
  }

  // ============== é”æ³Š/åå•–/é£ä¼åˆ¤æ–­ ==============

  private judgeSuoBo(star: string, branch: string, cfg: YanqinStarRulesConfig): SuoBoResult {
    if (!this.suoBoConfig) {
      return { star, branch, environment: '', geName: 'æ— é…ç½®', geText: '', geResult: 'å¹³' };
    }
    const branchEnv = this.suoBoConfig.branch_environments[branch] as BranchEnvironment;
    const environment = branchEnv?.inner || 'æœªçŸ¥';
    const geKey = `${star}_${branch}`;
    const ge = this.suoBoConfig.suo_bo_ge[geKey] as SuoBoGe;
    if (ge) {
      return { star, branch, environment, geName: ge.name, geText: ge.text, geResult: ge.result };
    }
    const starInfo = cfg.constellations_full[star];
    return {
      star, branch, environment,
      geName: `${starInfo?.animal || star}æ³Š${environment}`,
      geText: `${starInfo?.full_name}è½${branch}å®«`,
      geResult: 'å¹³'
    };
  }

  private getQinType(star: string, cfg: YanqinStarRulesConfig): string {
    if (cfg.qin_classification.å¤©ç¦½.includes(star)) return 'å¤©ç¦½';
    if (cfg.qin_classification.æ°´ç¦½.includes(star)) return 'æ°´ç¦½';
    return 'åœ°ç¦½';
  }

  private judgeTunDan(star1: string, star2: string, cfg: YanqinStarRulesConfig): string {
    const info1 = cfg.constellations_full[star1];
    const info2 = cfg.constellations_full[star2];
    const animal1 = info1?.animal || '';
    const animal2 = info2?.animal || '';
    const foodList = cfg.tun_dan.food_map[star1] || [];
    if (foodList.length > 0) {
      if (foodList.includes('ç™¾å…½')) return `${animal1}é£Ÿç™¾å…½ï¼Œå…‹${animal2}`;
      if (foodList.includes(animal2)) return `${animal1}é£Ÿ${animal2}ï¼Œæœ‰å…‹`;
    }
    return `${animal1}ä¸é£Ÿ${animal2}`;
  }

  private judgeFeifu(star: string, hourIndex: number, cfg: YanqinStarRulesConfig): FeifuResultSimple {
    const isDayQin = cfg.ri_ye_qin.æ—¥ç¦½.includes(star);
    const isNightQin = cfg.ri_ye_qin.å¤œç¦½.includes(star);
    const isDayNightCommon = cfg.ri_ye_qin.æ—¥å¤œé€šç”¨.includes(star);
    const isDaytime = hourIndex >= 2 && hourIndex <= 9;
    const result: FeifuResultSimple = { status: '', desc: '' };
    if (isDayNightCommon) {
      result.status = 'é€š';
      result.desc = 'æ—¥å¤œé€šç”¨';
    } else if (isDaytime) {
      if (isDayQin) {
        result.status = 'é£';
        result.desc = 'æ˜¼ä¸´æ—¥ç¦½ï¼Œæ˜¾å½¢åœ¨åŠ¨';
      } else {
        result.status = 'ä¼';
        result.desc = 'æ˜¼ä¸´å¤œç¦½ï¼Œéšå½¢ä¼‘æ¯';
      }
    } else {
      if (isNightQin) {
        result.status = 'é£';
        result.desc = 'å¤œä¸´å¤œç¦½ï¼Œæ´»è·ƒ';
      } else {
        result.status = 'ä¼';
        result.desc = 'å¤œä¸´æ—¥ç¦½ï¼Œä¼‘æ¯';
      }
    }
    return result;
  }

  private calculateStrengthTags(cfg: YanqinStarRulesConfig): void {
    const tags: Array<string> = [];
    if (!this.wuQinResult || !cfg.strength_tags) {
      this.strengthTags = tags;
      return;
    }

    const baseBranches = cfg.strength_tags.base_branches;
    const strongStars = cfg.strength_tags.strong_stars;

    const pushTag = (label: string, star: string, branch: string) => {
      if (!star || !branch) {
        tags.push(`${label}ï¼šæš‚æ— ä½ç½®ä¿¡æ¯`);
        return;
      }
      const bases = baseBranches[star] || [];
      const inBase = bases.includes(branch);
      const isStrong = strongStars.includes(star);
      const descParts: Array<string> = [];
      if (inBase) {
        descParts.push('ä¸´ä¼ ç»Ÿæœ¬ä½å®«ï¼Œå‘æŒ¥è¾ƒå……åˆ†');
      }
      if (isStrong) {
        descParts.push('ä¼ ç»Ÿè§†ä½œå½±å“åŠ›è¾ƒå¼ºçš„æ˜Ÿå®¿');
      }
      if (descParts.length === 0) {
        descParts.push('è¡¨ç°ä¸­æ€§ï¼Œå¯ç»“åˆå…¶ä»–è§„åˆ™ç»¼åˆå‚è€ƒ');
      }
      tags.push(`${label}${star}ï¼ˆ${branch}å®«ï¼‰ï¼š${descParts.join('ï¼Œ')}`);
    };

    if (this.diQinSuoBo) {
      pushTag('åœ°ç¦½', this.wuQinResult.diQin.star, this.diQinSuoBo.branch);
    }
    if (this.tianQinSuoBo) {
      pushTag('å¤©ç¦½', this.wuQinResult.tianQin.star, this.tianQinSuoBo.branch);
    }
    if (this.huoYaoSuoBo) {
      pushTag('æ´»æ›œ', this.wuQinResult.huoYao.star, this.huoYaoSuoBo.branch);
    }

    this.strengthTags = tags;
  }

  private calculateComboHints(): void {
    const hints: Array<string> = [];
    if (!this.wuQinResult || !this.starRulesConfig || !this.starRulesConfig.combo_rules) {
      this.comboHints = hints;
      return;
    }

    const comboRules = this.starRulesConfig.combo_rules;
    const activeStars: Array<string> = [];
    activeStars.push(this.wuQinResult.yearStar.star);
    activeStars.push(this.wuQinResult.monthStar.star);
    activeStars.push(this.wuQinResult.dayStar.star);
    activeStars.push(this.wuQinResult.diQin.star);
    activeStars.push(this.wuQinResult.tianQin.star);
    activeStars.push(this.wuQinResult.huoYao.star);

    const containsStar = (star: string) => activeStars.includes(star);

    // ä¸‰åˆå±€æç¤º
    comboRules.sanhe_groups.forEach((group: SanheGroupConfig) => {
      let count = 0;
      group.stars.forEach((s: string) => {
        if (containsStar(s)) {
          count++;
        }
      });
      if (count >= 2) {
        hints.push(`ç»„åˆã€${group.name}ã€‘ï¼šå½“å‰å‡ºç° ${count} å®¿ï¼ˆ${group.stars.join('ã€')}ï¼‰ï¼Œ${group.safeSummary}`);
      }
    });

    // å…­åˆå¯¹æç¤º
    comboRules.liuhe_pairs.forEach((pair: LiuhePairConfig) => {
      const a = pair.stars[0];
      const b = pair.stars[1];
      if (containsStar(a) && containsStar(b)) {
        hints.push(`ç»„åˆã€${pair.name}ã€‘ï¼šåŒ…å« ${a} ä¸ ${b}ï¼Œ${pair.safeSummary}`);
      }
    });

    this.comboHints = hints;
  }

  private calculateSeasonalHints(cfg: YanqinStarRulesConfig): void {
    const hints: Array<string> = [];
    if (!this.wuQinResult || !cfg.seasonal_hints) {
      this.seasonalHints = hints;
      return;
    }

    const month = this.selectedMonth;
    let seasonKey = '';
    if (month >= 3 && month <= 5) {
      seasonKey = 'spring';
    } else if (month >= 6 && month <= 8) {
      seasonKey = 'summer';
    } else if (month >= 9 && month <= 11) {
      seasonKey = 'autumn';
    } else {
      seasonKey = 'winter';
    }

    const seasonInfo = cfg.seasonal_hints.seasons[seasonKey];
    if (!seasonInfo) {
      this.seasonalHints = hints;
      return;
    }

    // é€šç”¨æç¤º
    hints.push(`å½“å‰èŠ‚ä»¤ï¼š${seasonInfo.label}ã€‚${seasonInfo.safeSummary}`);

    // è‹¥æ—¶ç¦½åŒæ—¶è½åœ¨è¯¥å­£èŠ‚æ¨èæ–¹ä½ï¼Œåˆ™é¢å¤–æç¤ºä¸€æ¡
    if (this.diQinSuoBo && seasonInfo.branches.includes(this.diQinSuoBo.branch) && seasonInfo.stars.includes(this.wuQinResult.diQin.star)) {
      hints.push(`åœ°ç¦½${this.wuQinResult.diQin.star}è½åœ¨æ¨èæ–¹ä½ï¼ˆ${this.diQinSuoBo.branch}å®«ï¼‰ï¼Œé€‚åˆå‚è€ƒä¸ºå½“å‰ä¸»é¢˜å¸ƒç½®ç¯å¢ƒæˆ–è§„åˆ’æ–¹å‘çš„æç¤ºã€‚`);
    }

    this.seasonalHints = hints;
  }

  private calculateNobleHints(cfg: YanqinStarRulesConfig): void {
    const hints: Array<string> = [];
    if (!this.wuQinResult || !cfg.noble_star_hints) {
      this.nobleHints = hints;
      return;
    }

    const nobleItems = cfg.noble_star_hints.items;

    const pushHintForStar = (roleLabel: string, star: string, branch: string) => {
      const info = nobleItems[star];
      if (!info) {
        return;
      }
      const placeText = branch ? `ï¼ˆ${branch}å®«ï¼‰` : '';
      const text = `${roleLabel}${star}${placeText}ï¼š${info.label}ï¼Œ${info.safeSummary}`;
      hints.push(text);
    };

    // åªå–å¯¹è§£è¯»æ›´ç›´è§‚çš„å››ä¸ªè§’è‰²ï¼šæ—¥ç¦½ã€åœ°ç¦½ã€å¤©ç¦½ã€æ´»æ›œ
    const dayStar = this.wuQinResult.dayStar.star;
    if (nobleItems[dayStar]) {
      pushHintForStar('æ—¥ç¦½', dayStar, '');
    }

    if (this.diQinSuoBo && nobleItems[this.wuQinResult.diQin.star]) {
      pushHintForStar('åœ°ç¦½', this.wuQinResult.diQin.star, this.diQinSuoBo.branch);
    }
    if (this.tianQinSuoBo && nobleItems[this.wuQinResult.tianQin.star]) {
      pushHintForStar('å¤©ç¦½', this.wuQinResult.tianQin.star, this.tianQinSuoBo.branch);
    }
    if (this.huoYaoSuoBo && nobleItems[this.wuQinResult.huoYao.star]) {
      pushHintForStar('æ´»æ›œ', this.wuQinResult.huoYao.star, this.huoYaoSuoBo.branch);
    }

    this.nobleHints = hints;
  }

  private async calculatePanRiskHints(): Promise<void> {
    const hints: Array<string> = [];
    if (!this.wuQinResult) {
      this.panRiskHints = hints;
      return;
    }

    const cfg = await loadKnowledge15xConfig(this.context);
    if (!cfg || !cfg.pan_risk) {
      this.panRiskHints = hints;
      return;
    }

    const panCfg = cfg.pan_risk;

    const dayStar = this.wuQinResult.dayStar.star;
    const suoBos: Array<SuoBoResult | null> = [this.diQinSuoBo, this.tianQinSuoBo, this.huoYaoSuoBo];

    // æ— å¤´æ˜Ÿç»“æ„ï¼ˆç®€åŒ–ç‰ˆï¼‰
    const wuTouCfg = panCfg.wu_tou;
    for (let i = 0; i < suoBos.length; i++) {
      const sb = suoBos[i];
      if (sb && wuTouCfg.branches.indexOf(sb.branch) >= 0 && wuTouCfg.stars.indexOf(sb.star) >= 0) {
        let text = wuTouCfg.safeSummaryTemplate;
        text = text.replace('{{star}}', sb.star).replace('{{branch}}', sb.branch);
        hints.push(text);
        break;
      }
    }

    // å…­æ¶ç¦½æ—¥ / å¤§ç…å…­å‡¶æ—¥ï¼ˆæŒ‰æ—¥ç¦½ï¼‰
    const liuECfg = panCfg.liu_e_da_sha;
    if (liuECfg.liu_e_stars.indexOf(dayStar) >= 0 || liuECfg.da_sha_stars.indexOf(dayStar) >= 0) {
      let text = liuECfg.safeSummaryTemplate;
      text = text.replace('{{star}}', dayStar);
      hints.push(text);
    }

    // åˆ‘å®³åˆ€ç § / æ±¤ç«æ–¹å‘
    const dangerCfg = panCfg.xinghai_tanghuo;
    const dangerBranches: Array<string> = [];
    for (let i = 0; i < suoBos.length; i++) {
      const sb = suoBos[i];
      if (!sb) {
        continue;
      }
      if (dangerCfg.danger_branches.indexOf(sb.branch) >= 0) {
        if (dangerBranches.indexOf(sb.branch) < 0) {
          dangerBranches.push(sb.branch);
        }
      }
    }
    if (dangerBranches.length > 0) {
      const branchesText = dangerBranches.join('ã€');
      let text = dangerCfg.safeSummaryTemplate;
      text = text.replace('{{branches}}', branchesText);
      hints.push(text);
    }

    // ç©ºäº¡ / å¯¡äº¡æ˜Ÿç»„
    const kongWangCfg = panCfg.kong_wang_group;
    if (kongWangCfg.stars.indexOf(dayStar) >= 0) {
      let text = kongWangCfg.safeSummaryTemplate;
      text = text.replace('{{star}}', dayStar);
      hints.push(text);
    }

    this.panRiskHints = hints;
  }

  private getDateString(): string {
    return `${this.selectedYear}å¹´${this.selectedMonth}æœˆ${this.selectedDay}æ—¥`;
  }

  private getBranchName(index: number): string {
    const branches = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
    return branches[index];
  }

  private getResultColor(result: string): string {
    if (result.includes('å¤§å‰')) return '#2e7d32';
    if (result.includes('å‰')) return '#4caf50';
    if (result.includes('å¤§å‡¶')) return '#c62828';
    if (result.includes('å‡¶')) return '#ef5350';
    return '#666666';
  }

  // ============== UIæ„å»º ==============
  
  build() {
    Scroll() {
      Column() {
        // é¡¶éƒ¨å¯¼èˆª
        Row() {
          Text('â†')
            .fontSize(24)
            .fontColor('#333333')
            .onClick(() => router.back())
          Text('æ¼”ç¦½ç›˜å¼')
            .fontSize(20)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1a1a1a')
            .margin({ left: 12 })
          Blank()
          Text(`${this.yuanName}Â·ç¬¬${this.jiangIndex}å°†`)
            .fontSize(12)
            .fontColor('#888888')
        }
        .width('100%')
        .padding({ left: 16, right: 16, top: 16, bottom: 8 })

        // äº¤äº’å¼æ—¥æœŸé€‰æ‹©åŒº
        Column() {
          Row() {
            // å¹´
            Select(this.years.map((y: string): SelectOption => ({ value: y + 'å¹´' })))
              .value(this.selectedYear.toString() + 'å¹´')
              .selected(this.years.indexOf(this.selectedYear.toString()))
              .onSelect((index: number) => {
                this.selectedYear = parseInt(this.years[index]);
                this.calculateAll();
              })
              .height(32)
              .backgroundColor('#f0f0f0')
              .borderRadius(8)
            
            // æœˆ
            Select(this.months.map((m: string): SelectOption => ({ value: m + 'æœˆ' })))
              .value(this.selectedMonth.toString() + 'æœˆ')
              .selected(this.selectedMonth - 1)
              .onSelect((index: number) => {
                this.selectedMonth = index + 1;
                this.calculateAll();
              })
              .height(32)
              .backgroundColor('#f0f0f0')
              .borderRadius(8)
              .margin({ left: 4 })

            // æ—¥
            Select(this.days.map((d: string): SelectOption => ({ value: d + 'æ—¥' })))
              .value(this.selectedDay.toString() + 'æ—¥')
              .selected(this.selectedDay - 1)
              .onSelect((index: number) => {
                this.selectedDay = index + 1;
                this.calculateAll();
              })
              .height(32)
              .backgroundColor('#f0f0f0')
              .borderRadius(8)
              .margin({ left: 4 })

            // æ—¶è¾°
            Select(this.hourBranches.map((b: string): SelectOption => ({ value: b + 'æ—¶' })))
              .value(this.getBranchName(this.selectedHourIndex) + 'æ—¶')
              .selected(this.selectedHourIndex)
              .onSelect((index: number) => {
                this.selectedHourIndex = index;
                this.calculateAll();
              })
              .height(32)
              .backgroundColor('#f0f0f0')
              .borderRadius(8)
              .margin({ left: 4 })
          }
          .width('100%')
          .justifyContent(FlexAlign.Center)
          .margin({ bottom: 8 })

          // ç”¨ç¥é€‰æ‹©
          Row() {
            Text('ğŸ¯ ç„¦ç‚¹ç”¨ç¥')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#333333')
            
            Blank()
            
            Row() {
              if (this.selectedUseGodStar) {
                Text(this.starEmojiMap[this.selectedUseGodStar] || 'âœ¨')
                  .fontSize(18)
                  .margin({ right: 4 })
                Text(`${this.selectedUseGodStar}å®¿`)
                  .fontSize(14)
                  .fontColor('#d32f2f')
                  .fontWeight(FontWeight.Medium)
              } else {
                Text('æœªé€‰æ‹©')
                  .fontSize(14)
                  .fontColor('#999999')
              }
              Text(' ã€‰')
                .fontSize(14)
                .fontColor('#cccccc')
            }
            .padding({ left: 12, right: 8, top: 6, bottom: 6 })
            .backgroundColor('#f5f5f5')
            .borderRadius(20)
            .onClick(() => {
              this.isShowUseGodSheet = true;
            })
          }
          .width('100%')
          .padding({ left: 16, right: 16 })
          .margin({ bottom: 8 })
          .bindSheet(this.isShowUseGodSheet, this.UseGodPicker(), {
            height: SheetSize.MEDIUM,
            title: { title: "é€‰æ‹©ç„¦ç‚¹ç”¨ç¥", subtitle: "28æ˜Ÿå®¿åˆ†ç±»é€Ÿé€‰" },
            onDisappear: () => { this.isShowUseGodSheet = false }
          })
        }
        .width('100%')
        .margin({ bottom: 16 })
  
        if (this.hasLoaded && this.wuQinResult) {
          // ========== å››è¯¾å±•ç¤ºï¼ˆç¦æ˜Ÿèµ‹ï¼šæ—¥ç¦½ã€æ—¶ç¦½ã€ç¿»ç¦½ã€æ´»æ›œï¼‰ ==========
          Column() {
            Row() {
              Text('ã€å››è¯¾ã€‘')
                .fontSize(14)
                .fontWeight(FontWeight.Bold)
                .fontColor('#555555')
              Blank()
              Text(`å¹´ç¦½:${this.wuQinResult.yearStar.star} æœˆç¦½:${this.wuQinResult.monthStar.star}`)
                .fontSize(10)
                .fontColor('#888888')
            }
            .width('100%')
            .margin({ bottom: 10 })
        
            // å››è¯¾ç½‘æ ¼
            Grid() {
              GridItem() {
                Column() {
                  Text('ä¸€è¯¾')
                    .fontSize(10)
                    .fontColor('#888888')
                  Text(this.wuQinResult.dayStar.star)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#8b4513')
                    .margin({ top: 2 })
                  Text('æ—¥ç¦½')
                    .fontSize(9)
                    .fontColor('#666666')
                    .margin({ top: 2 })
                }
                .width('100%')
                .height('100%')
                .justifyContent(FlexAlign.Center)
                .backgroundColor('#fdf5e6')
                .borderRadius(8)
              }
        
              GridItem() {
                Column() {
                  Text('äºŒè¯¾')
                    .fontSize(10)
                    .fontColor('#888888')
                  Text(this.wuQinResult.diQin.star)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#2d5a3d')
                    .margin({ top: 2 })
                  Text('æ—¶ç¦½/æˆ‘')
                    .fontSize(9)
                    .fontColor('#666666')
                    .margin({ top: 2 })
                }
                .width('100%')
                .height('100%')
                .justifyContent(FlexAlign.Center)
                .backgroundColor('#e8f5e9')
                .borderRadius(8)
              }
        
              GridItem() {
                Column() {
                  Text('ä¸‰è¯¾')
                    .fontSize(10)
                    .fontColor('#888888')
                  Text(this.wuQinResult.tianQin.star)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#1a5276')
                    .margin({ top: 2 })
                  Text('ç¿»ç¦½/ä»–')
                    .fontSize(9)
                    .fontColor('#666666')
                    .margin({ top: 2 })
                }
                .width('100%')
                .height('100%')
                .justifyContent(FlexAlign.Center)
                .backgroundColor('#e3f2fd')
                .borderRadius(8)
              }
        
              GridItem() {
                Column() {
                  Text('å››è¯¾')
                    .fontSize(10)
                    .fontColor('#888888')
                  Text(this.wuQinResult.huoYao.star)
                    .fontSize(16)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#6a1b9a')
                    .margin({ top: 2 })
                  Text('æ´»æ›œ/å˜')
                    .fontSize(9)
                    .fontColor('#666666')
                    .margin({ top: 2 })
                }
                .width('100%')
                .height('100%')
                .justifyContent(FlexAlign.Center)
                .backgroundColor('#f3e5f5')
                .borderRadius(8)
              }
            }
            .columnsTemplate('1fr 1fr 1fr 1fr')
            .rowsTemplate('1fr')
            .columnsGap(8)
            .width('100%')
            .height(75)
          }
          .width('100%')
          .padding(14)
          .backgroundColor('#ffffff')
          .borderRadius(14)
          .margin({ left: 16, right: 16, bottom: 12 })
        
          // ========== ä¸‰ä¼ å±•ç¤ºï¼ˆç¦æ˜Ÿèµ‹ï¼šæ—¥ç¦½â†’æ—¶ç¦½â†’ç¿»ç¦½ï¼‰ ==========
          Column() {
            Text('ã€ä¸‰ä¼ ã€‘')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#555555')
              .width('100%')
              .margin({ bottom: 10 })
        
            Row() {
              // åˆä¼ ï¼šæ—¥ç¦½ï¼ˆèƒŒæ™¯/å¤§ç¯å¢ƒï¼‰
              Column() {
                Text('åˆä¼ ')
                  .fontSize(11)
                  .fontColor('#666666')
                Column() {
                  Text(this.wuQinResult.dayStar.star)
                    .fontSize(22)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#ffffff')
                  Text(this.wuQinResult.dayStar.fullName)
                    .fontSize(10)
                    .fontColor('#ffffffcc')
                    .margin({ top: 2 })
                }
                .width(60)
                .height(60)
                .justifyContent(FlexAlign.Center)
                .backgroundColor('#8b4513')
                .borderRadius(30)
                .margin({ top: 6 })
                Text('æ—¥ç¦½')
                  .fontSize(10)
                  .fontColor('#8b4513')
                  .margin({ top: 4 })
                Text('å½¼æˆ‘å…±ç”¨')
                  .fontSize(9)
                  .fontColor('#888888')
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Center)
        
              // ç®­å¤´
              Text('â†’')
                .fontSize(20)
                .fontColor('#cccccc')
                .margin({ top: 20 })
        
              // ä¸­ä¼ ï¼šæ—¶ç¦½/åœ°ç¦½ï¼ˆå½“å‰çŠ¶æ€ï¼Œä»£è¡¨æˆ‘ï¼‰
              Column() {
                Text('ä¸­ä¼ ')
                  .fontSize(11)
                  .fontColor('#666666')
                Column() {
                  Text(this.wuQinResult.diQin.star)
                    .fontSize(22)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#ffffff')
                  Text(this.wuQinResult.diQin.fullName)
                    .fontSize(10)
                    .fontColor('#ffffffcc')
                    .margin({ top: 2 })
                }
                .width(60)
                .height(60)
                .justifyContent(FlexAlign.Center)
                .backgroundColor('#2d5a3d')
                .borderRadius(30)
                .margin({ top: 6 })
                Text('æ—¶ç¦½/æˆ‘')
                  .fontSize(10)
                  .fontColor('#2d5a3d')
                  .margin({ top: 4 })
                Text(this.diQinType)
                  .fontSize(9)
                  .fontColor('#888888')
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Center)
        
              // ç®­å¤´
              Text('â†’')
                .fontSize(20)
                .fontColor('#cccccc')
                .margin({ top: 20 })
        
              // æœ«ä¼ ï¼šç¿»ç¦½/å¤©ç¦½ï¼ˆç»“æœï¼Œä»£è¡¨ä»–ï¼‰
              Column() {
                Text('æœ«ä¼ ')
                  .fontSize(11)
                  .fontColor('#666666')
                Column() {
                  Text(this.wuQinResult.tianQin.star)
                    .fontSize(22)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#ffffff')
                  Text(this.wuQinResult.tianQin.fullName)
                    .fontSize(10)
                    .fontColor('#ffffffcc')
                    .margin({ top: 2 })
                }
                .width(60)
                .height(60)
                .justifyContent(FlexAlign.Center)
                .backgroundColor('#1a5276')
                .borderRadius(30)
                .margin({ top: 6 })
                Text('ç¿»ç¦½/ä»–')
                  .fontSize(10)
                  .fontColor('#1a5276')
                  .margin({ top: 4 })
                Text(this.tianQinType)
                  .fontSize(9)
                  .fontColor('#888888')
              }
              .layoutWeight(1)
              .alignItems(HorizontalAlign.Center)
            }
            .width('100%')
          }
          .width('100%')
          .padding(14)
          .backgroundColor('#ffffff')
          .borderRadius(14)
          .margin({ left: 16, right: 16, bottom: 12 })

          // ========== ä¸ƒæ›œæ€»æ–­ä¸å®ä¹‰ä¸“æ—¥ ==========
          if (this.dayQiYaoInfo && this.dayLevelInfo) {
            this.QiYaoBaoYiZhuanCard()

            if (this.getDayStarEventHints().length > 0) {
              Column() {
                Row() {
                  Text('ğŸ“š äºŒåå…«å®¿ç”¨äº‹ç ”ä¹ ')
                    .fontSize(14)
                    .fontWeight(FontWeight.Bold)
                    .fontColor('#92400e')
                  Blank()
                  Text('ä»…é’ˆå¯¹å½“å‰æ—¥ç¦½')
                    .fontSize(11)
                    .fontColor('#fb923c')
                }
                .width('100%')
                .margin({ bottom: 6 })

                Text('æ ¹æ®ã€ŠäºŒåå…«å®¿è¯¸ç¦½æ–­è¯€ã€‹ï¼Œæ•´ç†å½“å‰æ—¥ç¦½æ˜Ÿå®¿åœ¨éƒ¨åˆ†å¸¸è§ç”¨äº‹ä¸Šçš„å€¾å‘ï¼Œä»…ä½œæ–‡åŒ–ç ”ä¹ å‚è€ƒã€‚')
                  .fontSize(11)
                  .fontColor('#92400e')
                  .width('100%')
                  .margin({ bottom: 6 })

                ForEach(this.getDayStarEventHints(), (item: StarEventEvaluation) => {
                  Column() {
                    Text(this.getStarEventLevelLabel(item.level) + ' Â· ' + item.eventName)
                      .fontSize(12)
                      .fontWeight(FontWeight.Medium)
                      .fontColor('#7c2d12')
                      .width('100%')
                    Text(item.reason)
                      .fontSize(11)
                      .fontColor('#92400e')
                      .width('100%')
                      .margin({ top: 2 })
                  }
                  .width('100%')
                  .margin({ bottom: 6 })
                })
              }
              .width('100%')
              .padding(12)
              .backgroundColor('#fffbeb')
              .borderRadius(12)
              .margin({ left: 16, right: 16, bottom: 12 })
            }
          }
  
          // ========== é”æ³ŠåäºŒå®«å›¾ ==========
          Column() {
            Text('ã€é”æ³ŠåäºŒå®«ã€‘')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#555555')
              .width('100%')
              .margin({ bottom: 10 })
  
            // åäºŒå®«å›¾å½¢å¸ƒå±€ (4x4) - ä¸Šå—ä¸‹åŒ—ï¼Œå·¦ä¸œå³è¥¿
            Grid() {
              // ç¬¬ä¸€è¡Œï¼ˆå—ï¼‰ï¼šå·³ã€åˆã€æœªã€ç”³
              GridItem() { this.SuoBoPalace('å·³', 'æ±¤', 5) }
              GridItem() { this.SuoBoPalace('åˆ', 'ç«', 6) }
              GridItem() { this.SuoBoPalace('æœª', 'é‡', 7) }
              GridItem() { this.SuoBoPalace('ç”³', 'åˆ€', 8) }
              // ç¬¬äºŒè¡Œï¼šè¾°ã€ä¸­å®«ã€ä¸­å®«ã€é…‰
              GridItem() { this.SuoBoPalace('è¾°', 'å²—', 4) }
              GridItem() { this.CenterPalace() }
              GridItem() { this.CenterPalace2() }
              GridItem() { this.SuoBoPalace('é…‰', 'ç §', 9) }
              // ç¬¬ä¸‰è¡Œï¼šå¯ã€ä¸­å®«ã€ä¸­å®«ã€æˆŒ
              GridItem() { this.SuoBoPalace('å¯', 'æ—', 3) }
              GridItem() { this.CenterPalace3() }
              GridItem() { this.CenterPalace4() }
              GridItem() { this.SuoBoPalace('æˆŒ', 'è·¯', 10) }
              // ç¬¬å››è¡Œï¼ˆåŒ—ï¼‰ï¼šå¯…ã€ä¸‘ã€å­ã€äº¥
              GridItem() { this.SuoBoPalace('å¯…', 'å±±', 2) }
              GridItem() { this.SuoBoPalace('ä¸‘', 'ç”°', 1) }
              GridItem() { this.SuoBoPalace('å­', 'æ¹–', 0) }
              GridItem() { this.SuoBoPalace('äº¥', 'æ±Ÿ', 11) }
            }
            .columnsTemplate('1fr 1fr 1fr 1fr')
            .rowsTemplate('1fr 1fr 1fr 1fr')
            .columnsGap(4)
            .rowsGap(4)
            .width('100%')
            .height(260)
          }
          .width('100%')
          .padding(14)
          .backgroundColor('#ffffff')
          .borderRadius(14)
          .margin({ left: 16, right: 16, bottom: 12 })
  
          // ========== åå•¤ç”Ÿå…‹ ==========
          Column() {
            Text('ã€åå•¤ç”Ÿå…‹ã€‘')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#555555')
              .width('100%')
              .margin({ bottom: 10 })
  
            Text(`Â· åœ°ç¦½ vs å¤©ç¦½ï¼š${this.tunDanDesc1}`)
              .fontSize(13)
              .fontColor('#444444')
              .width('100%')
              .margin({ bottom: 6 })
  
            Text(`Â· å¤©ç¦½ vs åœ°ç¦½ï¼š${this.tunDanDesc2}`)
              .fontSize(13)
              .fontColor('#444444')
              .width('100%')
          }
          .width('100%')
          .padding(14)
          .backgroundColor('#ffffff')
          .borderRadius(14)
          .margin({ left: 16, right: 16, bottom: 12 })
  
          // ========== é£ä¼åŠ¨é™ ==========
          Column() {
            Text('ã€é£ä¼åŠ¨é™ã€‘')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#555555')
              .width('100%')
              .margin({ bottom: 10 })
          
            Row() {
              Text(`æ—¶ç¦½ ${this.wuQinResult.diQin.star}`)
                .fontSize(13)
                .fontColor('#333333')
              Text(this.feifuStatus)
                .fontSize(18)
                .fontWeight(FontWeight.Bold)
                .fontColor(this.feifuStatus === 'é£' ? '#2e7d32' : '#ef6c00')
                .margin({ left: 8 })
              Text(`ï¼ˆ${this.feifuDesc}ï¼‰`)
                .fontSize(12)
                .fontColor('#666666')
                .margin({ left: 8 })
            }
            .width('100%')
            .margin({ bottom: 8 })

            if (this.selectedUseGodStar && this.useGodSuoBo) {
              Divider().margin({ top: 4, bottom: 8 })
              Row() {
                Text('ğŸ¯ ç„¦ç‚¹ç”¨ç¥ï¼š')
                  .fontSize(13)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#d32f2f')
                Text(this.selectedUseGodStar)
                  .fontSize(15)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#d32f2f')
                Text(`æ³Šã€Œ${this.useGodSuoBo.branch}ã€${this.useGodSuoBo.environment}å®«`)
                  .fontSize(13)
                  .fontColor('#333333')
                  .margin({ left: 8 })
              }
              .width('100%')
              .margin({ bottom: 4 })

              Text(`æ–­è¯­ï¼š${this.useGodSuoBo.geName} (${this.useGodSuoBo.geResult})`)
                .fontSize(12)
                .fontColor(this.getResultColor(this.useGodSuoBo.geResult))
                .fontWeight(FontWeight.Medium)
                .width('100%')
              
              Text(this.useGodSuoBo.geText)
                .fontSize(11)
                .fontColor('#666666')
                .width('100%')
                .margin({ top: 2 })
            }
          }
          .width('100%')
          .padding(14)
          .backgroundColor('#ffffff')
          .borderRadius(14)
          .margin({ left: 16, right: 16, bottom: 12 })
          
          // ========== åŠ›é‡æç¤ºï¼ˆå…¥åº™ä¸å¼ºåŠ¿æ˜Ÿå®¿ï¼‰ ==========
          if (this.strengthTags.length > 0) {
            Column() {
              Row() {
                Text('âš¡ åŠ›é‡æç¤º')
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#2e7d32')
                Blank()
                Text('å…¥åº™ Â· æœ¬ä½ Â· å¼ºåŠ¿æ˜Ÿä¸€è§ˆ')
                  .fontSize(11)
                  .fontColor('#4caf50')
              }
              .width('100%')
              .margin({ bottom: 8 })

              Text('æ ¹æ®ä¼ ç»Ÿå…¥åº™æœ¬ä½ä¸å¼ºåŠ¿æ˜Ÿå®¿ï¼Œæ ‡å‡ºå½“å‰ç›˜ä¸­æ›´å®¹æ˜“è¢«å…³æ³¨çš„ä½ç½®ï¼Œä»…ä½œæ–‡åŒ–ç ”ä¹ å‚è€ƒã€‚')
                .fontSize(11)
                .fontColor('#666666')
                .width('100%')
                .margin({ bottom: 8 })

              ForEach(this.strengthTags, (item: string) => {
                Row() {
                  Text('â—')
                    .fontSize(10)
                    .fontColor('#2e7d32')
                  Text(item)
                    .fontSize(12)
                    .fontColor('#333333')
                    .margin({ left: 4 })
                }
                .width('100%')
                .margin({ bottom: 4 })
              })
            }
            .width('100%')
            .padding(14)
            .backgroundColor('#f1f8e9')
            .borderRadius(14)
            .margin({ left: 16, right: 16, bottom: 12 })
          }

          // ========== ç»„åˆæç¤ºï¼ˆä¸‰åˆ / å…­åˆï¼‰ ==========
          if (this.comboHints.length > 0) {
            Column() {
              Row() {
                Text('ğŸ¤ ç»„åˆæç¤º')
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#1565c0')
                Blank()
                Text('ä¸‰åˆå±€ Â· å…­åˆå¯¹')
                  .fontSize(11)
                  .fontColor('#1e88e5')
              }
              .width('100%')
              .margin({ bottom: 8 })

              Text('æ ¹æ®ä¼ ç»Ÿä¸‰åˆå±€ä¸ç»„åˆå…³ç³»ï¼Œæç¤ºç›˜ä¸­å“ªäº›æ˜Ÿå®¿å½¼æ­¤å‘¼åº”ï¼Œä»…ä½œç»“æ„ç†è§£ä¸æ–‡åŒ–ç ”ä¹ å‚è€ƒã€‚')
                .fontSize(11)
                .fontColor('#666666')
                .width('100%')
                .margin({ bottom: 8 })

              ForEach(this.comboHints, (item: string) => {
                Row() {
                  Text('â—')
                    .fontSize(10)
                    .fontColor('#1565c0')
                  Text(item)
                    .fontSize(12)
                    .fontColor('#333333')
                    .margin({ left: 4 })
                }
                .width('100%')
                .margin({ bottom: 4 })
              })
            }
            .width('100%')
            .padding(14)
            .backgroundColor('#e3f2fd')
            .borderRadius(14)
            .margin({ left: 16, right: 16, bottom: 12 })
          }

          // ========== å››å­£æ–¹ä½æç¤ºï¼ˆé­æ˜Ÿæ–¹ç®€åŒ–ï¼‰ ==========
          if (this.seasonalHints.length > 0) {
            Column() {
              Row() {
                Text('ğŸ§­ å››å­£æ–¹ä½æç¤º')
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#ef6c00')
                Blank()
                Text('æ—¶ä»¤ Â· æ–¹ä½å‚è€ƒ')
                  .fontSize(11)
                  .fontColor('#fb8c00')
              }
              .width('100%')
              .margin({ bottom: 8 })

              ForEach(this.seasonalHints, (item: string) => {
                Row() {
                  Text('â—')
                    .fontSize(10)
                    .fontColor('#ef6c00')
                  Text(item)
                    .fontSize(12)
                    .fontColor('#333333')
                    .margin({ left: 4 })
                }
                .width('100%')
                .margin({ bottom: 4 })
              })
            }
            .width('100%')
            .padding(14)
            .backgroundColor('#fff3e0')
            .borderRadius(14)
            .margin({ left: 16, right: 16, bottom: 12 })
          }

          // ========== å‡¶ç…ç ”ä¹ æç¤ºï¼ˆ15.x æ‘˜è¦ï¼‰ ==========
          if (this.panRiskHints.length > 0) {
            Column() {
              Row() {
                Text('âš ï¸ å‡¶ç…ç ”ä¹ æç¤º')
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#b91c1c')
                Blank()
                Text('ä»…æ ‡è®°ç»å…¸æ ¼å±€ï¼Œä¾›å­¦ä¹ ä½¿ç”¨')
                  .fontSize(11)
                  .fontColor('#f97316')
              }
              .width('100%')
              .margin({ bottom: 8 })

              Text('ä¸‹åˆ—æç¤ºä»…ç”¨äºæŒ‡å‘ 15.13 ~ 15.16 ç­‰æ–‡æ¡£ä¸­æè¿°çš„å…¸å‹ç›˜é¢ç»“æ„ï¼Œå¸®åŠ©åœ¨çœŸå®ç›˜é¢ä¸­æ‰¾åˆ°å¯¹åº”æ¡ˆä¾‹ï¼Œä¸å‚ä¸ç»“æœåˆ¤æ–­ã€‚')
                .fontSize(11)
                .fontColor('#6b7280')
                .width('100%')
                .margin({ bottom: 8 })

              ForEach(this.panRiskHints, (item: string) => {
                Row() {
                  Text('â—')
                    .fontSize(10)
                    .fontColor('#b91c1c')
                  Text(item)
                    .fontSize(12)
                    .fontColor('#111827')
                    .margin({ left: 4 })
                }
                .width('100%')
                .margin({ bottom: 4 })
              })
            }
            .width('100%')
            .padding(14)
            .backgroundColor('#fef2f2')
            .borderRadius(14)
            .margin({ left: 16, right: 16, bottom: 12 })
          }

          // ========== è´µäººå®¿æç¤º ==========
          if (this.nobleHints.length > 0) {
            Column() {
              Row() {
                Text('â­ è´µäººå®¿æç¤º')
                  .fontSize(14)
                  .fontWeight(FontWeight.Bold)
                  .fontColor('#8e24aa')
                Blank()
                Text('è§’è‰²å€¾å‘ Â· ååŠ©æ°›å›´')
                  .fontSize(11)
                  .fontColor('#ab47bc')
              }
              .width('100%')
              .margin({ bottom: 8 })

              Text('æ ¹æ®ä¼ ç»Ÿç¦½æ˜Ÿè´µäººå®¿ï¼Œåªæè¿°è§’è‰²å€¾å‘ä¸ååŠ©æ°›å›´ï¼Œç”¨äºæ–‡åŒ–ç ”ä¹ å‚è€ƒã€‚')
                .fontSize(11)
                .fontColor('#666666')
                .width('100%')
                .margin({ bottom: 8 })

              ForEach(this.nobleHints, (item: string) => {
                Row() {
                  Text('â—')
                    .fontSize(10)
                    .fontColor('#8e24aa')
                  Text(item)
                    .fontSize(12)
                    .fontColor('#333333')
                    .margin({ left: 4 })
                }
                .width('100%')
                .margin({ bottom: 4 })
              })
            }
            .width('100%')
            .padding(14)
            .backgroundColor('#f3e5f5')
            .borderRadius(14)
            .margin({ left: 16, right: 16, bottom: 12 })
          }

          // ========== ç¦½æœºèµ‹æ–­è¯­ ==========
          Column() {
            Text('ã€ç¦½æœºèµ‹æ–­è¯­ã€‘')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#555555')
              .width('100%')
              .margin({ bottom: 10 })

            // ç¦½æ˜Ÿå±æ€§
            Text(`â— ç¦½æ˜Ÿå±æ€§`)
              .fontSize(12)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .width('100%')
              .margin({ bottom: 6 })

            Text(`Â· åœ°ç¦½ ${this.wuQinResult.diQin.star}ï¼š${this.getQinAttribute(this.wuQinResult.diQin.star)}`)
              .fontSize(12)
              .fontColor('#444444')
              .width('100%')
              .margin({ bottom: 4 })

            Text(`Â· å¤©ç¦½ ${this.wuQinResult.tianQin.star}ï¼š${this.getQinAttribute(this.wuQinResult.tianQin.star)}`)
              .fontSize(12)
              .fontColor('#444444')
              .width('100%')
              .margin({ bottom: 4 })

            Text(`Â· æ´»æ›œ ${this.wuQinResult.huoYao.star}ï¼š${this.getQinAttribute(this.wuQinResult.huoYao.star)}`)
              .fontSize(12)
              .fontColor('#444444')
              .width('100%')
              .margin({ bottom: 10 })

            // å¾—åœ°/å¤±é™·åˆ¤æ–­
            Text(`â— å¾—åœ°å¤±é™·`)
              .fontSize(12)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .width('100%')
              .margin({ bottom: 6 })

            Text(`${this.getDeDeJudgment()}`)
              .fontSize(12)
              .fontColor('#444444')
              .width('100%')
              .margin({ bottom: 10 })

            // ç‰¹æ®Šæ ¼å±€
            if (this.getSpecialPattern()) {
              Text(`â— ç‰¹æ®Šæ ¼å±€`)
                .fontSize(12)
                .fontWeight(FontWeight.Medium)
                .fontColor('#333333')
                .width('100%')
                .margin({ bottom: 6 })

              Text(`${this.getSpecialPattern()}`)
                .fontSize(12)
                .fontColor('#c62828')
                .fontWeight(FontWeight.Medium)
                .width('100%')
                .margin({ bottom: 10 })
            }

            // æ˜¼å¤œè§„åˆ™
            Text(`â— æ˜¼å¤œåŠ¨é™`)
              .fontSize(12)
              .fontWeight(FontWeight.Medium)
              .fontColor('#333333')
              .width('100%')
              .margin({ bottom: 6 })

            Text(`${this.getDayNightRule()}`)
              .fontSize(12)
              .fontColor('#444444')
              .width('100%')
          }
          .width('100%')
          .padding(14)
          .backgroundColor('#fffbf0')
          .borderRadius(14)
          .margin({ left: 16, right: 16, bottom: 12 })

          // ========== æ˜Ÿå®¿ç‰©è±¡ ==========
          Column() {
            Text('ã€æ˜Ÿå®¿ç‰©è±¡ã€‘')
              .fontSize(14)
              .fontWeight(FontWeight.Bold)
              .fontColor('#555555')
              .width('100%')
              .margin({ bottom: 6 })

            Text('å‡ºè‡ªã€Šå°„è¦†ç„æœºèµ‹ã€‹â€” æ–‡åŒ–çŸ¥è¯†å‚è€ƒ')
              .fontSize(10)
              .fontColor('#888888')
              .width('100%')
              .margin({ bottom: 10 })

            // åœ°ç¦½ç‰©è±¡
            this.StarImageryItem('åœ°ç¦½', this.wuQinResult.diQin.star, '#2d5a3d')

            // å¤©ç¦½ç‰©è±¡
            this.StarImageryItem('å¤©ç¦½', this.wuQinResult.tianQin.star, '#1a5276')

            // æ´»æ›œç‰©è±¡
            this.StarImageryItem('æ´»æ›œ', this.wuQinResult.huoYao.star, '#6a1b9a')

            // ç”¨ç¥ç‰©è±¡
            if (this.selectedUseGodStar) {
              this.StarImageryItem('ç”¨ç¥', this.selectedUseGodStar, '#d32f2f')
            }
          }
          .width('100%')
          .padding(14)
          .backgroundColor('#f5f5f5')
          .borderRadius(14)
          .margin({ left: 16, right: 16, bottom: 12 })

          // å…è´£å£°æ˜
          Text('âˆ— ä»¥ä¸Šå†…å®¹ä»…ä¾›ä¼ ç»Ÿæ–‡åŒ–ç ”ä¹ å‚è€ƒï¼Œä¸æ„æˆä»»ä½•ç°å®æŒ‡å¯¼ã€‚')
            .fontSize(11)
            .fontColor('#aaaaaa')
            .margin({ top: 8, bottom: 32 })
            .textAlign(TextAlign.Center)
            .width('100%')
        } else {
          // åŠ è½½ä¸­
          Column() {
            LoadingProgress()
              .width(40)
              .height(40)
              .color('#888888')
            Text('æ­£åœ¨åŠ è½½...')
              .fontSize(14)
              .fontColor('#888888')
              .margin({ top: 12 })
          }
          .width('100%')
          .height(300)
          .justifyContent(FlexAlign.Center)
        }
      }
      .width('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f5f5f5')
  }
  
  // ============== é”æ³Šå®«ä½ç»„ä»¶ - å¤©åœ°ç›˜åŒå±‚å±•ç¤º ==============
  
  @Builder
  UseGodPicker() {
    Column() {
      Scroll() {
        Column() {
          // é‡ç½®é€‰é¡¹
          Row() {
            Text('æ¸…é™¤å½“å‰é€‰æ‹©')
              .fontSize(13)
              .fontColor('#666666')
              .padding({ left: 12, right: 12, top: 6, bottom: 6 })
              .backgroundColor('#eeeeee')
              .borderRadius(16)
              .onClick(() => {
                this.selectedUseGodStar = '';
                this.calculateAll();
                this.isShowUseGodSheet = false;
              })
          }
          .width('100%')
          .justifyContent(FlexAlign.End)
          .padding({ right: 16, top: 10, bottom: 4 })

          ForEach(this.starGroups, (group: StarGroup) => {
            Column() {
              Text(group.name)
                .fontSize(13)
                .fontWeight(FontWeight.Bold)
                .fontColor('#666666')
                .width('100%')
                .margin({ top: 16, bottom: 8, left: 16 })

              Grid() {
                ForEach(group.stars, (star: string) => {
                  GridItem() {
                    Column() {
                      Text(this.starEmojiMap[star] || 'âœ¨')
                        .fontSize(24)
                      Text(star)
                        .fontSize(12)
                        .fontColor(this.selectedUseGodStar === star ? '#ffffff' : '#333333')
                        .margin({ top: 4 })
                    }
                    .width('100%')
                    .padding({ top: 10, bottom: 10 })
                    .backgroundColor(this.selectedUseGodStar === star ? '#d32f2f' : '#ffffff')
                    .borderRadius(12)
                    .border({ width: 1, color: this.selectedUseGodStar === star ? '#d32f2f' : '#eeeeee' })
                    .onClick(() => {
                      this.selectedUseGodStar = star;
                      this.calculateAll();
                      this.isShowUseGodSheet = false;
                    })
                  }
                })
              }
              .columnsTemplate('1fr 1fr 1fr 1fr')
              .columnsGap(8)
              .rowsGap(8)
              .padding({ left: 16, right: 16 })
              .height(160) // 7ä¸ªæ˜Ÿå®¿ä¸¤è¡Œé«˜åº¦
            }
          })
          
          // åº•éƒ¨ç•™ç™½ï¼Œé˜²æ­¢è¢«ç³»ç»Ÿæ‰‹åŠ¿æ é®æŒ¡
          Row().height(40).width('100%')
        }
        .width('100%')
      }
      .scrollable(ScrollDirection.Vertical)
      .scrollBar(BarState.Auto)
      .width('100%')
      .height('100%')
    }
    .width('100%')
    .height('100%')
    .backgroundColor('#f7f7f7')
  }

  // ç©ºå®«ä½
  @Builder
  EmptyPalace() {
    Column() {}
    .width('100%')
    .height('100%')
    .backgroundColor('#fafafa')
    .borderRadius(6)
  }

  // é”æ³Šå®«ä½ç»„ä»¶ - å¤©åœ°ç›˜åŒå±‚å±•ç¤º
  @Builder
  SuoBoPalace(branch: string, env: string, branchIndex: number) {
    Column() {
      // åœ°æ”¯+ç¯å¢ƒå
      Text(`${branch}${env}`)
        .fontSize(10)
        .fontColor('#555555')
        .margin({ bottom: 2 })
      
      // å¤©ç›˜ï¼ˆç¿»ç¦½ï¼‰
      if (this.getStarInBranchByType(branchIndex, 'tian')) {
        Row() {
          Text('å¤©')
            .fontSize(8)
            .fontColor('#ffffff')
            .backgroundColor('#1a5276')
            .borderRadius(2)
            .padding({ left: 2, right: 2 })
          Text(this.getStarInBranchByType(branchIndex, 'tian'))
            .fontSize(10)
            .fontWeight(FontWeight.Bold)
            .fontColor('#1a5276')
            .margin({ left: 2 })
        }
        .justifyContent(FlexAlign.Center)
      }
      
      // åœ°ç›˜ï¼ˆæ—¶ç¦½ï¼‰
      if (this.getStarInBranchByType(branchIndex, 'di')) {
        Row() {
          Text('åœ°')
            .fontSize(8)
            .fontColor('#ffffff')
            .backgroundColor('#2d5a3d')
            .borderRadius(2)
            .padding({ left: 2, right: 2 })
          Text(this.getStarInBranchByType(branchIndex, 'di'))
            .fontSize(10)
            .fontWeight(FontWeight.Bold)
            .fontColor('#2d5a3d')
            .margin({ left: 2 })
        }
        .justifyContent(FlexAlign.Center)
      }
      
      // äººç›˜ï¼ˆæ´»æ›œï¼‰
      if (this.getStarInBranchByType(branchIndex, 'huo')) {
        Row() {
          Text('äºº')
            .fontSize(8)
            .fontColor('#ffffff')
            .backgroundColor('#6a1b9a')
            .borderRadius(2)
            .padding({ left: 2, right: 2 })
          Text(this.getStarInBranchByType(branchIndex, 'huo'))
            .fontSize(10)
            .fontWeight(FontWeight.Bold)
            .fontColor('#6a1b9a')
            .margin({ left: 2 })
        }
        .justifyContent(FlexAlign.Center)
      }
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor(this.getBranchBgColor(branchIndex))
    .borderRadius(6)
    .border({ 
      width: this.isUseGodInBranch(branchIndex) ? 2 : 1, 
      color: this.isUseGodInBranch(branchIndex) ? '#d32f2f' : '#e0e0e0' 
    })
    .shadow(this.isUseGodInBranch(branchIndex) ? { radius: 10, color: '#ffcdd2', offsetX: 0, offsetY: 0 } : null)
  }

  // åˆ¤æ–­ç”¨ç¥æ˜¯å¦åœ¨è¯¥å®«ä½
  private isUseGodInBranch(branchIndex: number): boolean {
    if (!this.selectedUseGodStar) return false;
    const branches = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
    return this.useGodSuoBo !== null && this.useGodSuoBo.branch === branches[branchIndex];
  }
  
  // ä¸­å®«å·¦ï¼šåœ°ç¦½ä¿¡æ¯
  @Builder
  CenterPalace() {
    Column() {
      Text('åœ°ç¦½')
        .fontSize(10)
        .fontColor('#2d5a3d')
      Text(this.wuQinResult?.diQin.star || '')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor('#2d5a3d')
      Text(this.diQinSuoBo?.geName || '')
        .fontSize(9)
        .fontColor('#666666')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#e8f5e9')
    .borderRadius(6)
  }
  
  // ä¸­å®«å³ï¼šå¤©ç¦½ä¿¡æ¯
  @Builder
  CenterPalace2() {
    Column() {
      Text('å¤©ç¦½')
        .fontSize(10)
        .fontColor('#1a5276')
      Text(this.wuQinResult?.tianQin.star || '')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor('#1a5276')
      Text(this.tianQinSuoBo?.geName || '')
        .fontSize(9)
        .fontColor('#666666')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#e3f2fd')
    .borderRadius(6)
  }

  // ä¸­å®«å·¦ä¸‹ï¼šæ´»æ›œä¿¡æ¯
  @Builder
  CenterPalace3() {
    Column() {
      Text('æ´»æ›œ')
        .fontSize(10)
        .fontColor('#6a1b9a')
      Text(this.wuQinResult?.huoYao.star || '')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor('#6a1b9a')
      Text(this.huoYaoSuoBo?.geName || '')
        .fontSize(9)
        .fontColor('#666666')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#f3e5f5')
    .borderRadius(6)
  }

  // ä¸­å®«å³ä¸‹ï¼šæ—¥ç¦½ä¿¡æ¯
  @Builder
  CenterPalace4() {
    Column() {
      Text('æ—¥ç¦½')
        .fontSize(10)
        .fontColor('#8b4513')
      Text(this.wuQinResult?.dayStar.star || '')
        .fontSize(14)
        .fontWeight(FontWeight.Bold)
        .fontColor('#8b4513')
      Text(`${this.yuanName}`)
        .fontSize(9)
        .fontColor('#666666')
    }
    .width('100%')
    .height('100%')
    .justifyContent(FlexAlign.Center)
    .backgroundColor('#fdf5e6')
    .borderRadius(6)
  }
  
  // è·å–æŸå®«ä½ä¸­æŒ‡å®šç±»å‹çš„ç¦½æ˜Ÿ
  private getStarInBranchByType(branchIndex: number, type: string): string {
    const branches = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
    const branch = branches[branchIndex];
    
    if (type === 'tian' && this.tianQinSuoBo && this.tianQinSuoBo.branch === branch) {
      return this.tianQinSuoBo.star;
    }
    if (type === 'di' && this.diQinSuoBo && this.diQinSuoBo.branch === branch) {
      return this.diQinSuoBo.star;
    }
    if (type === 'huo' && this.huoYaoSuoBo && this.huoYaoSuoBo.branch === branch) {
      return this.huoYaoSuoBo.star;
    }
    return '';
  }

  // è·å–æŸå®«ä½ä¸­çš„ç¦½æ˜Ÿï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰
  private getStarInBranch(branchIndex: number): string {
    if (!this.diQinSuoBo && !this.tianQinSuoBo && !this.huoYaoSuoBo) return '';
    const branches = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
    const branch = branches[branchIndex];
    const stars: Array<string> = [];
    if (this.diQinSuoBo && this.diQinSuoBo.branch === branch) {
      stars.push(this.diQinSuoBo.star);
    }
    if (this.tianQinSuoBo && this.tianQinSuoBo.branch === branch) {
      stars.push(this.tianQinSuoBo.star);
    }
    if (this.huoYaoSuoBo && this.huoYaoSuoBo.branch === branch) {
      stars.push(this.huoYaoSuoBo.star);
    }
    return stars.join(',');
  }
  
  // è·å–ç¦½æ˜Ÿé¢œè‰²ï¼ˆå…¼å®¹æ—§ç‰ˆï¼‰
  private getStarColor(branchIndex: number): string {
    return '#333333';
  }
  
  // è·å–å®«ä½èƒŒæ™¯è‰²
  private getBranchBgColor(branchIndex: number): string {
    if (!this.diQinSuoBo && !this.tianQinSuoBo && !this.huoYaoSuoBo) return '#fafafa';
    const branches = ['å­', 'ä¸‘', 'å¯…', 'å¯', 'è¾°', 'å·³', 'åˆ', 'æœª', 'ç”³', 'é…‰', 'æˆŒ', 'äº¥'];
    const branch = branches[branchIndex];
    if (this.diQinSuoBo && this.diQinSuoBo.branch === branch) return '#e8f5e9';
    if (this.tianQinSuoBo && this.tianQinSuoBo.branch === branch) return '#e3f2fd';
    if (this.huoYaoSuoBo && this.huoYaoSuoBo.branch === branch) return '#f3e5f5';
    return '#fafafa';
  }
  
  @Builder
  SuoBoItem(label: string, result: SuoBoResult) {
    Row() {
      Text(`Â· ${label}`)
        .fontSize(13)
        .fontColor('#333333')
        .width(50)
      Text(`${result.star}`)
        .fontSize(13)
        .fontWeight(FontWeight.Medium)
        .fontColor('#333333')
      Text(`æ³Šã€Œ${result.branch}ã€${result.environment}å®«`)
        .fontSize(12)
        .fontColor('#666666')
        .margin({ left: 4 })
      Text('â†’')
        .fontSize(12)
        .fontColor('#888888')
        .margin({ left: 4 })
      Text(result.geName)
        .fontSize(12)
        .fontColor(this.getResultColor(result.geResult))
        .fontWeight(FontWeight.Medium)
        .margin({ left: 4 })
      Text(`(${result.geResult})`)
        .fontSize(11)
        .fontColor(this.getResultColor(result.geResult))
        .margin({ left: 4 })
    }
    .width('100%')
    .margin({ bottom: 8 })
  }

  // ============== ç¦½æœºèµ‹æ–­è¯­æ–¹æ³• ==============

  // è·å–ç¦½æ˜Ÿå±æ€§ï¼ˆæ—¥ç¦½/å¤œç¦½/æ°´ç¦½/å±±ç¦½ç­‰ï¼‰
  private getQinAttribute(star: string): string {
    // æ—¥ç¦½ï¼šé¸¡ã€é›‰ã€ç‡•ã€ä¹Œã€è›‡
    const dayBirds = ['æ˜‚', 'èƒƒ', 'å±', 'æ¯•', 'ç¿¼'];
    // å¤œç¦½ï¼šé¼ ã€è ã€è²‰ã€ç‹
    const nightBirds = ['è™š', 'å¥³', 'æ°', 'å¿ƒ'];
    // æ°´ç¦½ï¼šè›Ÿã€é¾™ã€è²”ã€è›“
    const waterBirds = ['è§’', 'äº¢', 'å£', 'è½¸'];
    // å±±ç¦½ï¼šè™ã€è±¹ã€ç‹¼ã€çŒ´ã€çŒ¿ã€çã€é¹¿
    const mountainBirds = ['å°¾', 'ç®µ', 'å¥ˆ', 'è§œ', 'å‚', 'æŸ³', 'å¼ '];
    // å®¶ç¦½ï¼šç‰›ã€çŒªã€ç¾Šã€é©¬ã€ç‹—ã€é¸¡
    const farmBirds = ['ç‰›', 'å®¤', 'é¬¼', 'æ˜Ÿ', 'å¨„', 'æ˜‚'];

    const attrs: Array<string> = [];
    if (dayBirds.includes(star)) attrs.push('æ—¥ç¦½ï¼ˆæ˜¼é£å¤œå®¿ï¼‰');
    if (nightBirds.includes(star)) attrs.push('å¤œç¦½ï¼ˆæ˜¼æ½œå¤œåŠ¨ï¼‰');
    if (waterBirds.includes(star)) attrs.push('æ°´ç¦½ï¼ˆå®œæ±Ÿæ¹–ï¼‰');
    if (mountainBirds.includes(star)) attrs.push('å±±ç¦½ï¼ˆå®œå±±æ—ï¼‰');
    if (farmBirds.includes(star)) attrs.push('å®¶ç¦½ï¼ˆå®œå¹³åœ°ï¼‰');

    return attrs.length > 0 ? attrs.join('ã€') : 'æ™®é€šç¦½æ˜Ÿ';
  }

  // å¾—åœ°/å¤±é™·åˆ¤æ–­
  private getDeDeJudgment(): string {
    const results: Array<string> = [];

    // åœ°ç¦½åˆ¤æ–­
    if (this.diQinSuoBo) {
      const diResult = this.judgeDeDeByRule(this.wuQinResult!.diQin.star, this.diQinSuoBo.branch);
      if (diResult) results.push(`åœ°ç¦½${diResult}`);
    }

    // å¤©ç¦½åˆ¤æ–­
    if (this.tianQinSuoBo) {
      const tianResult = this.judgeDeDeByRule(this.wuQinResult!.tianQin.star, this.tianQinSuoBo.branch);
      if (tianResult) results.push(`å¤©ç¦½${tianResult}`);
    }

    // æ´»æ›œåˆ¤æ–­
    if (this.huoYaoSuoBo) {
      const huoResult = this.judgeDeDeByRule(this.wuQinResult!.huoYao.star, this.huoYaoSuoBo.branch);
      if (huoResult) results.push(`æ´»æ›œ${huoResult}`);
    }

    return results.length > 0 ? results.join('ï¼›') : 'æœªå‘ç°æ˜æ˜¾å¾—åœ°æˆ–å¤±é™·';
  }

  // æ ¹æ®ç¦„æœºèµ‹è§„åˆ™åˆ¤æ–­å¾—åœ°å¤±é™·
  private judgeDeDeByRule(star: string, branch: string): string {
    // æ°´ç¦½å¾—æ°´
    const waterBirds = ['è§’', 'äº¢', 'å£', 'è½¸'];
    const waterBranches = ['äº¥', 'å­'];
    if (waterBirds.includes(star) && waterBranches.includes(branch)) {
      return `${star}æ³Š${branch}ï¼šå¾—åœ°ï¼ˆè›Ÿé¾™å¾—æ°´ï¼Œå¦‚é±¼å¾—æ°´ï¼‰`;
    }

    // å±±ç¦½å¾—å±±
    const mountainBirds = ['å°¾', 'ç®µ', 'å¥ˆ', 'è§œ', 'å‚', 'æŸ³', 'å¼ '];
    const mountainBranches = ['å¯…', 'å¯'];
    if (mountainBirds.includes(star) && mountainBranches.includes(branch)) {
      return `${star}æ³Š${branch}ï¼šå¾—åœ°ï¼ˆè™è±¹å…¥å±±æ—ï¼Œå¨é£å‡›å‡›ï¼‰`;
    }

    // è™ç‹¼ä¸ä¸‹æ°´
    const tigerWolf = ['å°¾', 'ç®µ', 'å¥ˆ'];
    if (tigerWolf.includes(star) && waterBranches.includes(branch)) {
      return `${star}æ³Š${branch}ï¼šå¤±é™·ï¼ˆè™ç‹¼ä¸ä¸‹æ°´ï¼‰`;
    }

    // è›Ÿé¾™ä¸ä¸Šå±±
    const dragons = ['è§’', 'äº¢'];
    if (dragons.includes(star) && mountainBranches.includes(branch)) {
      return `${star}æ³Š${branch}ï¼šå¤±é™·ï¼ˆè›Ÿé¾™ä¸ä¸Šå±±ï¼‰`;
    }

    // çŒªç¾Šå¿Œæ±Ÿæ¹–
    const pigSheep = ['å®¤', 'é¬¼'];
    if (pigSheep.includes(star) && waterBranches.includes(branch)) {
      return `${star}æ³Š${branch}ï¼šå¤±é™·ï¼ˆçŒªç¾Šé¡»å¿Œæ±Ÿæ¹–ï¼‰`;
    }

    // å®¶ç¦½å¾—ç”°
    const farmBirds = ['ç‰›', 'å®¤', 'é¬¼', 'æ˜Ÿ', 'å¨„', 'æ˜‚'];
    const farmBranches = ['ä¸‘', 'æœª'];
    if (farmBirds.includes(star) && farmBranches.includes(branch)) {
      return `${star}æ³Š${branch}ï¼šå¾—åœ°ï¼ˆå®¶ç¦½å®œå±…å¹³åœ°ï¼‰`;
    }

    // ç¦½å…¥åˆ€ç §
    const knifeBranches = ['åˆ', 'æœª', 'ç”³', 'é…‰'];
    if (knifeBranches.includes(branch)) {
      return `${star}æ³Š${branch}ï¼šæ³¨æ„ï¼ˆç¦½å…¥åˆ€ç §ï¼Œææœ‰æŸä¼¤ï¼‰`;
    }

    return '';
  }

  // è·å–ç‰¹æ®Šæ ¼å±€
  private getSpecialPattern(): string {
    const patterns: Array<string> = [];

    // æ£€æŸ¥äº•æœ¨çŠ´ç‰¹æ®Šèƒ½åŠ›
    const allStars = [
      this.wuQinResult?.diQin.star,
      this.wuQinResult?.tianQin.star,
      this.wuQinResult?.huoYao.star
    ];

    if (allStars.includes('äº•')) {
      const jingBranch = this.getStarBranch('äº•');
      if (jingBranch === 'æœª' || jingBranch === 'å¯…') {
        patterns.push('äº•æœ¨çŠ´å¸æƒï¼šä¸Šå±±é£Ÿè™è±¹ï¼Œä¸‹æ°´é£Ÿè›Ÿé¾™ï¼Œç ´ä¸‡å…µä¹‹åŠ›ï¼');
      }
    }

    // æ£€æŸ¥å¿ƒæœˆç‹å…‹é¸¡
    if (allStars.includes('å¿ƒ') && allStars.includes('æ˜‚')) {
      patterns.push('å¿ƒæœˆç‹å…‹é¸¡ï¼šé¸¡æ€•å¿ƒæœˆç‹é£Ÿï¼');
    }

    // æ£€æŸ¥å¯…å®«è™å¨
    if (allStars.includes('å°¾')) {
      const weiBranch = this.getStarBranch('å°¾');
      if (weiBranch === 'å¯…') {
        patterns.push('è™å±…å¯…å®«ï¼šèµ°å…½é¿ä¹‹ï¼Œå¸æƒä¹‹åœ°ï¼');
      }
    }

    // æ£€æŸ¥æœªä¸Šé¹°å¨
    if (allStars.includes('å¼ ')) {
      const zhangBranch = this.getStarBranch('å¼ ');
      if (zhangBranch === 'æœª') {
        patterns.push('æœªä¸Šè—é¹°ï¼šé£ç¦½ä¸è¿‡ï¼Œå¸æƒä¹‹åœ°ï¼');
      }
    }

    // æ£€æŸ¥ç‡•å…¥è¾°åé£Ÿè›Ÿé¾™
    if (allStars.includes('å±')) {
      const weiBranch = this.getStarBranch('å±');
      if (weiBranch === 'è¾°' && (allStars.includes('è§’') || allStars.includes('äº¢'))) {
        patterns.push('ç‡•å…¥è¾°åé£Ÿè›Ÿé¾™ï¼šå¼±èƒœå¼ºä¹‹è±¡ï¼');
      }
    }

    return patterns.join('ï¼›');
  }

  // è·å–æŸç¦½æ˜Ÿçš„è½å®«
  private getStarBranch(star: string): string {
    if (this.wuQinResult?.diQin.star === star && this.diQinSuoBo) {
      return this.diQinSuoBo.branch;
    }
    if (this.wuQinResult?.tianQin.star === star && this.tianQinSuoBo) {
      return this.tianQinSuoBo.branch;
    }
    if (this.wuQinResult?.huoYao.star === star && this.huoYaoSuoBo) {
      return this.huoYaoSuoBo.branch;
    }
    return '';
  }

  // è·å–æ˜¼å¤œè§„åˆ™åˆ¤æ–­
  private getDayNightRule(): string {
    const results: Array<string> = [];
    const currentHour = new Date().getHours();
    const isDaytime = currentHour >= 6 && currentHour < 18;
    const timeDesc = isDaytime ? 'å½“å‰ä¸ºæ˜¼é—´' : 'å½“å‰ä¸ºå¤œé—´';

    // æ—¥ç¦½ï¼šæ˜¼é£å¤œå®¿
    const dayBirds = ['æ˜‚', 'èƒƒ', 'å±', 'æ¯•', 'ç¿¼'];
    // å¤œç¦½ï¼šæ˜¼æ½œå¤œåŠ¨
    const nightBirds = ['è™š', 'å¥³', 'æ°', 'å¿ƒ'];

    const checkStar = (label: string, star: string) => {
      if (dayBirds.includes(star)) {
        if (isDaytime) {
          results.push(`${label}${star}ä¸ºæ—¥ç¦½ï¼Œ${timeDesc}ï¼Œå½“é£åŠ¨æ´»è·ƒ`);
        } else {
          results.push(`${label}${star}ä¸ºæ—¥ç¦½ï¼Œ${timeDesc}ï¼Œå½“æ½œè—ä¸åŠ¨`);
        }
      }
      if (nightBirds.includes(star)) {
        if (!isDaytime) {
          results.push(`${label}${star}ä¸ºå¤œç¦½ï¼Œ${timeDesc}ï¼Œå½“æ´»åŠ¨å‡ºæ²¡`);
        } else {
          results.push(`${label}${star}ä¸ºå¤œç¦½ï¼Œ${timeDesc}ï¼Œå½“éšä¼ä¸åŠ¨`);
        }
      }
    };

    if (this.wuQinResult) {
      checkStar('åœ°ç¦½', this.wuQinResult.diQin.star);
      checkStar('å¤©ç¦½', this.wuQinResult.tianQin.star);
      checkStar('æ´»æ›œ', this.wuQinResult.huoYao.star);
    }

    return results.length > 0 ? results.join('ï¼›') : `${timeDesc}ï¼Œç¦½æ˜Ÿæ— æ˜æ˜¾æ˜¼å¤œå±æ€§`;
  }

  // è·å–äºŒåå…«å®¿ç”¨äº‹ç ”ä¹ æç¤ºï¼ˆä»…æ—¥ç¦½ï¼‰
  private getDayStarEventHints(): Array<StarEventEvaluation> {
    const results: Array<StarEventEvaluation> = [];
    if (!this.wuQinResult) {
      return results;
    }
    const star: string = this.wuQinResult.dayStar.star;
    const events: Array<StarEventType> = ['åŸ‹è‘¬å®‰è‘¬', 'å«å¨¶çº³å¦¾', 'è¡Œå•†è´¸æ˜“', 'æ±‚åè€ƒè¯•'];
    events.forEach((eventName: StarEventType) => {
      const evalResult = getStarEventEvaluation(star, eventName);
      if (evalResult) {
        results.push(evalResult);
      }
    });
    return results;
  }

  private getStarEventLevelLabel(level: StarEventLevel): string {
    if (level === 'greatGood') {
      return 'å¤§å‰';
    }
    if (level === 'good') {
      return 'å¯ç”¨';
    }
    if (level === 'neutral') {
      return 'å¹³å¹³';
    }
    return 'ä¸å®œ';
  }

  // ============== æ˜Ÿå®¿ç‰©è±¡æ–¹æ³• ==============

  // æ˜Ÿå®¿ç‰©è±¡å±•ç¤ºç»„ä»¶
  @Builder
  StarImageryItem(label: string, star: string, color: string) {
    Column() {
      Row() {
        Text(label)
          .fontSize(11)
          .fontColor('#ffffff')
          .backgroundColor(color)
          .borderRadius(4)
          .padding({ left: 6, right: 6, top: 2, bottom: 2 })
        Text(`${star}å®¿`)
          .fontSize(12)
          .fontWeight(FontWeight.Medium)
          .fontColor(color)
          .margin({ left: 6 })
        Text(`â†’ ${this.getStarImagery(star).imagery}`)
          .fontSize(12)
          .fontColor('#333333')
          .margin({ left: 6 })
      }
      .width('100%')
      .margin({ bottom: 4 })

      Row() {
        Text(`æè´¨ï¼š${this.getStarImagery(star).material}`)
          .fontSize(11)
          .fontColor('#666666')
        Text(`ç±»ä¾‹ï¼š${this.getStarImagery(star).examples}`)
          .fontSize(11)
          .fontColor('#666666')
          .margin({ left: 12 })
      }
      .width('100%')
      .padding({ left: 60 })
    }
    .width('100%')
    .margin({ bottom: 10 })
  }

  // è·å–æ˜Ÿå®¿ç‰©è±¡
  private getStarImagery(star: string): StarImageryInfo {
    const imageryMap = new Map<string, StarImageryInfo>([
      ['è§’', { imagery: 'é›•åˆ»ç²¾å·§ä¹‹ç‰©', material: 'æœ¨è´¨ã€ç»¿è‰²', examples: 'æœ¨é›•ã€ç«¹å™¨ã€ç»¿è‰²å·¥è‰ºå“' }],
      ['äº¢', { imagery: 'é¦–é¥°ã€å°Šè´µç‰©', material: 'é‡‘å±ã€ç™½è‰²', examples: 'é‡‘é¥°ã€å°ç« ã€è´µé‡é¥°å“' }],
      ['æ°', { imagery: 'è±†éº¦ã€ç“¦çŸ³', material: 'åœŸè´¨ã€é»„è¤è‰²', examples: 'ä¸åœ†ä¸æ–¹ä¹‹ç‰©ã€è±†ç±»å®¹å™¨' }],
      ['æˆ¿', { imagery: 'å¥‘çº¦ã€æ–‡ä¹¦', material: 'çº¸è´¨ã€ç™½è‰²', examples: 'åˆåŒã€ä¹¦ä¿¡ã€å°åˆ·å“' }],
      ['å¿ƒ', { imagery: 'è¯—è¯æ­Œèµ‹', material: 'çº¸è´¨ã€çº¢è‰²', examples: 'æ–‡å­¦ä½œå“ã€æ­Œè°±ã€éŸ³ä¹ç±»' }],
      ['å°¾', { imagery: 'è¯—è¯æ­Œèµ‹', material: 'çº¸è´¨ã€çº¢è‰²', examples: 'æ–‡å­¦ä½œå“ã€å”±è¯ã€å°å·' }],
      ['ç®µ', { imagery: 'ç ´æŸè¡£ç‰©', material: 'å¸ƒè´¨ã€é»‘è‰²', examples: 'æ—§è¡£ã€ç ´å¸ƒã€çº¸å¸' }],
      ['æ–—', { imagery: 'é›•åˆ»ç²¾å·§ä¹‹ç‰©', material: 'æœ¨è´¨ã€ç»¿è‰²', examples: 'æœ¨å™¨ã€ç«¹åˆ¶å“' }],
      ['ç‰›', { imagery: 'é’±è´¢ã€é‡‘é“¶', material: 'é‡‘å±ã€ç™½è‰²', examples: 'é’±å¸ã€é‡‘é“¶å™¨çš¿ã€è´¢å®' }],
      ['å¥³', { imagery: 'è±†éº¦ã€ç“¦çŸ³', material: 'åœŸè´¨ã€é»„è‰²', examples: 'ä¸åœ†ä¸æ–¹ä¹‹ç‰©ã€çŸ³å™¨' }],
      ['è™š', { imagery: 'æ–‡ä¹¦ã€è¯è®¼', material: 'çº¸è´¨ã€ç™½è‰²', examples: 'å®˜æ–¹æ–‡ä¹¦ã€è¯‰çŠ¶ã€å¥‘çº¦' }],
      ['å±', { imagery: 'ç¾è‡³å¤§å‰', material: 'å¸ƒè´¨ã€é»‘è‰²', examples: 'ç¾è§‚ç‰©å“ã€ç¡¬å¸ã€å°ç« ' }],
      ['å®¤', { imagery: 'çŒªå½¢ç‰©å“', material: 'åœŸè´¨ã€é»‘è‰²', examples: 'çŒªå½¢å™¨çš¿ã€é™¶å™¨' }],
      ['å£', { imagery: 'æ–‡ä¹¦ã€å­—ç”»', material: 'çº¸è´¨ã€ç™½è‰²', examples: 'ä¹¦ç±ã€å­—ç”»ã€å£æŒ‚' }],
      ['å¥ˆ', { imagery: 'é›•åˆ»ç²¾å·§ä¹‹ç‰©', material: 'æœ¨è´¨ã€ç™½è‰²', examples: 'ç²¾ç¾å·¥è‰ºå“ã€ç‹¼å½¢å™¨ç‰©' }],
      ['å¨„', { imagery: 'ç‹—å½¢ç‰©å“', material: 'é‡‘å±ã€ç™½è‰²', examples: 'ç‹—å½¢å™¨çš¿ã€é‡‘å±å™¨å…·' }],
      ['èƒƒ', { imagery: 'è°·ç±³ã€ç“¦ç¼¸çŸ³å™¨', material: 'åœŸè´¨ã€é»„è‰²', examples: 'ç±³ç¼¸ã€çŸ³å™¨ã€é™¶ç½' }],
      ['æ˜‚', { imagery: 'é¸¡å½¢ç‰©å“', material: 'é‡‘å±ã€ç™½è‰²', examples: 'é¸¡å½¢å™¨çš¿ã€ç¾½æ¯›åˆ¶å“' }],
      ['æ¯•', { imagery: 'å­—ç”»ã€æœ±èµ¤å°å·', material: 'çº¸è´¨ã€çº¢è‰²', examples: 'å­—ç”»ã€å°ç« ã€æœ±ç ‚åˆ¶å“' }],
      ['è§œ', { imagery: 'å®ç‰', material: 'ç‰çŸ³ã€ç»¿è‰²', examples: 'ç‰å™¨ã€ç¿¡ç¿ ã€å®çŸ³' }],
      ['å‚', { imagery: 'ç»¸ç¼', material: 'ä¸ç»¸ã€ç™½è‰²', examples: 'ç»¸å¸ƒã€ç¼ç¼šã€ç²¾ç¾å¸ƒæ–™' }],
      ['äº•', { imagery: 'ç ´æ—§æœ¨å™¨', material: 'æœ¨è´¨ã€é»„è‰²', examples: 'äº•æ ã€æœ¨æ¡¶ã€ç ´æ—§æœ¨å™¨' }],
      ['é¬¼', { imagery: 'ç ´æŸé“œé“å™¨', material: 'é‡‘å±ã€é»‘è‰²', examples: 'ç ´æŸé“œå™¨ã€é“å™¨ã€æ—§é‡‘å±' }],
      ['æŸ³', { imagery: 'è°·ç±³ã€ç“¦ç¼¸çŸ³å™¨', material: 'åœŸè´¨ã€é»„è‰²', examples: 'ç±³ç¼¸ã€çŸ³å™¨ã€é™¶ç½' }],
      ['æ˜Ÿ', { imagery: 'éŸ³ä¹ä¹å™¨', material: 'æœ¨è´¨ã€çº¢è‰²', examples: 'ä¹å™¨ã€éŸ³ä¹ç›’ã€é©¬å½¢ç‰©å“' }],
      ['å¼ ', { imagery: 'å¥‘çº¦ã€æ–‡ä¹¦', material: 'çº¸è´¨ã€çº¢è‰²', examples: 'åˆåŒã€æ–‡ä¹¦ã€ç¾è§‚ä¹‹ç‰©' }],
      ['ç¿¼', { imagery: 'å®ç‰ã€æœ±èµ¤å°å·', material: 'ç‰çŸ³ã€çº¢è‰²', examples: 'çº¢è‰²å®çŸ³ã€å°ç« ã€è›‡å½¢ç‰©' }],
      ['è½¸', { imagery: 'ç ´æŸç ´è¡£ç‰©', material: 'å¸ƒè´¨ã€é»‘è‰²', examples: 'æ—§è¡£ã€ç ´å¸ƒã€è›“è›“å½¢ç‰©' }]
    ]);

    const result = imageryMap.get(star);
    if (result) {
      return result;
    }
    return { imagery: 'æ™®é€šç‰©å“', material: 'ä¸è¯¦', examples: 'æ— ç‰¹æ®Šè±¡ä¹‰' } as StarImageryInfo;
  }

  // ============== ä¸ƒæ›œä¸å®ä¹‰ä¸“æ—¥ç»„ä»¶ ==============

  @Builder
  QiYaoBaoYiZhuanCard() {
    Column() {
      Text('â”€â”€ æœ¬æ—¥å‰å‡¶æ€»æ–­ â”€â”€')
        .fontSize(12)
        .fontColor('#666666')
        .width('100%')
        .textAlign(TextAlign.Center)
        .margin({ bottom: 12 })

      Row() {
        // å·¦ä¾§ï¼šä¸ƒæ›œæ€»æ–­
        Column() {
          Row() {
            Text('ğŸŒŸ')
              .fontSize(14)
              .margin({ right: 4 })
            Text(this.dayQiYaoInfo!.name)
              .fontSize(13)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.dayQiYaoInfo!.color)
          }
          .margin({ bottom: 6 })

          Text('æ€§è´¨ï¼š' + this.dayQiYaoInfo!.nature)
            .fontSize(11)
            .fontColor('#666666')
            .width('100%')
            .margin({ bottom: 4 })

          if (this.dayQiYaoInfo!.suitableEvents.length > 0) {
            Text('âœ… ' + this.dayQiYaoInfo!.suitableEvents.join('ã€'))
              .fontSize(10)
              .fontColor('#4caf50')
              .width('100%')
              .margin({ bottom: 3 })
          }

          if (this.dayQiYaoInfo!.avoidEvents.length > 0) {
            Text('âŒ ' + this.dayQiYaoInfo!.avoidEvents.join('ã€'))
              .fontSize(10)
              .fontColor('#f44336')
              .width('100%')
          }
        }
        .layoutWeight(1)
        .padding(10)
        .backgroundColor('#f5f5f5')
        .borderRadius(8)

        // å³ä¾§ï¼šå®ä¹‰ä¸“æ—¥
        Column() {
          Row() {
            Text(this.dayLevelInfo!.dayLevelInfo.emoji)
              .fontSize(14)
              .margin({ right: 4 })
            Text(this.dayLevelInfo!.dayLevelInfo.name)
              .fontSize(13)
              .fontWeight(FontWeight.Bold)
              .fontColor(this.dayLevelInfo!.dayLevelInfo.color)
          }
          .margin({ bottom: 6 })

          Text(this.dayLevelInfo!.dayLevelInfo.description)
            .fontSize(11)
            .fontColor('#666666')
            .width('100%')
            .margin({ bottom: 4 })

          if (this.dayLevelInfo!.isChenFanJun) {
            Text('âš ï¸ è‡£çŠ¯å›å¤§å¿Œ')
              .fontSize(10)
              .fontColor('#f44336')
              .width('100%')
              .padding(4)
              .backgroundColor('#fff3e0')
              .borderRadius(4)
          }
        }
        .layoutWeight(1)
        .padding(10)
        .backgroundColor('#e3f2fd')
        .borderRadius(8)
        .margin({ left: 8 })
      }
      .width('100%')

      Text('ğŸ’¡ ' + this.dayLevelInfo!.recommendation)
        .fontSize(11)
        .fontColor('#2196f3')
        .width('100%')
        .lineHeight(16)
        .margin({ top: 10 })
    }
    .width('100%')
    .padding(14)
    .backgroundColor('#ffffff')
    .borderRadius(14)
    .margin({ left: 16, right: 16, bottom: 12 })
  }
}
