/**
 * å®ä¹‰ä¸“æ—¥å·¥å…·ç±»
 * å®ç°15.19è§„åˆ™ï¼šæ—¶é—´èƒ½é‡è¯„çº§ä½“ç³»
 */

export type DayLevel = 'bao' | 'yi' | 'zhuan' | 'zhi' | 'fa' | 'unknown';

export interface DayLevelInfo {
  level: DayLevel;
  name: string;
  quality: 'excellent' | 'good' | 'good' | 'neutral' | 'bad';
  description: string;
  suitableEvents: string[];
  color: string;
  emoji: string;
}

/**
 * äº”çº§æ—¥åˆ†ç±»é…ç½®
 */
const DAY_LEVEL_CONFIG: Record<DayLevel, DayLevelInfo> = {
  'bao': {
    level: 'bao',
    name: 'å®æ—¥',
    quality: 'excellent',
    description: 'å¦‚çå®ï¼Œç™¾äº‹çš†å®œ',
    suitableEvents: ['é€ è‘¬', 'å«å¨¶', 'ä¸Šå®˜', 'å¼€ä¸š', 'å‡ºè¡Œ'],
    color: '#4caf50',
    emoji: 'ğŸ’'
  },
  'yi': {
    level: 'yi',
    name: 'ä¹‰æ—¥',
    quality: 'good',
    description: 'ä¸»é“ä¹‰ã€åˆä½œ',
    suitableEvents: ['ç­¾çº¦', 'ç»“ç›Ÿ', 'æ±‚åŒ»', 'åˆä½œ'],
    color: '#2196f3',
    emoji: 'ğŸ¤'
  },
  'zhuan': {
    level: 'zhuan',
    name: 'ä¸“æ—¥',
    quality: 'good',
    description: 'ä¸“ä¸€æˆå°±ï¼Œäº‹æœ‰ä¸“åŠŸ',
    suitableEvents: ['å¼€ä¸š', 'åŠ¨åœŸ', 'æ±‚å', 'ä¸“é¡¹äº‹åŠ¡'],
    color: '#ff9800',
    emoji: 'ğŸ¯'
  },
  'zhi': {
    level: 'zhi',
    name: 'åˆ¶æ—¥',
    quality: 'neutral',
    description: 'å—åˆ¶çº¦ï¼Œéœ€è°¨æ…',
    suitableEvents: ['å°äº‹å¯ç”¨ï¼Œå¤§äº‹ä¸å®œ'],
    color: '#9e9e9e',
    emoji: 'âš ï¸'
  },
  'fa': {
    level: 'fa',
    name: 'ä¼æ—¥',
    quality: 'bad',
    description: 'ä¸»å¾ä¼ã€ç ´å',
    suitableEvents: [],
    color: '#f44336',
    emoji: 'âŒ'
  },
  'unknown': {
    level: 'unknown',
    name: 'æœªçŸ¥',
    quality: 'neutral',
    description: 'æ— ç‰¹æ®Šæ ‡è®°',
    suitableEvents: [],
    color: '#757575',
    emoji: 'â“'
  }
};

/**
 * å®ä¹‰ä¸“æ—¥æŸ¥è¯¢è¡¨ï¼ˆæŒ‰åœ°æ”¯ï¼‰
 * å®æ—¥ï¼šæˆŠå·±ï¼›ä¹‰æ—¥ï¼šä¸™ä¸ï¼›ä¸“æ—¥ï¼šå£¬ç™¸
 */
const BAO_YI_ZHUAN_BY_GAN: Record<string, DayLevel> = {
  'ç”²': 'unknown',
  'ä¹™': 'unknown',
  'ä¸™': 'yi',
  'ä¸': 'yi',
  'æˆŠ': 'bao',
  'å·±': 'bao',
  'åºš': 'unknown',
  'è¾›': 'unknown',
  'å£¬': 'zhuan',
  'ç™¸': 'zhuan'
};

/**
 * æ ¹æ®æ—¥å¹²åˆ¤æ–­å®ä¹‰ä¸“æ—¥
 */
export function getDayLevelByGan(dayGan: string): DayLevel {
  return BAO_YI_ZHUAN_BY_GAN[dayGan] || 'unknown';
}

/**
 * è·å–æ—¥çº§åˆ«å®Œæ•´ä¿¡æ¯
 */
export function getDayLevelInfo(level: DayLevel): DayLevelInfo {
  return DAY_LEVEL_CONFIG[level];
}

export interface ChenFanJunResult {
  isChenFanJun: boolean;
  description: string;
}

/**
 * åˆ¤æ–­æ˜¯å¦è‡£çŠ¯å›ï¼ˆæ—¥å¹²å…‹å²å¹²ï¼‰
 */
export function checkChenFanJun(dayGan: string, yearGan: string): ChenFanJunResult {
  const kezhiMap: Map<string, string[]> = new Map([
    ['ç”²', ['æˆŠ', 'å·±']],  // æœ¨å…‹åœŸ
    ['ä¹™', ['æˆŠ', 'å·±']],
    ['ä¸™', ['åºš', 'è¾›']],  // ç«å…‹é‡‘
    ['ä¸', ['åºš', 'è¾›']],
    ['æˆŠ', ['å£¬', 'ç™¸']],  // åœŸå…‹æ°´
    ['å·±', ['å£¬', 'ç™¸']],
    ['åºš', ['ç”²', 'ä¹™']],  // é‡‘å…‹æœ¨
    ['è¾›', ['ç”²', 'ä¹™']],
    ['å£¬', ['ä¸™', 'ä¸']],  // æ°´å…‹ç«
    ['ç™¸', ['ä¸™', 'ä¸']]
  ]);

  const beikeGan = kezhiMap.get(dayGan) || [];
  const isChenFanJun = beikeGan.includes(yearGan);

  const result: ChenFanJunResult = {
    isChenFanJun,
    description: isChenFanJun 
      ? `âš ï¸ æ—¥å¹²${dayGan}å…‹å²å¹²${yearGan}ï¼Œè‡£çŠ¯å›ï¼Œä¸»ä»¥ä¸‹çŠ¯ä¸Šã€æŸäººä¸ã€å®˜éç‰¢ç‹±` 
      : ''
  };
  return result;
}

export interface DayQualityEvaluation {
  dayLevel: DayLevel;
  dayLevelInfo: DayLevelInfo;
  isChenFanJun: boolean;
  chenFanJunDesc: string;
  finalQuality: 'excellent' | 'good' | 'neutral' | 'bad';
  recommendation: string;
}

/**
 * ç»¼åˆè¯„ä¼°å½“æ—¥å‰å‡¶ï¼ˆç»“åˆå®ä¹‰ä¸“æ—¥ã€è‡£çŠ¯å›ï¼‰
 */
export function evaluateDayQuality(dayGan: string, yearGan: string): DayQualityEvaluation {
  const dayLevel = getDayLevelByGan(dayGan);
  const dayLevelInfo = getDayLevelInfo(dayLevel);
  const chenFanJun = checkChenFanJun(dayGan, yearGan);

  // å¦‚æœè‡£çŠ¯å›ï¼Œé™çº§å¤„ç†
  let finalQuality = dayLevelInfo.quality;
  let recommendation = '';

  if (chenFanJun.isChenFanJun) {
    if (dayLevel === 'bao' || dayLevel === 'yi' || dayLevel === 'zhuan') {
      finalQuality = 'bad';
      recommendation = `è™½ä¸º${dayLevelInfo.name}ï¼Œä½†çŠ¯è‡£çŠ¯å›å¤§å¿Œï¼Œå‰ç¥è¢«åˆ¶ï¼Œåå‡¶ï¼å»ºè®®æ”¹æ—¥`;
    } else {
      finalQuality = 'bad';
      recommendation = `${dayLevelInfo.name}ä¸”çŠ¯è‡£çŠ¯å›ï¼Œæå‡¶ä¹‹æ—¥ï¼Œç™¾äº‹ä¸å®œ`;
    }
  } else {
    // æ— è‡£çŠ¯å›ï¼ŒæŒ‰åŸç­‰çº§
    if (dayLevel === 'bao') {
      recommendation = 'å®æ—¥å¤§å‰ï¼Œç™¾äº‹çš†å®œï¼Œå¯é…åˆæœˆå–„å®¿æˆ–æ—¥å–œå®¿ï¼Œå‰ä¸ŠåŠ å‰';
    } else if (dayLevel === 'yi') {
      recommendation = 'ä¹‰æ—¥å‰åˆ©ï¼Œä¸»é“ä¹‰åˆä½œï¼Œå®œç­¾çº¦ç»“ç›Ÿã€æ±‚åŒ»é—®è¯';
    } else if (dayLevel === 'zhuan') {
      recommendation = 'ä¸“æ—¥å‰åˆ©ï¼Œäº‹æœ‰ä¸“åŠŸï¼Œå®œå¼€ä¸šåŠ¨åœŸã€æ±‚åè€ƒè¯•';
    } else if (dayLevel === 'zhi') {
      recommendation = 'åˆ¶æ—¥å¹³å¹³ï¼Œå°äº‹å¯è¡Œï¼Œå¤§äº‹éœ€æ…é‡è€ƒè™‘';
    } else if (dayLevel === 'fa') {
      recommendation = 'ä¼æ—¥å¤§å‡¶ï¼Œä¸»å¾ä¼ç ´åï¼Œç™¾äº‹å¿Œç”¨ï¼Œå°¤å¿Œé€ è‘¬å«å¨¶';
    } else {
      recommendation = 'å¹³å¸¸æ—¥æœŸï¼Œå¯ç»“åˆç¦½æ˜Ÿä¸ƒæ›œåˆ¤æ–­';
    }
  }

  const result: DayQualityEvaluation = {
    dayLevel,
    dayLevelInfo,
    isChenFanJun: chenFanJun.isChenFanJun,
    chenFanJunDesc: chenFanJun.description,
    finalQuality,
    recommendation
  };
  return result;
}

export interface FutureBaoYiZhuanDay {
  date: string;
  dayGan: string;
  dayLevel: DayLevel;
  levelInfo: DayLevelInfo;
}

/**
 * è·å–æœªæ¥Nå¤©çš„å®ä¹‰ä¸“æ—¥åˆ—è¡¨ï¼ˆç”¨äºæ‹©æ—¥åŠ©æ‰‹ï¼‰
 */
export function getFutureBaoYiZhuanDays(
  startYear: number,
  startMonth: number,
  startDay: number,
  daysCount: number,
  targetLevel: DayLevel[]
): FutureBaoYiZhuanDay[] {
  // ç®€åŒ–å®ç°ï¼šéœ€è¦é…åˆä¸‡å¹´å†æ•°æ®
  // å®é™…ä½¿ç”¨æ—¶åº”è°ƒç”¨CalendarManagerè·å–çœŸå®å¹²æ”¯
  const result: FutureBaoYiZhuanDay[] = [];

  // æ­¤å¤„ä»…ç¤ºä¾‹ç»“æ„ï¼Œå®é™…éœ€è¦å¼‚æ­¥åŠ è½½ä¸‡å¹´å†æ•°æ®
  // æš‚æ—¶è¿”å›ç©ºæ•°ç»„ï¼Œå®é™…ä½¿ç”¨æ—¶åœ¨è°ƒç”¨å±‚å¤„ç†

  return result;
}

/**
 * å£è¯€è®°å¿†è¾…åŠ©
 */
export const BAO_YI_ZHUAN_FORMULA = 'æˆŠå·±ä¸ºå®ï¼Œä¸™ä¸ä¸ºä¹‰ï¼Œå£¬ç™¸ä¸ºä¸“';

/**
 * ä½¿ç”¨æŒ‡å—
 */
export const USAGE_GUIDE = `
å®ä¹‰ä¸“æ—¥ä½¿ç”¨æµç¨‹ï¼š
1. å…ˆæ’é™¤ä¼æ–­ã€ç©ºäº¡ã€ä¼æ—¥ç­‰å‡¶æ—¥
2. æ ¹æ®äº‹ä½“é€‰æ‹©é€‚é…ç¦½æ˜Ÿï¼ˆå‚è€ƒä¸ƒæ›œæ€»æ–­ï¼‰
3. åœ¨å‰æ—¥ä¸­ä¼˜é€‰å®ä¹‰ä¸“æ—¥
4. ç¡®è®¤ä¸çŠ¯è‡£çŠ¯å›ï¼ˆæ—¥å¹²ä¸å…‹å²å¹²ï¼‰
5. é…åˆæ—¶è¾°ç¦½æ˜Ÿï¼Œæœ€ç»ˆæ‹©å®šå‰æ—¶
`;
